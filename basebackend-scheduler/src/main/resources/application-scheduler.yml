# ===================================================================
# PowerJob调度器专用配置
# ===================================================================
# 本配置文件专门用于配置basebackend-scheduler模块的PowerJob集成
# 包括Worker配置、任务注册、监控、重试、幂等等功能
#
# 配置优先级(高到低):
# 1. 环境变量(如 ${POWERJOB_SERVER_1})
# 2. Nacos配置中心(如果启用@RefreshScope)
# 3. 本配置文件中的默认值
#
# 使用说明:
# - 复制此文件为 application.yml 或 application-dev.yml
# - 根据环境调整配置值
# - 生产环境必须配置多Server地址实现高可用
# ===================================================================

# ===================================================================
# Spring Boot 通用配置
# ===================================================================
spring:
  # 应用名称
  application:
    name: basebackend-scheduler

  # 日志配置
  logging:
    level:
      # PowerJob相关日志级别
      tech.powerjob: INFO
      com.basebackend.scheduler: DEBUG

    # 日志格式
    pattern:
      console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{50} - %msg%n"
      file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{50} - %msg%n"

  # 线程池配置
  task:
    execution:
      pool:
        core-size: 10      # 核心线程数
        max-size: 20       # 最大线程数
        queue-capacity: 100 # 队列容量
        keep-alive: 60     # 线程保活时间(秒)
    scheduling:
      pool:
        size: 20           # 调度线程池大小
      thread-name-prefix: scheduler-task-

  # ===================================================================
  # 数据库配置(用于存储任务执行记录、指标等)
  # ===================================================================
  datasource:
    # 主数据源(用于应用业务数据)
    primary:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: ${MYSQL_URL:jdbc:mysql://192.168.66.126:3306/basebackend_scheduler?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=Asia/Shanghai}
      username: ${MYSQL_USERNAME:basebackend_scheduler}
      password: ${MYSQL_PASSWORD:wk5KknQxrFcD64ZS}
      hikari:
        minimum-idle: 5
        maximum-pool-size: 20
        idle-timeout: 300000
        max-lifetime: 900000
        connection-timeout: 30000
        pool-name: HikariCP-Primary

    # PowerJob专用数据源(用于存储任务执行记录)
    powerjob:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://192.168.66.126:3306/powerjob-product?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true
      username: powerjob-product
      password: 5kGYaE3adhQKzjRC
      hikari:
        minimum-idle: 5
        maximum-pool-size: 10
        idle-timeout: 300000
        max-lifetime: 900000
        connection-timeout: 30000
        pool-name: HikariCP-PowerJob


# ===================================================================
# Server端口配置
# ===================================================================
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: /

# ===================================================================
# PowerJob Worker核心配置
# ===================================================================
scheduler:
  powerjob:
    # 启用/禁用PowerJob
    # 开发环境: true(便于测试和调试)
    # 生产环境: true(生产环境需要分布式调度)
    enabled: ${POWERJOB_ENABLED:true}

    # 应用名称
    # 必须与PowerJob服务端注册的应用名一致
    app-name: ${POWERJOB_APP_NAME:basebackend-scheduler}

    # 服务端地址列表(支持多个实现高可用)
    # 格式: host1:port1,host2:port2 或使用数组格式
    server-address:
      - ${POWERJOB_SERVER_1:192.168.66.126:7700}
    # 或者使用逗号分隔的字符串格式:
    # server-address: ${POWERJOB_SERVER_ADDRESS:localhost:7700}

    # 认证Token
    # 生产环境建议使用Jasypt加密: ENC(加密后的token)
    token: ${POWERJOB_TOKEN:default-token}

    # Worker线程池配置
    # 根据CPU核心数和任务类型调整
    worker-core-pool-size: ${POWERJOB_CORE_POOL_SIZE:8}
    worker-max-pool-size: ${POWERJOB_MAX_POOL_SIZE:16}

    # 心跳间隔(毫秒)
    # 建议5-10秒，局域网环境可以设置得更短
    heartbeat-interval-millis: ${POWERJOB_HEARTBEAT_INTERVAL:5000}

    # 任务执行超时时间(秒)
    # 0表示不限制超时
    max-task-execution-timeout-seconds: ${POWERJOB_TASK_TIMEOUT:0}

    # 数据存储策略
    # DISK: 磁盘存储(默认，适合大数据量)
    # MEMORY: 内存存储(适合小数据量，速度快)
    store-strategy: ${POWERJOB_STORE_STRATEGY:DISK}

    # 工作目录
    # 用于存储任务日志、临时文件等
    worker-store-path: ${POWERJOB_WORKER_STORE_PATH:./powerjob-worker}

    # 标签
    # 用于标识Worker节点，可用于任务路由
    tag: ${POWERJOB_TAG:default}

  # 任务注册与管理配置
  job:
    # 自动注册开关
    # 启用后应用启动时会自动扫描并注册任务处理器
    auto-register: ${JOB_AUTO_REGISTER:true}

    # 任务处理器扫描包路径
    # 支持多个包路径，用逗号分隔
    scan-packages:
      - ${JOB_SCAN_PACKAGE_1:com.basebackend.scheduler.processor}
      - ${JOB_SCAN_PACKAGE_2:com.basebackend.database.processor}
      - ${JOB_SCAN_PACKAGE_3:com.basebackend.cache.processor}

    # 处理器Bean名称后缀
    # 扫描时会将Bean名称和此后缀拼接作为任务名称
    processor-bean-name-suffix: ${JOB_PROCESSOR_SUFFIX:Processor}

    # 排除的包路径(Ant风格路径匹配)
    # 排除测试类和不希望注册的类
    exclude-packages:
      - ${JOB_EXCLUDE_PACKAGE_1:**/test/**}
      - ${JOB_EXCLUDE_PACKAGE_2:**/*Test.java}
      - ${JOB_EXCLUDE_PACKAGE_3:**/*Tests.java}

    # 任务生命周期管理
    lifecycle:
      enabled: ${JOB_LIFECYCLE_ENABLED:true}
      shutdown-timeout-seconds: ${JOB_SHUTDOWN_TIMEOUT:30}
      shutdown-check-interval-seconds: ${JOB_SHUTDOWN_CHECK_INTERVAL:1}

    # 任务执行指标收集
    metrics:
      enabled: ${JOB_METRICS_ENABLED:true}
      interval-seconds: ${JOB_METRICS_INTERVAL:60}
      retention-days: ${JOB_METRICS_RETENTION:30}

    # 任务重试配置
    retry:
      default-times: ${JOB_RETRY_TIMES:3}
      interval-seconds: ${JOB_RETRY_INTERVAL:60}
      max-interval-seconds: ${JOB_MAX_RETRY_INTERVAL:3600}
      exponential-backoff: ${JOB_EXPONENTIAL_BACKOFF:false}

    # 幂等性保障配置
    idempotency:
      enabled: ${JOB_IDEMPOTENCY_ENABLED:true}
      ttl-minutes: ${JOB_IDEMPOTENCY_TTL:1440}
      key-prefix: ${JOB_IDEMPOTENCY_KEY_PREFIX:powerjob}
      timeout-seconds: ${JOB_IDEMPOTENCY_TIMEOUT:5}

    # 日志配置
    logging:
      detailed-logging: ${JOB_DETAILED_LOGGING:false}
      console-logging: ${JOB_CONSOLE_LOGGING:false}
      retention-days: ${JOB_LOG_RETENTION:7}


# ===================================================================
# Camunda配置(与PowerJob并存)
# ===================================================================
camunda:
  bpm:
    # Camunda Web应用配置
    webapp:
      application-path: /camunda

    # 任务执行器配置
    task-execution:
      # 使用独立线程池(避免与PowerJob线程池冲突)
      core-threads: 10
      max-threads: 20
      queue-capacity: 100

    # 历史配置
    history:
      # 保留历史数据的时间
      retention-time: ${CAMUNDA_HISTORY_RETENTION:P30D}

# ===================================================================
# 自定义配置(业务相关)
# ===================================================================
basebackend:
  # 系统标识
  system:
    id: ${SYSTEM_ID:basebackend}
    version: ${SYSTEM_VERSION:1.0.0}

  # 任务调度相关配置
  scheduler:
    # 最大并发任务数
    max-concurrent-jobs: ${SCHEDULER_MAX_CONCURRENT_JOBS:100}

    # 任务执行超时时间(秒)
    task-timeout: ${SCHEDULER_TASK_TIMEOUT:300}

    # 任务重试配置
    retry:
      max-attempts: ${SCHEDULER_RETRY_MAX_ATTEMPTS:3}
      initial-interval: ${SCHEDULER_RETRY_INITIAL_INTERVAL:1000}
      multiplier: ${SCHEDULER_RETRY_MULTIPLIER:2}
      max-interval: ${SCHEDULER_RETRY_MAX_INTERVAL:30000}

# ===================================================================
# 环境特定配置示例
# ===================================================================

# 开发环境覆盖配置
# spring:
#   profiles:
#     group: dev

# 测试环境覆盖配置
# ---
# spring:
#   config:
#     activate:
#       on-profile: test
#   datasource:
#     url: jdbc:h2:mem:testdb
#     driver-class-name: org.h2.Driver
#     username: sa
#     password:

# 生产环境覆盖配置
# ---
# spring:
#   config:
#     activate:
#       on-profile: production
#   logging:
#     level:
#       root: WARN
#       tech.powerjob: WARN
# management:
#   endpoints:
#     web:
#       exposure:
#         include: health,info,metrics
# scheduler:
#   powerjob:
#     server-address:
#       - 192.168.1.100:7700
#       - 192.168.1.101:7700
#     token: ENC(加密后的token)
#     worker-core-pool-size: 16
#     worker-max-pool-size: 32
