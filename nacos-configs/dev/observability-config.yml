# ================================================================================================
# 可观测性配置 (Observability Config)
# ================================================================================================
#
# 包含内容：
# - Actuator 健康检查和监控端点
# - Micrometer Metrics 指标配置
# - Prometheus 集成配置
# - 日志链路追踪配置
#
# ================================================================================================

# 日志配置（增强版 - 包含 TraceId/SpanId）
logging:
  pattern:
    # 控制台日志格式：包含 TraceId 和 SpanId
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{traceId:-},%X{spanId:-}] %-5level %logger{50} - %msg%n"
    # 文件日志格式：包含 TraceId 和 SpanId
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{traceId:-},%X{spanId:-}] %-5level %logger{50} - %msg%n"

# Actuator 配置
management:
  endpoints:
    web:
      exposure:
        # 暴露的端点：健康检查、信息、指标、Prometheus、Nacos配置和服务发现
        include: health,info,metrics,prometheus,refresh,nacos-config,nacos-discovery
      base-path: /actuator
  endpoint:
    health:
      show-details: always  # 总是显示健康检查详情
      show-components: always
    metrics:
      enabled: true
    prometheus:
      enabled: true

  # 健康检查配置
  health:
    # 数据库健康检查
    db:
      enabled: true
    # Redis 健康检查
    redis:
      enabled: true
    # 磁盘空间健康检查
    diskspace:
      enabled: true
      threshold: 10GB  # 磁盘空间阈值
    # 邮件服务健康检查（如果启用）
    mail:
      enabled: false
    # 自定义健康检查端点
    defaults:
      enabled: true
    # 显示详细信息的条件
    show-details: always  # always, when-authorized, never
    show-components: always
    # 健康检查组配置
    group:
      # 存活探针（Liveness Probe）- Kubernetes 使用
      liveness:
        include: ping
        show-details: never
      # 就绪探针（Readiness Probe）- Kubernetes 使用
      readiness:
        include: db,redis,diskSpace,application
        show-details: when-authorized

  # Metrics 配置
  metrics:
    export:
      prometheus:
        enabled: true
        step: 1m  # 采样间隔
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active:dev}
      region: ${REGION:cn-east}
      instance: ${HOSTNAME:${spring.application.name}}
    distribution:
      percentiles-histogram:
        http.server.requests: true
        "[api_response_time_seconds]": true
        "[business_order_processing_time_seconds]": true
      slo:
        http.server.requests: 10ms,50ms,100ms,200ms,500ms,1s,2s,5s,10s
    # 启用更详细的 JVM 指标
    enable:
      jvm: true
      process: true
      system: true
      tomcat: true
      logback: true
      hikaricp: true

  # 跟踪配置
  tracing:
    sampling:
      probability: 1.0  # 采样率：1.0 = 100%（开发环境）
    propagation:
      type: b3  # 使用 B3 传播格式（Zipkin 标准）
    brave:
      span-joining-supported: true  # 支持 Span 合并

# 可观测性扩展配置
observability:
  # Tempo/Zipkin 追踪后端配置
  tempo:
    enabled: ${TEMPO_ENABLED:false}  # 默认禁用，需要时通过环境变量启用
    endpoint: ${TEMPO_ENDPOINT:http://localhost:9411/api/v2/spans}

  # 自定义 Metrics 配置
  metrics:
    enabled: true
    custom-tags:
      enabled: true
