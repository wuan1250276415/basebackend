<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basebackend.backup.domain.mapper.BackupHistoryMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.basebackend.backup.domain.entity.BackupHistory">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="task_id" property="taskId" jdbcType="BIGINT"/>
        <result column="task_name" property="taskName" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="backup_type" property="backupType" jdbcType="VARCHAR"/>
        <result column="base_full_id" property="baseFullId" jdbcType="BIGINT"/>
        <result column="binlog_start" property="binlogStart" jdbcType="VARCHAR"/>
        <result column="binlog_end" property="binlogEnd" jdbcType="VARCHAR"/>
        <result column="wal_start" property="walStart" jdbcType="VARCHAR"/>
        <result column="wal_end" property="walEnd" jdbcType="VARCHAR"/>
        <result column="file_size" property="fileSize" jdbcType="BIGINT"/>
        <result column="storage_locations" property="storageLocations" jdbcType="VARCHAR"/>
        <result column="checksum_md5" property="checksumMd5" jdbcType="VARCHAR"/>
        <result column="checksum_sha256" property="checksumSha256" jdbcType="VARCHAR"/>
        <result column="started_at" property="startedAt" jdbcType="TIMESTAMP"/>
        <result column="finished_at" property="finishedAt" jdbcType="TIMESTAMP"/>
        <result column="duration_seconds" property="durationSeconds" jdbcType="INTEGER"/>
        <result column="error_message" property="errorMessage" jdbcType="VARCHAR"/>
        <result column="started_at_ms" property="startedAtMs" jdbcType="BIGINT"/>
        <result column="finished_at_ms" property="finishedAtMs" jdbcType="BIGINT"/>
    </resultMap>

    <!-- 通用字段 -->
    <sql id="Base_Column_List">
        id, task_id, task_name, status, backup_type, base_full_id,
        binlog_start, binlog_end, wal_start, wal_end, file_size,
        storage_locations, checksum_md5, checksum_sha256,
        started_at, finished_at, duration_seconds, error_message,
        started_at_ms, finished_at_ms
    </sql>

    <!-- 查询任务的历史记录（分页） -->
    <select id="selectByTaskIdPage" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM backup_history
        WHERE task_id = #{taskId}
        ORDER BY started_at DESC
    </select>

    <!-- 查询最近的备份记录 -->
    <select id="selectRecentByTaskId" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM backup_history
        WHERE task_id = #{taskId}
        ORDER BY started_at DESC
        LIMIT #{limit}
    </select>

    <!-- 查询成功的备份记录 -->
    <select id="selectSuccessByTaskId" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM backup_history
        WHERE task_id = #{taskId}
        AND status = 'SUCCESS'
        ORDER BY started_at DESC
    </select>

    <!-- 查询指定时间范围内的备份记录 -->
    <select id="selectByTimeRange" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM backup_history
        WHERE task_id = #{taskId}
        AND started_at >= #{startTime}
        AND #{endTime} > started_at
        ORDER BY started_at ASC
    </select>

    <!-- 查询最近的增量备份（用于PITR） -->
    <select id="selectLatestIncrementalByBaseFullId" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM backup_history
        WHERE base_full_id = #{baseFullId}
        AND status = 'SUCCESS'
        AND backup_type = 'incremental'
        ORDER BY started_at DESC
        LIMIT 1
    </select>

    <!-- 查询增量链 -->
    <select id="selectIncrementalChain" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM backup_history
        WHERE base_full_id = #{baseFullId}
        AND status = 'SUCCESS'
        AND backup_type = 'incremental'
        ORDER BY started_at ASC
    </select>

    <!-- 统计指定时间范围内的备份情况 -->
    <select id="countByTimeRangeAndStatus" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM backup_history
        WHERE task_id = #{taskId}
        AND started_at >= #{startTime}
        AND #{endTime} > started_at
        AND status = #{status}
    </select>

    <!-- 查询最新的全量备份 -->
    <select id="selectLatestFullBackup" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM backup_history
        WHERE task_id = #{taskId}
        AND status = 'SUCCESS'
        AND backup_type = 'full'
        ORDER BY started_at DESC
        LIMIT 1
    </select>

</mapper>
