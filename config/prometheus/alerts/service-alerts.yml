# ============================================================================
# Prometheus 告警规则 - 服务告警
# ============================================================================

groups:
  - name: service_alerts
    interval: 30s
    rules:
      # 服务下线告警
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "服务 {{ $labels.job }} 已下线"
          description: "服务 {{ $labels.job }} ({{ $labels.instance }}) 已下线超过1分钟"

      # 高错误率告警
      - alert: HighErrorRate
        expr: |
          rate(http_server_requests_seconds_count{status=~"5.."}[5m]) 
          / 
          rate(http_server_requests_seconds_count[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          category: reliability
        annotations:
          summary: "服务 {{ $labels.job }} 错误率过高"
          description: "服务 {{ $labels.job }} 的5xx错误率超过5%，当前值: {{ $value | humanizePercentage }}"

      # 高响应时间告警
      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(http_server_requests_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "服务 {{ $labels.job }} 响应时间过长"
          description: "服务 {{ $labels.job }} 的P95响应时间超过1秒，当前值: {{ $value }}s"

      # 高CPU使用率告警
      - alert: HighCPUUsage
        expr: process_cpu_usage > 0.8
        for: 5m
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "服务 {{ $labels.job }} CPU使用率过高"
          description: "服务 {{ $labels.job }} 的CPU使用率超过80%，当前值: {{ $value | humanizePercentage }}"

      # 高内存使用率告警
      - alert: HighMemoryUsage
        expr: |
          jvm_memory_used_bytes{area="heap"} 
          / 
          jvm_memory_max_bytes{area="heap"} > 0.9
        for: 5m
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "服务 {{ $labels.job }} 内存使用率过高"
          description: "服务 {{ $labels.job }} 的堆内存使用率超过90%，当前值: {{ $value | humanizePercentage }}"

      # GC时间过长告警
      - alert: HighGCTime
        expr: |
          rate(jvm_gc_pause_seconds_sum[5m]) 
          / 
          rate(jvm_gc_pause_seconds_count[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "服务 {{ $labels.job }} GC时间过长"
          description: "服务 {{ $labels.job }} 的平均GC时间超过100ms，当前值: {{ $value }}s"

      # 数据库连接池耗尽告警
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          hikaricp_connections_active 
          / 
          hikaricp_connections_max > 0.9
        for: 2m
        labels:
          severity: critical
          category: resource
        annotations:
          summary: "服务 {{ $labels.job }} 数据库连接池即将耗尽"
          description: "服务 {{ $labels.job }} 的数据库连接池使用率超过90%，当前值: {{ $value | humanizePercentage }}"

      # Redis连接失败告警
      - alert: RedisConnectionFailure
        expr: |
          rate(lettuce_command_completion_seconds_count{command="connect",status="failed"}[5m]) > 0
        for: 2m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "服务 {{ $labels.job }} Redis连接失败"
          description: "服务 {{ $labels.job }} 的Redis连接出现失败"

      # 熔断器打开告警
      - alert: CircuitBreakerOpen
        expr: |
          resilience4j_circuitbreaker_state{state="open"} == 1
        for: 1m
        labels:
          severity: warning
          category: reliability
        annotations:
          summary: "服务 {{ $labels.job }} 熔断器已打开"
          description: "服务 {{ $labels.job }} 的熔断器 {{ $labels.name }} 已打开"
