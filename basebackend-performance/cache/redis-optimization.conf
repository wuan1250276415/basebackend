# =====================================================================
# Redis 性能优化配置
# 创建时间: 2025-11-15
# 描述: Redis 缓存优化配置以提升微服务性能
# =====================================================================

# ============================================
# 内存配置
# ============================================
# 设置最大内存 (根据实际情况调整)
maxmemory 2gb

# 内存淘汰策略
# allkeys-lru: 移除最近最少使用的key
# allkeys-lfu: 移除最不经常使用的key
# volatile-ttl: 移除即将过期的key
maxmemory-policy allkeys-lru

# ============================================
# 持久化配置
# ============================================
# RDB 快照配置
save 900 1
save 300 10
save 60 10000

# RDB 文件配置
dbfilename dump.rdb
dir /data/redis

# AOF 配置
appendonly yes
appendfilename "appendonly.aof"

# AOF 同步策略
# always: 每次写入都同步 (性能最差，安全性最高)
# everysec: 每秒同步 (性能中等，安全性中等)
# no: 不主动同步 (性能最好，安全性最差)
appendfsync everysec

# AOF 重写配置
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ============================================
# 网络优化
# ============================================
# TCP backlog
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

# 客户端超时
timeout 0
tcp-delay yes

# ============================================
# 客户端连接
# ============================================
# 最大客户端连接数
maxclients 10000

# ============================================
# AOF 和 RDB 优化
# ============================================
# 禁用 Rdb 文件压缩 (减少 CPU 使用)
rdbcompression yes
rdbchecksum yes

# AOF 文件同步优化
no-appendfsync-on-rewrite yes
aof-load-truncated yes
aof-use-rdb-preamble yes

# ============================================
# 慢查询配置
# ============================================
# 慢查询阈值 (微秒)
slowlog-log-slower-than 10000

# 慢查询日志长度
slowlog-max-len 128

# ============================================
# 延迟监控
# ============================================
# 延迟监控阈值 (毫秒)
latency-monitor-threshold 100

# ============================================
# 安全配置
# ============================================
# 设置密码 (生产环境必配)
# requirepass yourpassword

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""

# ============================================
# 性能调优
# ============================================
# 禁用 THP (Transparent Huge Pages)
# echo never > /sys/kernel/mm/transparent_hugepage/enabled

# 优化内核参数
# echo never > /proc/sys/vm/swappiness

# ============================================
# 内存优化
# ============================================
# 内存预分配
# hash-max-ziplist-entries 512
# hash-max-ziplist-value 64
# list-max-ziplist-size -2
# list-compress-depth 0
# set-max-intset-entries 512
# zset-max-ziplist-entries 128
# zset-max-ziplist-value 64

# ============================================
# 监控配置
# ============================================
# 开启所有监控指标
# INFO 命令会返回所有指标
# STATS 命令返回基本统计

# ============================================
# 集群配置 (可选)
# ============================================
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 5000
# cluster-announce-ip 127.0.0.1
# cluster-announce-port 7000
# cluster-announce-bus-port 17000

# ============================================
# 客户端输出缓冲区
# ============================================
# 普通客户端
client-output-buffer-limit normal 0 0 0

# 主从复制客户端
client-output-buffer-limit replica 256mb 64mb 60

# 发布订阅客户端
client-output-buffer-limit pubsub 32mb 8mb 60

# ============================================
# 内存碎片优化
# ============================================
# 内存分配器
# jemalloc (默认，推荐)
# glibc
# tcmalloc

# 主动释放内存碎片
# MEMORY PURGE 命令

# ============================================
# Redis 6.0+ 特性
# ============================================
# 多线程 I/O
# io-threads 4
# io-threads-do-reads yes

# 客户端缓存
# client-query-buffer-limit 1gb
# proto-max-bulk-len 512mb

# ============================================
# Lua 脚本优化
# ============================================
# Lua 脚本超时时间 (毫秒)
lua-time-limit 5000

# ============================================
# 监控和告警
# ============================================
# 使用 RedisINFO 命令定期收集指标
# Keyspace 使用情况
# 内存使用情况
# 慢查询数量
# 连接数
# 命中率
