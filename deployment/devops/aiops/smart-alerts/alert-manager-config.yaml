# AIé©±åŠ¨çš„æ™ºèƒ½å‘Šè­¦ç®¡ç†å™¨é…ç½®
# å®ç°å‘Šè­¦èšåˆã€é™å™ªã€å…³è”åˆ†æå’Œè‡ªåŠ¨å“åº”

global:
  # å…¨å±€é…ç½®
  resolve_timeout: 10m
  http_config:
    proxy_url: 'http://proxy.company.com:8080'

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'service', 'cluster', 'namespace']
  group_wait: 30s  # å‘Šè­¦åˆ†ç»„ç­‰å¾…æ—¶é—´
  group_interval: 5m  # å‘Šè­¦ç»„é—´éš”
  repeat_interval: 12h  # å‘Šè­¦é‡å¤é—´éš”
  receiver: 'default'
  routes:
    # é«˜ä¼˜å…ˆçº§å‘Šè­¦ - ç«‹å³å¤„ç†
    - matchers:
        - severity="critical"
        - priority="high"
      receiver: 'critical-alerts'
      group_wait: 10s
      group_interval: 1m

    # FinOps æˆæœ¬å‘Šè­¦
    - matchers:
        - team="finops"
      receiver: 'finops-alerts'
      group_wait: 1m
      routes:
        - matchers:
            - severity="critical"
          receiver: 'finops-critical'

    # å¹³å°å‘Šè­¦
    - matchers:
        - team="platform"
      receiver: 'platform-alerts'
      group_wait: 30s

    # å®‰å…¨å‘Šè­¦
    - matchers:
        - category="security"
      receiver: 'security-alerts'
      group_wait: 15s

    # ä¸šåŠ¡å‘Šè­¦
    - matchers:
        - category="business"
      receiver: 'business-alerts'
      group_wait: 1m

# æ¥æ”¶å™¨é…ç½®
receivers:
  - name: 'default'
    slack_configs:
      - channel: '#alerts-general'
        title: '{{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # å…³é”®å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    slack_configs:
      - channel: '#alerts-critical'
        title: 'ğŸš¨ CRITICAL ALERT'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        color: 'danger'
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_INTEGRATION_KEY}'
        description: '{{ .GroupLabels.alertname }}'
        severity: 'critical'
    email_configs:
      - to: 'ops-team@company.com'
        subject: 'CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          {{ end }}

  # FinOpså‘Šè­¦æ¥æ”¶å™¨
  - name: 'finops-alerts'
    slack_configs:
      - channel: '#finops-alerts'
        title: 'ğŸ’° FinOps Alert'
        text: |
          {{ range .Alerts }}
          *Cost Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          *Estimated Impact:* {{ .Annotations.estimated_impact }}
          {{ end }}

  # å¹³å°å‘Šè­¦æ¥æ”¶å™¨
  - name: 'platform-alerts'
    slack_configs:
      - channel: '#platform-alerts'
        title: 'âš™ï¸ Platform Alert'
        text: |
          {{ range .Alerts }}
          *Platform Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Node:* {{ .Labels.instance }}
          {{ end }}

  # å®‰å…¨å‘Šè­¦æ¥æ”¶å™¨
  - name: 'security-alerts'
    slack_configs:
      - channel: '#security-alerts'
        title: 'ğŸ”’ Security Alert'
        text: |
          {{ range .Alerts }}
          *Security Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Source:* {{ .Labels.source_ip }}
          {{ end }}
        color: 'warning'
    email_configs:
      - to: 'security-team@company.com'
        subject: 'SECURITY: {{ .GroupLabels.alertname }}'

# æŠ‘åˆ¶è§„åˆ™ - æ™ºèƒ½å‘Šè­¦é™å™ª
inhibit_rules:
  # æŠ‘åˆ¶åŸå› ï¼šå¦‚æœæœåŠ¡ä¸å¯ç”¨ï¼Œåˆ™æŠ‘åˆ¶æ‰€æœ‰ç›¸å…³çš„è¯¦ç»†å‘Šè­¦
  - source_matchers:
      - alertname="ServiceDown"
    target_matchers:
      - alertname=~"HighLatency|HighErrorRate|HighResourceUsage"
    equal: ['service', 'namespace']

  # æŠ‘åˆ¶åŸå› ï¼šå¦‚æœæ•´ä¸ªèŠ‚ç‚¹å®•æœºï¼Œåˆ™æŠ‘åˆ¶è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰æœåŠ¡çš„å‘Šè­¦
  - source_matchers:
      - alertname="NodeDown"
    target_matchers:
      - alertname=~"PodDown|PodRestarting|HighCpuUsage|HighMemoryUsage"
    equal: ['instance']

  # æŠ‘åˆ¶åŸå› ï¼šå¦‚æœæ•°æ®åº“ä¸å¯ç”¨ï¼Œåˆ™æŠ‘åˆ¶æ‰€æœ‰æ•°æ®åº“ç›¸å…³å‘Šè­¦
  - source_matchers:
      - alertname="DatabaseDown"
    target_matchers:
      - alertname=~"DatabaseConnectionHigh|SlowQueries|ReplicationLag"
    equal: ['database']

  # æŠ‘åˆ¶åŸå› ï¼šå¦‚æœé›†ç¾¤ä¸å¯ç”¨ï¼Œåˆ™æŠ‘åˆ¶æ‰€æœ‰å•æœåŠ¡å‘Šè­¦
  - source_matchers:
      - alertname="ClusterDown"
    target_matchers:
      - alertname!="ClusterDown"
    equal: ['cluster']

# æ™ºèƒ½å‘Šè­¦èšåˆé…ç½®
alert_relabel_configs:
  # æ·»åŠ æ™ºèƒ½æ ‡ç­¾
  - source_labels: ['alertname', 'severity']
    target_label: 'priority'
    # æ ¹æ®å‘Šè­¦åç§°å’Œä¸¥é‡æ€§è®¡ç®—ä¼˜å…ˆçº§
    regex: '(.*Critical.*|.*Down.*),(critical)'
    replacement: 'high'

  - source_labels: ['alertname']
    target_label: 'category'
    regex: '(Auth|Login|Token)'
    replacement: 'security'

  - source_labels: ['alertname']
    target_label: 'category'
    regex: '(Cost|Budget|Resource)'
    replacement: 'finops'

  - source_labels: ['alertname']
    target_label: 'category'
    regex: '(CPU|Memory|Disk|Network)'
    replacement: 'platform'

  - source_labels: ['alertname']
    target_label: 'category'
    regex: '(Business|User|Order)'
    replacement: 'business'

  # æ·»åŠ è‡ªåŠ¨ä¿®å¤æ ‡ç­¾
  - source_labels: ['alertname', 'severity']
    target_label: 'auto_fixable'
    regex: '(PodRestarting),warning'
    replacement: 'true'

  # æ·»åŠ ä¸¥é‡çº§åˆ«æ˜ å°„
  - source_labels: ['severity']
    target_label: 'escalation_level'
    regex: 'critical'
    replacement: 'immediate'

  - source_labels: ['severity']
    target_label: 'escalation_level'
    regex: 'warning'
    replacement: '1_hour'

  - source_labels: ['severity']
    target_label: 'escalation_level'
    regex: 'info'
    replacement: 'next_business_day'

# é™é»˜è§„åˆ™ - æ™ºèƒ½é™é»˜
time_intervals:
  - name: 'maintenance_window'
    time_intervals:
      - times:
          - start_time: '02:00'
            end_time: '04:00'
        weekdays: ['saturday']
        location: 'UTC'

  - name: 'business_hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'UTC'

  - name: 'non_business_hours'
    time_intervals:
      - times:
          - start_time: '18:00'
            end_time: '09:00'
        weekdays: ['monday:friday']
        location: 'UTC'

# æ™ºèƒ½å‘Šè­¦å…³è”è§„åˆ™
alert_correlation_rules:
  # æ•°æ®åº“å‘Šè­¦å…³è”
  - alert_pattern: 'Database.*'
    correlation_window: 5m
    linked_alerts:
      - pattern: 'Service.*Error'
        correlation_score: 0.9
        description: 'Database issues likely causing service errors'

  # ç½‘ç»œå‘Šè­¦å…³è”
  - alert_pattern: 'Network.*'
    correlation_window: 2m
    linked_alerts:
      - pattern: 'HighLatency'
        correlation_score: 0.8
        description: 'Network issues causing latency spikes'

  # èµ„æºå‘Šè­¦å…³è”
  - alert_pattern: 'High(CPU|Memory).*'
    correlation_window: 1m
    linked_alerts:
      - pattern: 'HighLatency'
        correlation_score: 0.7
        description: 'Resource exhaustion causing performance degradation'

# æ™ºèƒ½å“åº”è§„åˆ™
auto_response_rules:
  # Podé‡å¯å‘Šè­¦ - å°è¯•è‡ªåŠ¨é‡å¯
  - alert_name: 'PodRestarting'
    action: 'restart_pod'
    conditions:
      - severity: 'warning'
      - occurrence_count: 3
      - time_window: '5m'
    cooldown: '10m'

  # é«˜CPUä½¿ç”¨ç‡ - å°è¯•HPAæ‰©å®¹
  - alert_name: 'HighCPUUsage'
    action: 'scale_up'
    conditions:
      - severity: 'warning'
      - cpu_usage: '>80%'
      - duration: '5m'
    cooldown: '5m'

  # é«˜å†…å­˜ä½¿ç”¨ç‡ - å°è¯•æ‰©å®¹
  - alert_name: 'HighMemoryUsage'
    action: 'scale_up'
    conditions:
      - severity: 'warning'
      - memory_usage: '>85%'
      - duration: '5m'
    cooldown: '5m'

  # æ•°æ®åº“è¿æ¥é«˜ - å°è¯•å¢åŠ è¿æ¥æ± 
  - alert_name: 'DatabaseConnectionsHigh'
    action: 'scale_up_db'
    conditions:
      - severity: 'warning'
      - connection_usage: '>80%'
      - duration: '3m'
    cooldown: '10m'

# å‘Šè­¦è·¯ç”±æ ‘ä¼˜åŒ–
route_templates:
  critical_alert:
    title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
    description: |
      Service: {{ .GroupLabels.service }}
      Severity: {{ .GroupLabels.severity }}
      Count: {{ .GroupLabels.alert_count }}
      Time: {{ .CommonAnnotations.timestamp }}

  warning_alert:
    title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
    description: |
      Service: {{ .GroupLabels.service }}
      Description: {{ .CommonAnnotations.description }}

  info_alert:
    title: 'â„¹ï¸ INFO: {{ .GroupLabels.alertname }}'
    description: |
      {{ .CommonAnnotations.description }}

# å‘Šè­¦é™å™ªç®—æ³•é…ç½®
noise_reduction:
  # å‘Šè­¦é£æš´æ£€æµ‹
  storm_detection:
    threshold: 10  # 10ä¸ªå‘Šè­¦/åˆ†é’Ÿ
    window: '5m'
    action: 'aggregate_and_deduplicate'

  # å‘Šè­¦åˆå¹¶
  alert_aggregation:
    time_window: '5m'
    max_alerts: 50
    group_by: ['service', 'alertname']

  # å‘Šè­¦å»é‡
  alert_deduplication:
    similarity_threshold: 0.8
    message_similarity: true
    label_similarity: true

# æ™ºèƒ½å‡çº§è§„åˆ™
escalation_rules:
  # å¦‚æœå‘Šè­¦åœ¨5åˆ†é’Ÿå†…æœªè§£å†³ï¼Œè‡ªåŠ¨å‡çº§
  - condition: 'not_resolved'
    time_threshold: '5m'
    escalation_to: 'on_call_manager'

  # å¦‚æœå‘Šè­¦ä¸¥é‡æ€§ä¸ºcriticalä¸”å½±å“å¤šä¸ªæœåŠ¡ï¼Œå‡çº§åˆ°CTO
  - condition: 'multiple_services_affected'
    severity: 'critical'
    escalation_to: 'cto'

  # é‡å¤å‘Šè­¦3æ¬¡åå‡çº§
  - condition: 'repeated_alerts'
    count: 3
    time_window: '1h'
    escalation_to: 'team_lead'
