# Jaeger All-in-One 部署配置
# 包含 Jaeger Collector、Query、UI 和存储组件

apiVersion: v1
kind: Namespace
metadata:
  name: observability
---
# ConfigMap for Jaeger Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-configuration
  namespace: observability
data:
  jaeger.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268
          thrift_compact:
            endpoint: 0.0.0.0:6831/udp
          thrift_binary:
            endpoint: 0.0.0.0:6832/udp

    processors:
      batch:
        timeout: 1s
        send_batch_size: 8192
      memory_limiter:
        limit_mib: 512

    exporters:
      jaeger:
        endpoint: jaeger-collector:14250
        tls:
          insecure: true

      elasticsearch:
        endpoints: [http://elasticsearch:9200]
        index: jaeger-span
        mapping:
          template_file: /etc/jaeger/index-template.json

    service:
      extensions: [health_check]
      pipelines:
        traces:
          receivers: [otlp, jaeger]
          processors: [memory_limiter, batch]
          exporters: [jaeger, elasticsearch]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [jaeger]
---
# Jaeger Collector Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger-collector
  namespace: observability
  labels:
    app: jaeger-collector
spec:
  replicas: 2
  selector:
    matchLabels:
      app: jaeger-collector
  template:
    metadata:
      labels:
        app: jaeger-collector
    spec:
      containers:
      - name: jaeger-collector
        image: jaegertracing/jaeger-collector:1.56.0
        ports:
        - containerPort: 14250
          name: grpc
        - containerPort: 14268
          name: thrift-http
        - containerPort: 9411
          name: zipkin
        - containerPort: 13133
          name: health
        env:
        - name: SPAN_STORAGE_TYPE
          value: elasticsearch
        - name: ES_SERVER_URLS
          value: http://elasticsearch:9200
        - name: ES_INDEX_PREFIX
          value: jaeger
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 500m
        livenessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 5
          periodSeconds: 5
---
# Jaeger Collector Service
apiVersion: v1
kind: Service
metadata:
  name: jaeger-collector
  namespace: observability
  labels:
    app: jaeger-collector
spec:
  type: ClusterIP
  ports:
  - name: grpc
    port: 14250
    targetPort: 14250
  - name: thrift-http
    port: 14268
    targetPort: 14268
  - name: zipkin
    port: 9411
    targetPort: 9411
  - name: health
    port: 13133
    targetPort: 13133
  selector:
    app: jaeger-collector
---
# Jaeger All-in-One Pod (Agent + Query + UI)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger-all-in-one
  namespace: observability
  labels:
    app: jaeger-all-in-one
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger-all-in-one
  template:
    metadata:
      labels:
        app: jaeger-all-in-one
    spec:
      containers:
      - name: jaeger-agent
        image: jaegertracing/jaeger-agent:1.56.0
        ports:
        - containerPort: 6831
          name: thrift-compact
        - containerPort: 6832
          name: thrift-binary
        - containerPort: 5775
          name: zipkin-compact
        - containerPort: 5778
          name: config-rest
        env:
        - name: REPORTER_GRPC_HOST_PORT
          value: jaeger-collector:14250
        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 100m

      - name: jaeger-query
        image: jaegertracing/jaeger-query:1.56.0
        ports:
        - containerPort: 16686
          name: http-query
        - containerPort: 16687
          name: grpc-query
        - containerPort: 13133
          name: health
        env:
        - name: SPAN_STORAGE_TYPE
          value: elasticsearch
        - name: ES_SERVER_URLS
          value: http://elasticsearch:9200
        - name: ES_INDEX_PREFIX
          value: jaeger
        - name: QUERY_BASE_PATH
          value: /jaeger
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 300m
        livenessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 5
          periodSeconds: 5

      - name: jaeger-ui
        image: jaegertracing/jaeger-query:1.56.0
        args:
        - --query.base-path=/jaeger
        - --query.static-files=/usr/share/jaeger/ui/dist
        ports:
        - containerPort: 8080
          name: http-ui
---
# Jaeger All-in-One Service
apiVersion: v1
kind: Service
metadata:
  name: jaeger-query
  namespace: observability
  labels:
    app: jaeger-query
spec:
  type: LoadBalancer
  ports:
  - name: http-query
    port: 80
    targetPort: 16686
    path: /jaeger
  - name: grpc-query
    port: 16687
    targetPort: 16687
  - name: http-ui
    port: 8080
    targetPort: 8080
  selector:
    app: jaeger-all-in-one
---
# Elasticsearch for Jaeger Storage
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  namespace: observability
  labels:
    app: elasticsearch
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 9200
    targetPort: 9200
  - name: transport
    port: 9300
    targetPort: 9300
  selector:
    app: elasticsearch

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  namespace: observability
  labels:
    app: elasticsearch
spec:
  serviceName: elasticsearch
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        ports:
        - containerPort: 9200
          name: http
        - containerPort: 9300
          name: transport
        env:
        - name: discovery.type
          value: single-node
        - name: ES_JAVA_OPTS
          value: -Xms512m -Xmx512m
        - name: xpack.security.enabled
          value: "false"
        resources:
          requests:
            memory: 1Gi
            cpu: 200m
          limits:
            memory: 2Gi
            cpu: 1000m
        volumeMounts:
        - name: data
          mountPath: /usr/share/elasticsearch/data
      volumes:
      - name: data
        emptyDir: {}
