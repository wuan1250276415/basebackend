apiVersion: v1
kind: Namespace
metadata:
  name: mysql
  labels:
    name: mysql

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: mysql
data:
  custom.cnf: |
    [mysqld]
    # 基础配置
    port = 3306
    bind-address = 0.0.0.0
    character-set-server = utf8mb4
    collation-server = utf8mb4_unicode_ci

    # 性能配置
    innodb_buffer_pool_size = 1G
    innodb_log_file_size = 256M
    innodb_log_buffer_size = 16M
    innodb_flush_log_at_trx_commit = 2
    innodb_flush_method = O_DIRECT
    innodb_file_per_table = 1
    innodb_read_io_threads = 4
    innodb_write_io_threads = 4

    # 连接配置
    max_connections = 500
    max_connect_errors = 1000000
    connect_timeout = 60
    wait_timeout = 28800
    interactive_timeout = 28800

    # 查询缓存
    query_cache_type = 1
    query_cache_size = 64M
    query_cache_limit = 2M

    # 二进制日志
    log_bin = mysql-bin
    binlog_format = ROW
    expire_logs_days = 7
    max_binlog_size = 100M

    # 慢查询日志
    slow_query_log = 1
    long_query_time = 2
    slow_query_log_file = /var/lib/mysql/mysql-slow.log

    # 安全配置
    sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

---
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secrets
  namespace: mysql
type: Opaque
data:
  # 生产环境请使用真实的加密值
  mysql-root-password: YWRtaW4xMjM=  # admin123
  mysql-password: YWRtaW4xMjM=  # admin123

---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: mysql-storage
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  encrypted: "true"
  iops: "3000"
  throughput: "125"
  zone: us-west-2a
allowVolumeExpansion: true
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: mysql
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: mysql-storage
  resources:
    requests:
      storage: 100Gi

---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: mysql
  labels:
    app: mysql
spec:
  type: ClusterIP
  ports:
  - port: 3306
    targetPort: 3306
    name: mysql
  selector:
    app: mysql

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: mysql
  labels:
    app: mysql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      serviceAccountName: mysql
      securityContext:
        fsGroup: 999
      initContainers:
      - name: init-mysql
        image: mysql:8.0
        command:
          - bash
          - "-c"
          - |
            set -e

            echo "Checking if data directory exists..."
            if [ ! -d "/var/lib/mysql/mysql" ]; then
              echo "Data directory does not exist, initializing database..."
              mysql_install_db --user=mysql --datadir=/var/lib/mysql
              echo "Database initialized"
            else
              echo "Data directory exists, skipping initialization"
            fi

            echo "Setting correct permissions..."
            chown -R mysql:mysql /var/lib/mysql
        securityContext:
          runAsUser: 999
          runAsGroup: 999
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
          name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secrets
              key: mysql-root-password
        - name: MYSQL_DATABASE
          value: "basebackend"
        - name: MYSQL_USER
          value: "admin"
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secrets
              key: mysql-password
        - name: TZ
          value: "Asia/Shanghai"
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
        resources:
          requests:
            memory: 2Gi
            cpu: 500m
          limits:
            memory: 4Gi
            cpu: 1000m
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 2
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
      - name: mysql-config
        configMap:
          name: mysql-config

---
# MySQL服务账号
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mysql
  namespace: mysql

---
# MySQL备份
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
  namespace: mysql
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: mysql-backup
          containers:
          - name: backup
            image: mysql:8.0
            command:
            - /bin/bash
            - -c
            - |
              set -e

              echo "Starting MySQL backup..."

              # 创建备份目录
              mkdir -p /backup/$(date +%Y%m%d_%H%M%S)

              # 备份数据库
              mysqldump -h mysql -u root -p${MYSQL_ROOT_PASSWORD} \
                --single-transaction \
                --routines \
                --triggers \
                --events \
                --all-databases > /backup/$(date +%Y%m%d_%H%M%S)/full_backup.sql

              echo "Backup completed"

              # 清理7天前的备份
              find /backup -type d -mtime +7 -exec rm -rf {} +
            env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secrets
                  key: mysql-root-password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
            resources:
              requests:
                memory: 256Mi
                cpu: 100m
              limits:
                memory: 512Mi
                cpu: 500m
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: mysql-backup-pvc
          restartPolicy: OnFailure

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-backup-pvc
  namespace: mysql
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: mysql-storage
  resources:
    requests:
      storage: 50Gi
