# Phase 11.3: XXL-Job åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å®æ–½æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

XXL-Job æ˜¯ç”±å¤§ä¼—ç‚¹è¯„å¼€æºçš„è½»é‡çº§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶ï¼Œæœ¬æŒ‡å—ä»‹ç»å¦‚ä½•éƒ¨ç½²å’Œä½¿ç”¨ XXL-Job å®ç°åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç®¡ç†ã€‚

---

## ğŸ—ï¸ XXL-Job æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    XXL-Job åˆ†å¸ƒå¼è°ƒåº¦æ¶æ„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  è°ƒåº¦ä¸­å¿ƒ    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚  æ‰§è¡Œå™¨é›†ç¾¤  â”‚                      â”‚
â”‚  â”‚(XXL-Job)    â”‚         â”‚(JobHandler) â”‚                      â”‚
â”‚  â”‚ ç«¯å£: 8080  â”‚         â”‚ å¤šä¸ªå®ä¾‹     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                        â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   MySQL     â”‚         â”‚   å¾®æœåŠ¡     â”‚                      â”‚
â”‚  â”‚  ä»»åŠ¡æ³¨å†Œ    â”‚         â”‚   ä¸šåŠ¡é€»è¾‘   â”‚                      â”‚
â”‚  â”‚  ä»»åŠ¡æ‰§è¡Œ    â”‚         â”‚   ä»»åŠ¡æ‰§è¡Œ   â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                        â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   Redis     â”‚         â”‚  æ³¨å†Œä¸­å¿ƒ    â”‚                      â”‚
â”‚  â”‚  å¤±è´¥é‡è¯•    â”‚         â”‚ (Nacos)     â”‚                      â”‚
â”‚  â”‚  å­ä»»åŠ¡     â”‚         â”‚             â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ä»»åŠ¡è·¯ç”±æ¨¡å¼                             â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ RPC è°ƒç”¨æ¨¡å¼ (æ¨è) - é€šè¿‡ XXL-RPC è°ƒç”¨ JobHandler        â”‚ â”‚
â”‚  â”‚ â€¢ GLUE æ¨¡å¼ - åœ¨è°ƒåº¦ä¸­å¿ƒç»´æŠ¤ Java/Shell/Python ä»£ç         â”‚ â”‚
â”‚  â”‚ â€¢ BEAN æ¨¡å¼ (æ¨è) - åœ¨å¾®æœåŠ¡ä¸­ç¼–å†™ JobHandler            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | è¯´æ˜ | ç«¯å£ |
|------|------|------|
| **è°ƒåº¦ä¸­å¿ƒ** | è´Ÿè´£ä»»åŠ¡è°ƒåº¦ã€ç›‘æ§ã€ç®¡ç† | 8080 |
| **æ‰§è¡Œå™¨** | è´Ÿè´£ä»»åŠ¡æ‰§è¡Œï¼Œå¯åœ¨å¾®æœåŠ¡ä¸­é›†æˆ | 8081+ |
| **ä»»åŠ¡å¤„ç†å™¨** | å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å®ç° | - |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸‹è½½ XXL-Job

```bash
# ä¸‹è½½æºç 
git clone https://github.com/xuxueli/xxl-job.git

# æˆ–ä¸‹è½½å‘è¡Œç‰ˆ
wget https://github.com/xuxueli/xxl-job/releases/download/2.4.0/xxl-job-2.4.0.tar.gz
tar -xzf xxl-job-2.4.0.tar.gz
```

### 2. éƒ¨ç½²è°ƒåº¦ä¸­å¿ƒ

ä½¿ç”¨ Docker Compose å¿«é€Ÿéƒ¨ç½²ï¼š

```yaml
# docker-compose-xxljob.yml
version: '3.8'

services:
  xxl-job-server:
    image: xuxueli/xxl-job-admin:2.4.0
    container_name: xxl-job-server
    ports:
      - "8080:8080"
    environment:
      - PARAMS=--spring.datasource.username=root
      - PARAMS=--spring.datasource.password=123456
      - PARAMS=--spring.datasource.url=jdbc:mysql://mysql-xxljob:3306/xxl_job?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
    volumes:
      - ./xxljob-logs:/data/applogs/xxl-job
    depends_on:
      - mysql-xxljob
    networks:
      - xxljob-network

  mysql-xxljob:
    image: mysql:8.0
    container_name: mysql-xxljob
    ports:
      - "3308:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: xxl_job
    volumes:
      - ./xxljob-db:/docker-entrypoint-initdb.d
    networks:
      - xxljob-network

  xxl-job-executor:
    image: xxl-job-executor-sample-springboot:2.4.0
    container_name: xxl-job-executor
    ports:
      - "8081:8081"
    environment:
      - PARAMS=--xxl.job.admin.addresses=http://xxl-job-server:8080/xxl-job-admin
      - PARAMS=--xxl.job.executor.appname=basebackend-executor
      - PARAMS=--xxl.job.executor.port=8081
    networks:
      - xxljob-network

networks:
  xxljob-network:
    driver: bridge
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose-xxljob.yml up -d

# æŸ¥çœ‹æ—¥å¿—
docker logs -f xxl-job-server

# è®¿é—®æ§åˆ¶å°
# http://localhost:8080/xxl-job-admin
# ç”¨æˆ·å: admin
# å¯†ç : 123456
```

---

## ğŸ“¦ å¾®æœåŠ¡é›†æˆ XXL-Job

### 1. æ·»åŠ ä¾èµ–

åœ¨å¾®æœåŠ¡çš„ `pom.xml` ä¸­æ·»åŠ ï¼š

```xml
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
    <version>2.4.0</version>
</dependency>
```

### 2. é…ç½® application.yml

```yaml
xxl:
  job:
    # è°ƒåº¦ä¸­å¿ƒé…ç½®
    admin:
      addresses: http://localhost:8080/xxl-job-admin

    # æ‰§è¡Œå™¨é…ç½®
    executor:
      appname: basebackend-user-executor
      port: 8081
      logpath: /data/applogs/xxl-job
      logretentiondays: 30

    # è®¿é—®ä»¤ç‰Œ
    accessToken: basebackend_xxl_job_token_2024

    # ä»»åŠ¡æ‰§è¡Œå™¨é…ç½®
    triggerpool:
      fast:
        max: 200
      slow:
        max: 100

    # ä»»åŠ¡é…ç½®
    job:
      # å¤±è´¥é‡è¯•æ¬¡æ•°
      failover: 2
      # è¶…æ—¶æ—¶é—´ (åˆ†é’Ÿ)
      timeout: 30
      # å¹¶å‘æ•°é‡
      concurrency: 3
```

### 3. åˆ›å»ºé…ç½®ç±»

```java
@Configuration
public class XxlJobConfig {

    @Value("${xxl.job.admin.addresses}")
    private String adminAddresses;

    @Value("${xxl.job.accessToken}")
    private String accessToken;

    @Value("${xxl.job.executor.appname}")
    private String appname;

    @Value("${xxl.job.executor.port}")
    private int port;

    @Value("${xxl.job.executor.logpath}")
    private String logPath;

    @Value("${xxl.job.executor.logretentiondays}")
    private int logRetentionDays;

    @Bean
    public XxlJobSpringExecutor xxlJobExecutor() {
        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();
        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);
        xxlJobSpringExecutor.setAppname(appname);
        xxlJobSpringExecutor.setPort(port);
        xxlJobSpringExecutor.setAccessToken(accessToken);
        xxlJobSpringExecutor.setLogPath(logPath);
        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);
        return xxlJobSpringExecutor;
    }
}
```

---

## ğŸ“ ä»»åŠ¡å¤„ç†å™¨å¼€å‘

### 1. Bean æ¨¡å¼ï¼ˆæ¨èï¼‰

åœ¨å¾®æœåŠ¡ä¸­ç›´æ¥ç¼–å†™ä»»åŠ¡å¤„ç†å™¨ï¼š

```java
@Component
public class UserDataSyncJob {

    private static final Logger log = LoggerFactory.getLogger(UserDataSyncJob.class);

    /**
     * 1. ç®€å•ä»»åŠ¡ç¤ºä¾‹ï¼ˆBeanæ¨¡å¼ï¼‰
     */
    @XxlJob("syncUserData")
    public void syncUserData() throws Exception {
        log.info("å¼€å§‹æ‰§è¡Œç”¨æˆ·æ•°æ®åŒæ­¥ä»»åŠ¡");

        // 1. è®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();

        try {
            // 2. æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
            syncUserDataFromExternal();

            // 3. è®°å½•ä»»åŠ¡å®Œæˆ
            log.info("ç”¨æˆ·æ•°æ®åŒæ­¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶: {}ms", System.currentTimeMillis() - startTime);

            // 4. è¿”å›æˆåŠŸ
            XxlJobHelper.handleSuccess("ç”¨æˆ·æ•°æ®åŒæ­¥å®Œæˆ");

        } catch (Exception e) {
            log.error("ç”¨æˆ·æ•°æ®åŒæ­¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
            // è¿”å›å¤±è´¥ï¼Œè§¦å‘é‡è¯•
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    /**
     * 2. å‘¨æœŸæ€§ä»»åŠ¡ç¤ºä¾‹ï¼ˆæ”¯æŒcronè¡¨è¾¾å¼ï¼‰
     */
    @XxlJob("periodicDataCleanup")
    public void periodicDataCleanup() throws Exception {
        log.info("å¼€å§‹æ‰§è¡Œå‘¨æœŸæ€§æ•°æ®æ¸…ç†ä»»åŠ¡");

        try {
            // æ¸…ç†è¿‡æœŸæ•°æ®
            cleanupExpiredData();

            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            cleanupTempFiles();

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStatistics();

            XxlJobHelper.handleSuccess("æ•°æ®æ¸…ç†å®Œæˆ");

        } catch (Exception e) {
            log.error("æ•°æ®æ¸…ç†ä»»åŠ¡å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    /**
     * 3. åˆ†ç‰‡ä»»åŠ¡ç¤ºä¾‹ï¼ˆåˆ†å¸ƒå¼å¤„ç†ï¼‰
     */
    @XxlJob("shardingDataProcess")
    public void shardingDataProcess() throws Exception {
        // è·å–åˆ†ç‰‡å‚æ•°
        int shardIndex = XxlJobHelper.getShardIndex();
        int shardTotal = XxlJobHelper.getShardTotal();

        log.info("åˆ†ç‰‡ä»»åŠ¡æ‰§è¡Œ: åˆ†ç‰‡ç´¢å¼•={}/{}", shardIndex, shardTotal);

        try {
            // æ ¹æ®åˆ†ç‰‡å‚æ•°å¤„ç†å¯¹åº”çš„æ•°æ®
            processDataByShard(shardIndex, shardTotal);

            XxlJobHelper.handleSuccess("åˆ†ç‰‡ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ");

        } catch (Exception e) {
            log.error("åˆ†ç‰‡ä»»åŠ¡å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    /**
     * 4. å­ä»»åŠ¡ç¤ºä¾‹ï¼ˆä»»åŠ¡ä¾èµ–ï¼‰
     */
    @XxlJob("mainDataProcess")
    public void mainDataProcess() throws Exception {
        log.info("å¼€å§‹æ‰§è¡Œä¸»ä»»åŠ¡");

        try {
            // ä¸»ä»»åŠ¡é€»è¾‘
            processMainData();

            // è§¦å‘å­ä»»åŠ¡
            XxlJobHelper.triggerSubJob("subDataProcess1", "param1");
            XxlJobHelper.triggerSubJob("subDataProcess2", "param2");
            XxlJobHelper.triggerSubJob("subDataProcess3", "param3");

            XxlJobHelper.handleSuccess("ä¸»ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå­ä»»åŠ¡å·²è§¦å‘");

        } catch (Exception e) {
            log.error("ä¸»ä»»åŠ¡å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    /**
     * 5. å¹¿æ’­ä»»åŠ¡ç¤ºä¾‹ï¼ˆæ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼‰
     */
    @XxlJob("broadcastConfigRefresh")
    public void broadcastConfigRefresh() throws Exception {
        log.info("æ‰§è¡Œé…ç½®åˆ·æ–°ä»»åŠ¡");

        try {
            // åˆ·æ–°é…ç½®
            refreshConfiguration();

            // æ¸…ç†ç¼“å­˜
            clearCache();

            // é‡æ–°åˆå§‹åŒ–è¿æ¥
            reinitializeConnections();

            XxlJobHelper.handleSuccess("é…ç½®åˆ·æ–°å®Œæˆ");

        } catch (Exception e) {
            log.error("é…ç½®åˆ·æ–°å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    // ========================================
    // ä¸šåŠ¡é€»è¾‘æ–¹æ³•
    // ========================================

    private void syncUserDataFromExternal() throws InterruptedException {
        log.info("æ­£åœ¨åŒæ­¥ç”¨æˆ·æ•°æ®...");

        // æ¨¡æ‹Ÿæ•°æ®åŒæ­¥
        for (int i = 0; i < 100; i++) {
            Thread.sleep(10);
            log.debug("åŒæ­¥è¿›åº¦: {}/100", i + 1);
        }

        log.info("ç”¨æˆ·æ•°æ®åŒæ­¥å®Œæˆ");
    }

    private void cleanupExpiredData() throws InterruptedException {
        log.info("æ¸…ç†è¿‡æœŸæ•°æ®...");

        // æ¨¡æ‹Ÿæ¸…ç†æ“ä½œ
        for (int i = 0; i < 50; i++) {
            Thread.sleep(10);
        }

        log.info("è¿‡æœŸæ•°æ®æ¸…ç†å®Œæˆ");
    }

    private void cleanupTempFiles() {
        log.info("æ¸…ç†ä¸´æ—¶æ–‡ä»¶...");
        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶é€»è¾‘
        log.info("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ");
    }

    private void updateStatistics() {
        log.info("æ›´æ–°ç»Ÿè®¡ä¿¡æ¯...");
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯é€»è¾‘
        log.info("ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ");
    }

    private void processDataByShard(int shardIndex, int shardTotal) throws InterruptedException {
        log.info("æ ¹æ®åˆ†ç‰‡å¤„ç†æ•°æ®: shardIndex={}, shardTotal={}", shardIndex, shardTotal);

        // æ¨¡æ‹Ÿåˆ†ç‰‡å¤„ç†
        for (int i = shardIndex; i < 1000; i += shardTotal) {
            Thread.sleep(5);
            log.debug("å¤„ç†æ•°æ®: {}", i);
        }

        log.info("åˆ†ç‰‡æ•°æ®å¤„ç†å®Œæˆ");
    }

    private void processMainData() throws InterruptedException {
        log.info("æ‰§è¡Œä¸»ä»»åŠ¡é€»è¾‘...");

        // æ¨¡æ‹Ÿä¸»ä»»åŠ¡æ‰§è¡Œ
        for (int i = 0; i < 50; i++) {
            Thread.sleep(20);
        }

        log.info("ä¸»ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
    }

    private void refreshConfiguration() {
        log.info("åˆ·æ–°é…ç½®...");
        // é…ç½®åˆ·æ–°é€»è¾‘
        log.info("é…ç½®åˆ·æ–°å®Œæˆ");
    }

    private void clearCache() {
        log.info("æ¸…ç†ç¼“å­˜...");
        // ç¼“å­˜æ¸…ç†é€»è¾‘
        log.info("ç¼“å­˜æ¸…ç†å®Œæˆ");
    }

    private void reinitializeConnections() {
        log.info("é‡æ–°åˆå§‹åŒ–è¿æ¥...");
        // è¿æ¥é‡åˆå§‹åŒ–é€»è¾‘
        log.info("è¿æ¥é‡æ–°åˆå§‹åŒ–å®Œæˆ");
    }
}
```

### 2. ä»»åŠ¡æ³¨è§£è¯´æ˜

```java
/**
 * @XxlJob æ³¨è§£å±æ€§è¯´æ˜
 *
 * value: ä»»åŠ¡åç§°
 * init: ä»»åŠ¡åˆå§‹åŒ–æ–¹æ³•ï¼ˆå¯é€‰ï¼‰
 * destroy: ä»»åŠ¡é”€æ¯æ–¹æ³•ï¼ˆå¯é€‰ï¼‰
 * jobMethod: ä»»åŠ¡æ‰§è¡Œæ–¹æ³•åï¼ˆå¯é€‰ï¼‰
 */
@XxlJob(value = "syncUserData", init = "initJob", destroy = "destroyJob")
public void syncUserData() {
    // ä»»åŠ¡é€»è¾‘
}

public void initJob() {
    // ä»»åŠ¡åˆå§‹åŒ–æ—¶æ‰§è¡Œ
    log.info("ä»»åŠ¡åˆå§‹åŒ–");
}

public void destroyJob() {
    // ä»»åŠ¡é”€æ¯æ—¶æ‰§è¡Œ
    log.info("ä»»åŠ¡é”€æ¯");
}
```

---

## ğŸ“Š ä¸šåŠ¡ä»»åŠ¡è¿ç§»

### 1. æ•°æ®ç»Ÿè®¡ä»»åŠ¡

```java
@Component
public class StatisticsJob {

    /**
     * æ¯æ—¥æ•°æ®ç»Ÿè®¡ä»»åŠ¡
     */
    @XxlJob("dailyStatisticsJob")
    public void dailyStatistics() {
        log.info("å¼€å§‹æ‰§è¡Œæ¯æ—¥æ•°æ®ç»Ÿè®¡");

        try {
            // ç»Ÿè®¡ç”¨æˆ·æ•°æ®
            statUserStatistics();
            // ç»Ÿè®¡è®¢å•æ•°æ®
            statOrderStatistics();
            // ç»Ÿè®¡ç³»ç»ŸæŒ‡æ ‡
            statSystemMetrics();

            XxlJobHelper.handleSuccess("æ¯æ—¥ç»Ÿè®¡å®Œæˆ");
        } catch (Exception e) {
            log.error("æ¯æ—¥ç»Ÿè®¡å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    /**
     * æ¯å‘¨æ•°æ®æ±‡æ€»ä»»åŠ¡
     */
    @XxlJob("weeklySummaryJob")
    public void weeklySummary() {
        log.info("å¼€å§‹æ‰§è¡Œæ¯å‘¨æ•°æ®æ±‡æ€»");

        try {
            // æ±‡æ€»å‘¨æŠ¥æ•°æ®
            generateWeeklyReport();
            // æ¸…ç†å†å²æ•°æ®
            cleanupHistoricalData();
            // æ›´æ–°è¶‹åŠ¿åˆ†æ
            updateTrendAnalysis();

            XxlJobHelper.handleSuccess("æ¯å‘¨æ±‡æ€»å®Œæˆ");
        } catch (Exception e) {
            log.error("æ¯å‘¨æ±‡æ€»å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    private void statUserStatistics() {
        log.info("ç»Ÿè®¡ç”¨æˆ·æ•°æ®...");
        // ç»Ÿè®¡ç”¨æˆ·å¢é•¿ã€æ´»è·ƒåº¦ç­‰
    }

    private void statOrderStatistics() {
        log.info("ç»Ÿè®¡è®¢å•æ•°æ®...");
        // ç»Ÿè®¡è®¢å•é‡ã€é‡‘é¢ç­‰
    }

    private void statSystemMetrics() {
        log.info("ç»Ÿè®¡ç³»ç»ŸæŒ‡æ ‡...");
        // ç»Ÿè®¡ QPSã€å“åº”æ—¶é—´ç­‰
    }

    private void generateWeeklyReport() {
        log.info("ç”Ÿæˆå‘¨æŠ¥...");
        // ç”Ÿæˆå‘¨æŠ¥
    }

    private void cleanupHistoricalData() {
        log.info("æ¸…ç†å†å²æ•°æ®...");
        // æ¸…ç†è¿‡æœŸæ•°æ®
    }

    private void updateTrendAnalysis() {
        log.info("æ›´æ–°è¶‹åŠ¿åˆ†æ...");
        // æ›´æ–°è¶‹åŠ¿åˆ†æ
    }
}
```

### 2. ç¼“å­˜é¢„çƒ­ä»»åŠ¡

```java
@Component
public class CacheWarmupJob {

    /**
     * ç¼“å­˜é¢„çƒ­ä»»åŠ¡
     */
    @XxlJob("cacheWarmupJob")
    public void warmupCache() {
        log.info("å¼€å§‹æ‰§è¡Œç¼“å­˜é¢„çƒ­");

        try {
            // é¢„çƒ­ç”¨æˆ·ç¼“å­˜
            warmupUserCache();
            // é¢„çƒ­èœå•ç¼“å­˜
            warmupMenuCache();
            // é¢„çƒ­æƒé™ç¼“å­˜
            warmupPermissionCache();

            XxlJobHelper.handleSuccess("ç¼“å­˜é¢„çƒ­å®Œæˆ");
        } catch (Exception e) {
            log.error("ç¼“å­˜é¢„çƒ­å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    /**
     * åˆ†ç‰‡é¢„çƒ­ä»»åŠ¡
     */
    @XxlJob("shardingCacheWarmupJob")
    public void shardingWarmupCache() {
        int shardIndex = XxlJobHelper.getShardIndex();
        int shardTotal = XxlJobHelper.getShardTotal();

        log.info("åˆ†ç‰‡é¢„çƒ­ç¼“å­˜: {}/{}", shardIndex, shardTotal);

        try {
            // æ ¹æ®åˆ†ç‰‡é¢„çƒ­å¯¹åº”çš„ç¼“å­˜
            warmupCacheByShard(shardIndex, shardTotal);

            XxlJobHelper.handleSuccess("åˆ†ç‰‡é¢„çƒ­å®Œæˆ");
        } catch (Exception e) {
            log.error("åˆ†ç‰‡é¢„çƒ­å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    private void warmupUserCache() {
        log.info("é¢„çƒ­ç”¨æˆ·ç¼“å­˜...");
        // é¢„çƒ­ç”¨æˆ·ç¼“å­˜
    }

    private void warmupMenuCache() {
        log.info("é¢„çƒ­èœå•ç¼“å­˜...");
        // é¢„çƒ­èœå•ç¼“å­˜
    }

    private void warmupPermissionCache() {
        log.info("é¢„çƒ­æƒé™ç¼“å­˜...");
        // é¢„çƒ­æƒé™ç¼“å­˜
    }

    private void warmupCacheByShard(int shardIndex, int shardTotal) {
        log.info("æ ¹æ®åˆ†ç‰‡é¢„çƒ­ç¼“å­˜: {}/{}", shardIndex, shardTotal);
        // åˆ†ç‰‡é¢„çƒ­é€»è¾‘
    }
}
```

### 3. æ—¥å¿—æ¸…ç†ä»»åŠ¡

```java
@Component
public class LogCleanupJob {

    /**
     * æ—¥å¿—æ¸…ç†ä»»åŠ¡
     */
    @XxlJob("logCleanupJob")
    public void cleanupLogs() {
        log.info("å¼€å§‹æ‰§è¡Œæ—¥å¿—æ¸…ç†");

        try {
            // æ¸…ç†åº”ç”¨æ—¥å¿—
            cleanupApplicationLogs();
            // æ¸…ç†å®¡è®¡æ—¥å¿—
            cleanupAuditLogs();
            // æ¸…ç†é”™è¯¯æ—¥å¿—
            cleanupErrorLogs();

            XxlJobHelper.handleSuccess("æ—¥å¿—æ¸…ç†å®Œæˆ");
        } catch (Exception e) {
            log.error("æ—¥å¿—æ¸…ç†å¤±è´¥", e);
            XxlJobHelper.handleFail(e.getMessage());
            throw e;
        }
    }

    private void cleanupApplicationLogs() {
        log.info("æ¸…ç†åº”ç”¨æ—¥å¿—...");
        // æ¸…ç†åº”ç”¨æ—¥å¿—æ–‡ä»¶
    }

    private void cleanupAuditLogs() {
        log.info("æ¸…ç†å®¡è®¡æ—¥å¿—...");
        // æ¸…ç†å®¡è®¡æ—¥å¿—æ•°æ®
    }

    private void cleanupErrorLogs() {
        log.info("æ¸…ç†é”™è¯¯æ—¥å¿—...");
        // æ¸…ç†é”™è¯¯æ—¥å¿—æ•°æ®
    }
}
```

---

## ğŸ“ˆ ä»»åŠ¡ç›‘æ§ä¸å‘Šè­¦

### 1. ä»»åŠ¡ç›‘æ§

```java
@RestController
@RequestMapping("/api/monitor/xxljob")
public class XxlJobMonitorController {

    @Autowired
    private XxlJobMonitor xxlJobMonitor;

    /**
     * è·å–ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡
     */
    @GetMapping("/stats")
    public Result<XxlJobStats> getStats() {
        XxlJobStats stats = xxlJobMonitor.getStatistics();
        return Result.success(stats);
    }

    /**
     * è·å–ä»»åŠ¡æ‰§è¡Œå†å²
     */
    @GetMapping("/history")
    public Result<List<XxlJobExecution>> getHistory(
            @RequestParam(required = false) String jobName,
            @RequestParam(defaultValue = "1") int pageNum,
            @RequestParam(defaultValue = "20") int pageSize) {

        List<XxlJobExecution> history = xxlJobMonitor.getExecutionHistory(jobName, pageNum, pageSize);
        return Result.success(history);
    }

    /**
     * å¥åº·æ£€æŸ¥
     */
    @GetMapping("/health")
    public Result<XxlJobHealth> checkHealth() {
        XxlJobHealth health = new XxlJobHealth();

        // æ£€æŸ¥è°ƒåº¦ä¸­å¿ƒè¿æ¥
        boolean adminConnected = xxlJobMonitor.checkAdminConnection();
        health.setAdminStatus(adminConnected ? "UP" : "DOWN");

        // æ£€æŸ¥æ‰§è¡Œå™¨çŠ¶æ€
        boolean executorActive = xxlJobMonitor.isExecutorActive();
        health.setExecutorStatus(executorActive ? "UP" : "DOWN");

        // æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
        int recentFailures = xxlJobMonitor.getRecentFailures();
        health.setRecentFailures(recentFailures);

        if (adminConnected && executorActive && recentFailures == 0) {
            health.setOverallStatus("UP");
            return Result.success(health);
        } else {
            health.setOverallStatus("DEGRADED");
            return Result.failed("XXL-Job å¥åº·æ£€æŸ¥å¼‚å¸¸");
        }
    }
}
```

### 2. å‘Šè­¦é…ç½®

åœ¨ XXL-Job æ§åˆ¶å°é…ç½®å‘Šè­¦ï¼š

1. **è°ƒåº¦ä¸­å¿ƒ > ç³»ç»Ÿè®¾ç½® > å‘Šè­¦é…ç½®**
   - é‚®ç®±å‘Šè­¦
   - é’‰é’‰å‘Šè­¦
   - ä¼ä¸šå¾®ä¿¡å‘Šè­¦
   - Webhook å‘Šè­¦

2. **ä»»åŠ¡é…ç½® > å‘Šè­¦è®¾ç½®**
   - ä»»åŠ¡å¤±è´¥å‘Šè­¦
   - ä»»åŠ¡è¶…æ—¶å‘Šè­¦
   - ä»»åŠ¡è§¦å‘å‘Šè­¦

---

## ğŸ§ª æµ‹è¯•ä¸éªŒè¯

### 1. ä»»åŠ¡æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# test-xxljob.sh

# æµ‹è¯•ä»»åŠ¡æ‰§è¡Œ
curl -X POST "http://localhost:8080/xxl-job-admin/jobinfo/trigger" \
  -d "id=1" \
  -d "executorParam=syncUserData"

# æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—
curl "http://localhost:8080/xxl-job-admin/joblog/logDetailPage" \
  -d "logId=123"
```

### 2. å‹æµ‹è„šæœ¬

```bash
#!/bin/bash
# stress-test-xxljob.sh

# å¹¶å‘è§¦å‘å¤šä¸ªä»»åŠ¡
for i in {1..10}; do
  (
    curl -X POST "http://localhost:8080/xxl-job-admin/jobinfo/trigger" \
      -d "id=1" \
      -d "executorParam=test_$i"
  ) &
done

wait
echo "æ‰€æœ‰ä»»åŠ¡å·²è§¦å‘"
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. æ‰§è¡Œå™¨æ³¨å†Œå¤±è´¥

**ç°è±¡**: æ§åˆ¶å°æ˜¾ç¤ºæ‰§è¡Œå™¨ç¦»çº¿

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# æ£€æŸ¥é…ç½®
xxl:
  job:
    executor:
      appname: unique_app_name  # ç¡®ä¿åº”ç”¨åå”¯ä¸€
    accessToken: correct_token  # ç¡®ä¿ Token æ­£ç¡®
```

### 2. ä»»åŠ¡æ‰§è¡Œå¤±è´¥

**ç°è±¡**: ä»»åŠ¡ä¸€ç›´å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ä»»åŠ¡ä»£ç æ˜¯å¦æœ‰å¼‚å¸¸
- æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
- æ£€æŸ¥ XXL-Job ç‰ˆæœ¬å…¼å®¹æ€§
- æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—å®šä½å…·ä½“é”™è¯¯

### 3. åˆ†ç‰‡ä»»åŠ¡ä¸å‡åŒ€

**ç°è±¡**: åˆ†ç‰‡ä»»åŠ¡æ‰§è¡Œä¸å‡åŒ€

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿æ‰€æœ‰æ‰§è¡Œå™¨å®ä¾‹éƒ½æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥åˆ†ç‰‡æ€»æ•°é…ç½®æ˜¯å¦ä¸€è‡´
- ä½¿ç”¨å›ºå®šåˆ†ç‰‡æ•°é‡é¿å…åŠ¨æ€å˜åŒ–

### 4. ä»»åŠ¡è¶…æ—¶

**ç°è±¡**: ä»»åŠ¡æ‰§è¡Œè¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:
```yaml
xxl:
  job:
    job:
      timeout: 60  # å¢åŠ è¶…æ—¶æ—¶é—´
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ä»»åŠ¡æ‰§è¡Œå™¨ä¼˜åŒ–

```yaml
xxl:
  job:
    triggerpool:
      fast:
        max: 200  # å¿«é€Ÿè§¦å‘å™¨çº¿ç¨‹æ± å¤§å°
      slow:
        max: 100  # æ…¢é€Ÿè§¦å‘å™¨çº¿ç¨‹æ± å¤§å°
```

### 2. æ•°æ®åº“ä¼˜åŒ–

```sql
-- ä¸º xxl_job_log è¡¨æ·»åŠ ç´¢å¼•
ALTER TABLE xxl_job_log ADD INDEX idx_jobid_trigger_time (job_id, trigger_time);
ALTER TABLE xxl_job_log ADD INDEX idx_trigger_code (trigger_code);
```

### 3. ç›‘æ§ä¼˜åŒ–

```java
// è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œç›‘æ§
@Component
public class XxlJobMetrics {

    private final MeterRegistry meterRegistry;
    private final Counter jobExecutionCounter;
    private final Timer jobExecutionTimer;

    public XxlJobMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.jobExecutionCounter = Counter.builder("xxl_job_execution_total")
            .description("XXL-Job ä»»åŠ¡æ‰§è¡Œæ€»æ•°")
            .register(meterRegistry);
        this.jobExecutionTimer = Timer.builder("xxl_job_execution_duration")
            .description("XXL-Job ä»»åŠ¡æ‰§è¡Œæ—¶é•¿")
            .register(meterRegistry);
    }

    public void recordJobExecution(String jobName, Duration duration, boolean success) {
        jobExecutionCounter.increment(
            Tags.of("job", jobName, "status", success ? "success" : "failure")
        );
        jobExecutionTimer.record(duration,
            Tags.of("job", jobName, "status", success ? "success" : "failure")
        );
    }
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. [XXL-Job å®˜æ–¹æ–‡æ¡£](https://www.xuxueli.com/xxl-job/)
2. [XXL-Job GitHub](https://github.com/xuxueli/xxl-job)
3. [åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶å¯¹æ¯”](https://tech.meituan.com/2018/11/22/xxl-job/)

---

**ç¼–åˆ¶ï¼š** æµ®æµ®é…± ğŸ±ï¼ˆçŒ«å¨˜å·¥ç¨‹å¸ˆï¼‰
**æ—¥æœŸï¼š** 2025-11-14
**çŠ¶æ€ï¼š** ğŸ“‹ æŒ‡å—å®Œæˆï¼Œå‡†å¤‡å®æ–½

**åŠ æ²¹å–µï½ åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å³å°†å®Œæˆï¼** à¸…'Ï‰'à¸…
