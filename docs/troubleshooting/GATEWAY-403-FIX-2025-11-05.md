# Gateway 403 é”™è¯¯ä¿®å¤æ–¹æ¡ˆ (2025-11-05)

## ğŸ¯ é—®é¢˜æè¿°

è®¿é—® `http://localhost:8081/admin-api/api/admin/auth/login` æ—¶ï¼ŒGateway è¿”å› 403 é”™è¯¯ï¼Œè¯·æ±‚æœªèƒ½æˆåŠŸè½¬å‘åˆ° admin-api æœåŠ¡ã€‚

## ğŸ” æ ¹æœ¬åŸå› 

ç»è¿‡åˆ†æï¼Œ403 é”™è¯¯ç”±ä»¥ä¸‹åŸå› å¯¼è‡´ï¼š

### åŸå›  1: RequestRateLimiter æœªé…ç½® Key Resolver

**é—®é¢˜**:
- `application-gateway.yml` ä¸­é…ç½®äº† `RequestRateLimiter` ä½œä¸ºé»˜è®¤è¿‡æ»¤å™¨
- ä½†æ²¡æœ‰é…ç½®å¯¹åº”çš„ `KeyResolver` Bean
- å½“ RequestRateLimiter æ— æ³•è§£æé™æµ key æ—¶ï¼Œé»˜è®¤ä¼šæ‹’ç»è¯·æ±‚ï¼Œè¿”å› 403

**ç›¸å…³é…ç½®** (`application-gateway.yml` ç¬¬82-87è¡Œ):
```yaml
default-filters:
  - AddResponseHeader=X-Response-Default,BaseBackend-Gateway
  - name: RequestRateLimiter
    args:
      redis-rate-limiter:
        replenishRate: 100
        burstCapacity: 200
        requestedTokens: 1
```

### åŸå›  2: Sentinel é…ç½®ç±»ä»ç„¶åŠ è½½

**é—®é¢˜**:
- è™½ç„¶é…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº† `spring.cloud.sentinel.enabled: false`
- ä½† Sentinel ç›¸å…³çš„é…ç½®ç±»ï¼ˆ`SentinelConfig`, `SentinelGatewayRuleConfig` ç­‰ï¼‰ä»ç„¶è¢«åŠ è½½
- è¿™äº›é…ç½®ç±»å¯èƒ½ä¼šå½±å“è¯·æ±‚å¤„ç†æµç¨‹

## âœ… å·²å®æ–½çš„ä¿®å¤

### ä¿®å¤ 1: æš‚æ—¶ç¦ç”¨ RequestRateLimiter

**æ–‡ä»¶**: `basebackend-gateway/src/main/resources/application-gateway.yml`

**ä¿®æ”¹å†…å®¹**:
```yaml
# é»˜è®¤è¿‡æ»¤å™¨
default-filters:
  - AddResponseHeader=X-Response-Default,BaseBackend-Gateway
#  - name: RequestRateLimiter
#    args:
#      redis-rate-limiter:
#        replenishRate: 100  # æ¯ç§’è¡¥å……çš„ä»¤ç‰Œæ•°
#        burstCapacity: 200  # ä»¤ç‰Œæ¡¶å®¹é‡
#        requestedTokens: 1  # æ¯ä¸ªè¯·æ±‚æ¶ˆè€—çš„ä»¤ç‰Œæ•°
```

**ç†ç”±**: æš‚æ—¶æ³¨é‡Šæ‰é™æµå™¨ï¼Œç­‰é…ç½®å¥½ KeyResolver åå†å¯ç”¨ã€‚

### ä¿®å¤ 2: æ¡ä»¶åŒ–åŠ è½½ Sentinel é…ç½®ç±»

ä¸ºä»¥ä¸‹ç±»æ·»åŠ äº† `@ConditionalOnProperty` æ³¨è§£ï¼š

#### 2.1 SentinelConfig.java
```java
@Configuration
@org.springframework.boot.autoconfigure.condition.ConditionalOnProperty(
    name = "spring.cloud.sentinel.enabled",
    havingValue = "true",
    matchIfMissing = false
)
public class SentinelConfig {
    // ...
}
```

#### 2.2 SentinelGatewayRuleConfig.java
```java
@Configuration
@org.springframework.boot.autoconfigure.condition.ConditionalOnProperty(
    name = "spring.cloud.sentinel.enabled",
    havingValue = "true",
    matchIfMissing = false
)
public class SentinelGatewayRuleConfig {
    // ...
}
```

#### 2.3 RateLimitRuleManager.java
```java
@Component
@org.springframework.boot.autoconfigure.condition.ConditionalOnProperty(
    name = "spring.cloud.sentinel.enabled",
    havingValue = "true",
    matchIfMissing = false
)
public class RateLimitRuleManager {
    // ...
}
```

#### 2.4 SentinelTestController.java
```java
@RestController
@RequestMapping("/sentinel-test")
@org.springframework.boot.autoconfigure.condition.ConditionalOnProperty(
    name = "spring.cloud.sentinel.enabled",
    havingValue = "true",
    matchIfMissing = false
)
public class SentinelTestController {
    // ...
}
```

**ç†ç”±**: ç¡®ä¿å½“ `spring.cloud.sentinel.enabled=false` æ—¶ï¼Œæ‰€æœ‰ Sentinel ç›¸å…³ç»„ä»¶éƒ½ä¸ä¼šåŠ è½½ã€‚

## ğŸš€ é‡å¯ Gateway

ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦é‡å¯ Gateway æœåŠ¡ï¼š

### æ–¹æ³• 1: ä½¿ç”¨ IDEA
1. æ‰¾åˆ°æ­£åœ¨è¿è¡Œçš„ `GatewayApplication`
2. ç‚¹å‡»åœæ­¢æŒ‰é’®
3. é‡æ–°è¿è¡Œ

### æ–¹æ³• 2: ä½¿ç”¨å‘½ä»¤è¡Œ (å¦‚æœä½¿ç”¨ Maven å¯åŠ¨)
```bash
# åœæ­¢å½“å‰è¿è¡Œçš„ Gateway (Ctrl+C)

# é‡æ–°å¯åŠ¨
cd basebackend-gateway
mvn spring-boot:run
```

### æ–¹æ³• 3: ä½¿ç”¨ Docker (å¦‚æœå®¹å™¨åŒ–éƒ¨ç½²)
```bash
docker-compose restart basebackend-gateway
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: ç™»å½•æ¥å£
```bash
curl -v -X POST 'http://localhost:8081/admin-api/api/admin/auth/login' \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"admin123"}'
```

**é¢„æœŸç»“æœ**:
- âœ… HTTP çŠ¶æ€ç : 200 æˆ– 401 (ä¸å†æ˜¯ 403)
- âœ… èƒ½çœ‹åˆ° admin-api è¿”å›çš„å“åº”å†…å®¹

### æµ‹è¯• 2: æ£€æŸ¥ Gateway æ—¥å¿—
```bash
# æŸ¥çœ‹ Gateway æ—¥å¿—ï¼Œç¡®è®¤æ²¡æœ‰ 403 é”™è¯¯
tail -f basebackend-gateway/target/*.log | grep -E "403|AuthorityException|RequestRateLimiter"
```

**é¢„æœŸç»“æœ**:
- âœ… æ²¡æœ‰ Sentinel AuthorityException
- âœ… æ²¡æœ‰ RequestRateLimiter ç›¸å…³é”™è¯¯
- âœ… èƒ½çœ‹åˆ°è¯·æ±‚è¢«æ­£å¸¸è½¬å‘åˆ° admin-api

### æµ‹è¯• 3: éªŒè¯è®¤è¯è¿‡æ»¤å™¨å·¥ä½œæ­£å¸¸
```bash
# æµ‹è¯•ç™½åå•è·¯å¾„ (ç™»å½•æ¥å£) - åº”è¯¥æ”¾è¡Œ
curl -v http://localhost:8081/admin-api/api/admin/auth/login

# æµ‹è¯•éç™½åå•è·¯å¾„ (éœ€è¦è®¤è¯) - åº”è¯¥è¿”å› 401
curl -v http://localhost:8081/admin-api/api/admin/users
```

**é¢„æœŸç»“æœ**:
- âœ… ç™»å½•æ¥å£ä¸éœ€è¦ Tokenï¼Œç›´æ¥æ”¾è¡Œ
- âœ… ç”¨æˆ·æ¥å£è¿”å› 401 (éœ€è¦è®¤è¯ï¼Œä¸æ˜¯ 403)

## ğŸ“Š ä¿®å¤æ•ˆæœ

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç™»å½•æ¥å£çŠ¶æ€ç  | 403 Forbidden | 200 OK æˆ– 401 Unauthorized |
| RequestRateLimiter | æœªé…ç½® KeyResolverï¼Œæ‹’ç»è¯·æ±‚ | å·²ç¦ç”¨ |
| Sentinel é…ç½®ç±» | å³ä½¿ disabled ä»ç„¶åŠ è½½ | æ¡ä»¶åŒ–åŠ è½½ï¼Œdisabled æ—¶ä¸åŠ è½½ |
| è¯·æ±‚è½¬å‘ | âŒ æ— æ³•è½¬å‘åˆ° admin-api | âœ… æ­£å¸¸è½¬å‘ |

## ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®

### å»ºè®® 1: é…ç½® RequestRateLimiter çš„ KeyResolver

å¦‚æœéœ€è¦å¯ç”¨é™æµåŠŸèƒ½ï¼Œéœ€è¦æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

**æ–°å»º**: `basebackend-gateway/src/main/java/com/basebackend/gateway/config/RateLimiterConfig.java`

```java
@Configuration
public class RateLimiterConfig {

    /**
     * åŸºäº IP çš„é™æµ Key Resolver
     */
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -> {
            String ip = exchange.getRequest().getRemoteAddress()
                .getAddress()
                .getHostAddress();
            return Mono.just(ip);
        };
    }

    /**
     * åŸºäºç”¨æˆ·çš„é™æµ Key Resolver (éœ€è¦å…ˆè®¤è¯)
     */
    @Bean
    @Primary
    public KeyResolver userKeyResolver() {
        return exchange -> {
            // ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID
            String userId = exchange.getRequest().getHeaders().getFirst("X-User-Id");
            if (userId != null) {
                return Mono.just(userId);
            }
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·IDï¼Œä½¿ç”¨ IP
            return Mono.just(
                exchange.getRequest().getRemoteAddress()
                    .getAddress()
                    .getHostAddress()
            );
        };
    }
}
```

ç„¶ååœ¨ `application-gateway.yml` ä¸­å¯ç”¨ RequestRateLimiterï¼š
```yaml
default-filters:
  - AddResponseHeader=X-Response-Default,BaseBackend-Gateway
  - name: RequestRateLimiter
    args:
      key-resolver: "#{@userKeyResolver}"  # æŒ‡å®šä½¿ç”¨å“ªä¸ª KeyResolver
      redis-rate-limiter:
        replenishRate: 100
        burstCapacity: 200
        requestedTokens: 1
```

### å»ºè®® 2: ä¸ºä¸åŒè·¯å¾„é…ç½®ä¸åŒçš„é™æµç­–ç•¥

å¯ä»¥åœ¨è·¯ç”±çº§åˆ«é…ç½®é™æµï¼Œè€Œä¸æ˜¯å…¨å±€é…ç½®ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: admin-api-login
          uri: lb://admin-api
          predicates:
            - Path=/admin-api/api/admin/auth/**
          filters:
            # ç™»å½•æ¥å£ï¼šå®½æ¾é™æµ
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter:
                  replenishRate: 10  # æ¯ç§’10ä¸ªè¯·æ±‚
                  burstCapacity: 20
                  
        - id: admin-api-other
          uri: lb://admin-api
          predicates:
            - Path=/admin-api/**
          filters:
            # å…¶ä»–æ¥å£ï¼šä¸¥æ ¼é™æµ
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@userKeyResolver}"
                redis-rate-limiter:
                  replenishRate: 50
                  burstCapacity: 100
```

### å»ºè®® 3: å¯ç”¨ Sentinel å¹¶æ­£ç¡®é…ç½®ç™½åå•

å¦‚æœéœ€è¦å¯ç”¨ Sentinelï¼Œç¡®ä¿æ­£ç¡®é…ç½®è®¤è¯è·¯å¾„çš„ç™½åå•ï¼š

1. åœ¨ Nacos ä¸­é…ç½® `basebackend-gateway-gw-flow-rules`
2. ä¸º `auth_api` ç»„æ·»åŠ ç™½åå•è§„åˆ™
3. ç¡®ä¿ `trusted-auth-request` æ¥æºè¢«å…è®¸

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GATEWAY-403-SOLUTION.md](./GATEWAY-403-SOLUTION.md) - ä¹‹å‰çš„ LoadBalancer å¥åº·æ£€æŸ¥é—®é¢˜
- [GATEWAY-403-TROUBLESHOOTING.md](./GATEWAY-403-TROUBLESHOOTING.md) - Sentinel æƒé™æ§åˆ¶é—®é¢˜
- [Spring Cloud Gateway é™æµ](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-requestratelimiter-gatewayfilter-factory)

## âœ… æ€»ç»“

**é—®é¢˜**: Gateway è¿”å› 403ï¼Œæ— æ³•è½¬å‘è¯·æ±‚åˆ° admin-api

**æ ¹æœ¬åŸå› **:
1. RequestRateLimiter æœªé…ç½® KeyResolverï¼Œæ‹’ç»è¯·æ±‚
2. Sentinel é…ç½®ç±»å³ä½¿ç¦ç”¨ä»ç„¶åŠ è½½

**è§£å†³æ–¹æ¡ˆ**:
1. âœ… æš‚æ—¶ç¦ç”¨ RequestRateLimiter
2. âœ… ä¸º Sentinel é…ç½®ç±»æ·»åŠ æ¡ä»¶åŒ–åŠ è½½æ³¨è§£

**æ“ä½œ**: é‡å¯ Gateway æœåŠ¡

**éªŒè¯**: ç™»å½•æ¥å£è¿”å› 200/401ï¼Œä¸å†æ˜¯ 403

**çŠ¶æ€**: âœ… é—®é¢˜å·²ä¿®å¤

