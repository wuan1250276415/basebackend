<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basebackend.admin.mapper.SysApplicationResourceMapper">

    <resultMap id="BaseResultMap" type="com.basebackend.admin.entity.SysApplicationResource">
        <id column="id" property="id" />
        <result column="app_id" property="appId" />
        <result column="resource_name" property="resourceName" />
        <result column="parent_id" property="parentId" />
        <result column="resource_type" property="resourceType" />
        <result column="path" property="path" />
        <result column="component" property="component" />
        <result column="perms" property="perms" />
        <result column="icon" property="icon" />
        <result column="visible" property="visible" />
        <result column="open_type" property="openType" />
        <result column="order_num" property="orderNum" />
        <result column="status" property="status" />
        <result column="remark" property="remark" />
        <result column="create_by" property="createBy" />
        <result column="create_time" property="createTime" />
        <result column="update_by" property="updateBy" />
        <result column="update_time" property="updateTime" />
        <result column="deleted" property="deleted" />
    </resultMap>

    <resultMap id="TreeResultMap" type="com.basebackend.admin.entity.SysApplicationResource" extends="BaseResultMap">
        <result column="app_name" property="appName" />
    </resultMap>

    <!-- 根据应用ID查询资源列表 -->
    <select id="selectByAppId" resultMap="BaseResultMap">
        SELECT * FROM sys_application_resource
        WHERE app_id = #{appId} AND deleted = 0
        ORDER BY order_num ASC, create_time ASC
    </select>

    <!-- 根据应用ID和用户ID查询用户有权限的资源 -->
    <select id="selectResourcesByAppIdAndUserId" resultMap="BaseResultMap">
        SELECT DISTINCT r.*
        FROM sys_application_resource r
        INNER JOIN sys_role_resource rr ON r.id = rr.resource_id
        INNER JOIN sys_user_role ur ON rr.role_id = ur.role_id
        WHERE r.app_id = #{appId}
          AND ur.user_id = #{userId}
          AND r.deleted = 0
          AND r.status = 1
        ORDER BY r.order_num ASC, r.create_time ASC
    </select>

    <!-- 根据角色ID查询资源ID列表 -->
    <select id="selectResourceIdsByRoleId" resultType="java.lang.Long">
        SELECT resource_id FROM sys_role_resource
        WHERE role_id = #{roleId}
    </select>

    <!-- 查询资源树（包含子资源） -->
    <select id="selectResourceTree" resultMap="TreeResultMap">
        SELECT r.*, a.app_name
        FROM sys_application_resource r
        LEFT JOIN sys_application a ON r.app_id = a.id
        WHERE r.app_id = #{appId} AND r.deleted = 0
        ORDER BY r.order_num ASC, r.create_time ASC
    </select>

</mapper>
