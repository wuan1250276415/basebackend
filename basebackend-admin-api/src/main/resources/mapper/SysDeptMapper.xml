<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.basebackend.admin.mapper.SysDeptMapper">

    <!-- 根据父部门ID查询子部门数量 -->
    <select id="selectCountByParentId" resultType="int">
        SELECT COUNT(1)
        FROM sys_dept
        WHERE parent_id = #{parentId}
        AND deleted = 0
    </select>

    <!-- 查询部门树列表 -->
    <select id="selectDeptTreeList" resultType="com.basebackend.admin.entity.SysDept">
        SELECT *
        FROM sys_dept
        WHERE deleted = 0
        ORDER BY order_num
    </select>

    <!-- 根据部门ID查询子部门列表 -->
    <select id="selectChildrenByDeptId" resultType="com.basebackend.admin.entity.SysDept">
        SELECT *
        FROM sys_dept
        WHERE parent_id = #{deptId}
        AND deleted = 0
        ORDER BY order_num
    </select>

    <!-- 根据部门ID查询所有子部门ID列表 -->
    <select id="selectChildrenDeptIds" resultType="java.lang.Long">
        WITH RECURSIVE dept_tree AS (
            SELECT id, parent_id
            FROM sys_dept
            WHERE id = #{deptId}
            AND deleted = 0
            
            UNION ALL
            
            SELECT d.id, d.parent_id
            FROM sys_dept d
            INNER JOIN dept_tree dt ON d.parent_id = dt.id
            WHERE d.deleted = 0
        )
        SELECT id FROM dept_tree WHERE id != #{deptId}
    </select>

    <!-- 检查部门名称是否唯一 -->
    <select id="checkDeptNameUnique" resultType="int">
        SELECT COUNT(1)
        FROM sys_dept
        WHERE dept_name = #{deptName}
        AND parent_id = #{parentId}
        AND deleted = 0
        <if test="deptId != null">
            AND id != #{deptId}
        </if>
    </select>

    <!-- 根据用户ID查询部门信息 -->
    <select id="selectDeptByUserId" resultType="com.basebackend.admin.entity.SysDept">
        SELECT d.*
        FROM sys_dept d
        INNER JOIN sys_user u ON d.id = u.dept_id
        WHERE u.id = #{userId}
        AND d.deleted = 0
        AND u.deleted = 0
    </select>

</mapper>
