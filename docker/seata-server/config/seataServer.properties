# ================================================================================================
# Seata Server Configuration for Nacos Config Center
# File: seataServer.properties
# Version: 1.7.1
# Description: Central configuration for Seata Server, stored in Nacos
# ================================================================================================
#
# Upload Instructions:
# 1. Login to Nacos Console: http://192.168.66.126:8848/nacos
# 2. Navigate to: Configuration Management â†’ Configurations
# 3. Click: Create Configuration
# 4. Fill in:
#    - Data ID: seataServer.properties
#    - Group: SEATA_GROUP
#    - Configuration Format: Properties
#    - Configuration Content: (paste the content below)
# 5. Click: Publish
#
# Alternatively, use Nacos Open API:
# curl -X POST "http://192.168.66.126:8848/nacos/v1/cs/configs" \
#   -d "dataId=seataServer.properties" \
#   -d "group=SEATA_GROUP" \
#   -d "content=$(cat seataServer.properties | jq -sRr @uri)"
#
# ================================================================================================

# ================================================================================================
# Store Configuration (MySQL)
# ================================================================================================
store.mode=db
store.lock.mode=db
store.session.mode=db

# Database Configuration
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.cj.jdbc.Driver
store.db.url=jdbc:mysql://192.168.66.126:3306/seata_server?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false&rewriteBatchedStatements=true&allowPublicKeyRetrieval=true
store.db.user=root
store.db.password=Wyx123456789.
store.db.minConn=10
store.db.maxConn=100
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.lockTable=lock_table
store.db.distributedLockTable=distributed_lock
store.db.queryLimit=1000
store.db.maxWait=5000

# ================================================================================================
# Server Configuration
# ================================================================================================

# Transaction Recovery Configuration
server.recovery.committingRetryPeriod=1000
server.recovery.asynCommittingRetryPeriod=1000
server.recovery.rollbackingRetryPeriod=1000
server.recovery.timeoutRetryPeriod=1000

# Transaction Retry Configuration
server.maxCommitRetryTimeout=-1
server.maxRollbackRetryTimeout=-1
server.rollbackRetryTimeoutUnlockEnable=false

# Authentication
server.enableCheckAuth=true

# Undo Log Configuration
server.undo.logSaveDays=7
server.undo.logDeletePeriod=86400000

# Session Retention
server.session.branchAsyncQueueSize=5000
server.session.enableBranchAsyncRemove=false

# ================================================================================================
# Metrics Configuration
# ================================================================================================
metrics.enabled=true
metrics.registryType=compact
metrics.exporterList=prometheus
metrics.exporterPrometheusPort=9898

# ================================================================================================
# Transport Configuration
# ================================================================================================
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableTmClientBatchSendRequest=false
transport.enableRmClientBatchSendRequest=true
transport.enableTcServerBatchSendResponse=false
transport.rpcRmRequestTimeout=30000
transport.rpcTmRequestTimeout=30000
transport.rpcTcRequestTimeout=30000

# Thread Factory Configuration
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=ServerExecutorThread
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default

# Netty Configuration
transport.shutdown.wait=3
transport.serialization=seata
transport.compressor=none

# ================================================================================================
# Service Configuration (for clients)
# ================================================================================================

# Service Grouping
service.vgroupMapping.basebackend-seata-group=default
service.default.grouplist=192.168.66.126:8091

# Enable Degradation (graceful degradation when Seata Server unavailable)
service.enableDegrade=false

# Disable Global Transaction (emergency switch to disable distributed transactions)
service.disableGlobalTransaction=false

# ================================================================================================
# Client Configuration (default for all clients)
# ================================================================================================

# RM (Resource Manager) Configuration
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=true
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
client.rm.sagaJsonParser=fastjson
client.rm.tccActionInterceptorOrder=-2147482648

# TM (Transaction Manager) Configuration
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000
client.tm.interceptorOrder=-2147482648

# Undo Log Configuration
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.logTable=undo_log
client.undo.onlyCareUpdateColumns=true
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k

# Log Configuration
client.log.exceptionRate=100

# ================================================================================================
# Configuration Notes
# ================================================================================================
#
# 1. Property Priority:
#    - Nacos config (this file) overrides application.yml
#    - Client application.yml overrides Nacos defaults
#
# 2. Transaction Service Group Mapping:
#    - service.vgroupMapping.<tx-service-group>=<cluster-name>
#    - Must match client configuration: seata.tx-service-group
#    - Multiple groups can map to same cluster
#
# 3. Database Connection:
#    - Ensure MySQL is accessible from Seata Server
#    - Use connection pooling for better performance
#    - Enable rewriteBatchedStatements for batch operations
#
# 4. Performance Tuning:
#    - Increase store.db.maxConn for high concurrency
#    - Adjust server.undo.logSaveDays based on disk space
#    - Enable compression: client.undo.compress.enable=true
#
# 5. High Availability:
#    - Deploy multiple Seata Server instances
#    - All instances read this same configuration from Nacos
#    - Clients load balance across instances automatically
#
# 6. Security:
#    - Encrypt sensitive properties (like passwords) in production
#    - Use Nacos encrypted data feature
#    - Restrict Nacos access to authorized users only
#
# 7. Monitoring:
#    - Metrics available at http://<seata-server-ip>:9898/metrics
#    - Integrate with Prometheus for alerting
#    - Monitor transaction success rate and latency
#
# ================================================================================================
