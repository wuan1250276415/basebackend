# 用户服务路由配置
# 创建时间: 2025-11-15
# 描述: 用户服务独立部署后的网关路由配置

spring:
  cloud:
    gateway:
      routes:
        # 用户服务路由
        - id: user-service
          uri: lb://basebackend-user-service
          predicates:
            - Path=/api/users/**
          filters:
            # 限流
            - name: RequestRateLimiter
              args:
                rate-limiter: "#{@redisRateLimiter}"
                key-resolver: "#{@userKeyResolver}"
                redis-rate-limiter:
                  replenishRate: 100  # 每秒补充的令牌数
                  burstCapacity: 200  # 令牌桶容量
                  requestedTokens: 1  # 每个请求消耗的令牌数
            # 熔断
            - name: CircuitBreaker
              args:
                name: user-service-circuit-breaker
                fallbackUri: forward:/fallback/users
            # 重试
            - name: Retry
              args:
                retries: 3
                statuses: INTERNAL_SERVER_ERROR,BAD_GATEWAY
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 1000ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            stripe: true
            version: "1.0"

        # 用户服务健康管理路由
        - id: user-service-health
          uri: lb://basebackend-user-service
          predicates:
            - Path=/actuator/**
          filters:
            # 健康检查不进行限流
            - name: RequestRateLimiter
              args:
                rate-limiter: "#{@noopRateLimiter}"
          metadata:
            health-check: true
