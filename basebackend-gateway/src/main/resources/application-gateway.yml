
spring:
  application:
    name: basebackend-gateway

  main:
    web-application-type: reactive
  cloud:
    # Sentinel配置
    sentinel:
      transport:
        dashboard: 1.117.67.222:8858  # Sentinel控制台地址
        port: 8719
      eager: true
      # Nacos数据源配置
      datasource:
        # 流控规则
        flow:
          nacos:
            server-addr: ${spring.cloud.nacos.discovery.server-addr}
            dataId: ${spring.application.name}-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow
            username: nacos
            password: nacos
        # 降级规则
        degrade:
          nacos:
            server-addr: ${spring.cloud.nacos.discovery.server-addr}
            dataId: ${spring.application.name}-degrade-rules
            groupId: SENTINEL_GROUP
            rule-type: degrade
            username: nacos
            password: nacos
        # 网关限流规则
        gw-flow:
          nacos:
            server-addr: ${spring.cloud.nacos.discovery.server-addr}
            dataId: ${spring.application.name}-gw-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: gw-flow
            username: nacos
            password: nacos

    gateway:
      # 动态路由从Nacos加载
      discovery:
        locator:
          enabled: true  # 启用服务发现
          lower-case-service-id: true  # 服务名小写

      # 路由配置
      routes:
        # admin-api服务路由
        - id: admin-api
          uri: lb://admin-api
          predicates:
            - Path=/admin-api/**
          filters:
            - StripPrefix=1
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: GET,POST
                backoff:
                  firstBackoff: 10ms
                  maxBackoff: 50ms
                  factor: 2
                  basedOnPreviousValue: false

      # 全局CORS配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowed-headers: "*"
            allow-credentials: false
            max-age: 3600

      # 默认过滤器
      default-filters:
        - AddResponseHeader=X-Response-Default,BaseBackend-Gateway
        - name: RequestRateLimiter
          args:
            redis-rate-limiter:
              replenishRate: 100  # 每秒补充的令牌数
              burstCapacity: 200  # 令牌桶容量
              requestedTokens: 1  # 每个请求消耗的令牌数
  data:
    redis:
      host: ${spring.data.redis.host}
      port: ${spring.data.redis.port}
      password: ${spring.data.redis.password}
      database: ${spring.data.redis.database}
      timeout: ${spring.data.redis.timeout}
      lettuce:
        pool:
          max-active: ${spring.data.redis.max-active}
          max-wait: ${spring.data.redis.max-wait}
          max-idle: ${spring.data.redis.max-idle}
          min-idle: ${spring.data.redis.min-idle}

# 灰度路由配置
gateway:
  gray:
    enabled: true
    rules:
      # admin-api灰度示例
      - serviceName: admin-api
        grayVersion: v2.0.0
        stableVersion: v1.0.0
        strategy: weight  # header/user/ip/weight
        weight: 10  # 10%流量到灰度版本

      # 基于Header的灰度
      - serviceName: basebackend-demo-api
        grayVersion: v2.0.0
        stableVersion: v1.0.0
        strategy: header
        headerName: X-Gray-Flag
        headerValue: "true"


# JWT配置
jwt:
  secret: basebackend-demo-secret-key-for-jwt-token-generation-minimum-256-bits-required
  expiration: 86400000

# 日志配置
logging:
  level:
    com.basebackend.gateway: DEBUG
    com.alibaba.csp.sentinel: INFO
    org.springframework.cloud.gateway: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# Management配置
management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    health:
      show-details: always
