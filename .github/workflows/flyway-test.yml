name: Flyway Database Migration Test

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**/db/migration/**'
      - '**/pom.xml'
      - '.github/workflows/flyway-test.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/db/migration/**'
  workflow_dispatch:

jobs:
  # ==========================================
  # è¿ç§»è„šæœ¬éªŒè¯
  # ==========================================
  validate-scripts:
    name: Validate Migration Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Validate migration scripts syntax
        run: |
          echo "æ£€æŸ¥è¿ç§»è„šæœ¬å‘½åè§„èŒƒ..."
          cd basebackend-admin-api/src/main/resources/db/migration

          for file in *.sql; do
            if [[ ! $file =~ ^V[0-9]+(\.[0-9]+)*__[a-z_]+\.sql$ ]] && \
               [[ ! $file =~ ^R__[a-z_]+\.sql$ ]]; then
              echo "âŒ æ–‡ä»¶å‘½åä¸ç¬¦åˆè§„èŒƒ: $file"
              exit 1
            fi
          done

          echo "âœ… æ‰€æœ‰è¿ç§»è„šæœ¬å‘½åè§„èŒƒæ­£ç¡®"

      - name: Check for dangerous SQL
        run: |
          echo "æ£€æŸ¥å±é™©SQLè¯­å¥..."
          MIGRATION_DIR="basebackend-admin-api/src/main/resources/db/migration"

          # æ£€æŸ¥DROPè¯­å¥
          if grep -r "DROP TABLE IF EXISTS" "$MIGRATION_DIR" 2>/dev/null; then
            echo "âš ï¸ å‘çŽ° DROP TABLE IF EXISTSï¼Œå»ºè®®ä½¿ç”¨ CREATE TABLE IF NOT EXISTS"
          fi

          # æ£€æŸ¥USEè¯­å¥
          if grep -r "^USE " "$MIGRATION_DIR" 2>/dev/null; then
            echo "âŒ å‘çŽ° USE è¯­å¥ï¼ŒFlywayä¼šè‡ªåŠ¨è¿žæŽ¥åˆ°æ­£ç¡®çš„æ•°æ®åº“"
            exit 1
          fi

          echo "âœ… SQLæ£€æŸ¥é€šè¿‡"

  # ==========================================
  # MySQLè¿ç§»æµ‹è¯•
  # ==========================================
  test-mysql-migration:
    name: Test MySQL Migration
    runs-on: ubuntu-latest
    needs: validate-scripts

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: basebackend_admin_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for MySQL
        run: |
          echo "ç­‰å¾…MySQLå°±ç»ª..."
          sleep 10

      - name: Run Flyway Migration
        run: |
          mvn flyway:migrate \
            -Dflyway.url=jdbc:mysql://localhost:3306/basebackend_admin_test?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai \
            -Dflyway.user=root \
            -Dflyway.password=root \
            -pl basebackend-admin-api \
            -B

      - name: Verify Migration
        run: |
          mvn flyway:info \
            -Dflyway.url=jdbc:mysql://localhost:3306/basebackend_admin_test?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai \
            -Dflyway.user=root \
            -Dflyway.password=root \
            -pl basebackend-admin-api \
            -B

      - name: Validate Migration
        run: |
          mvn flyway:validate \
            -Dflyway.url=jdbc:mysql://localhost:3306/basebackend_admin_test?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai \
            -Dflyway.user=root \
            -Dflyway.password=root \
            -pl basebackend-admin-api \
            -B

      - name: Test Idempotency
        run: |
          echo "æµ‹è¯•è¿ç§»å¹‚ç­‰æ€§..."
          mvn flyway:migrate \
            -Dflyway.url=jdbc:mysql://localhost:3306/basebackend_admin_test?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai \
            -Dflyway.user=root \
            -Dflyway.password=root \
            -pl basebackend-admin-api \
            -B

          echo "âœ… è¿ç§»å¹‚ç­‰æ€§æµ‹è¯•é€šè¿‡"

  # ==========================================
  # æµ‹è¯•æ€»ç»“
  # ==========================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [validate-scripts, test-mysql-migration]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ—„ï¸ Flywayæ•°æ®åº“è¿ç§»æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬éªŒè¯: ${{ needs.validate-scripts.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- MySQLè¿ç§»æµ‹è¯•: ${{ needs.test-mysql-migration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.validate-scripts.result }}" == "success" ]] && \
             [[ "${{ needs.test-mysql-migration.result }}" == "success" ]]; then
            echo "âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æµ‹è¯•å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
