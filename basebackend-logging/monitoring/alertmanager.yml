# AlertManager å…¨å±€é…ç½®
global:
  # SMTP æœåŠ¡å™¨é…ç½®
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alerts@basebackend.com'
  smtp_auth_username: 'alerts@basebackend.com'
  smtp_auth_password: 'REPLACE_ME'
  smtp_require_tls: true

  # Slack é…ç½® (å¯é€‰)
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    # ä¸¥é‡å‘Šè­¦è·¯ç”±
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m

    # å¹³å°å›¢é˜Ÿå‘Šè­¦
    - match:
        team: platform
      receiver: 'platform-alerts'
      group_wait: 30s
      group_interval: 1m
      repeat_interval: 2h

    # å®‰å…¨å›¢é˜Ÿå‘Šè­¦
    - match:
        team: security
      receiver: 'security-alerts'
      group_wait: 30s
      group_interval: 1m
      repeat_interval: 2h

    # SRE å›¢é˜Ÿå‘Šè­¦
    - match:
        team: sre
      receiver: 'sre-alerts'
      group_wait: 30s
      group_interval: 1m
      repeat_interval: 2h

# æ¥æ”¶è€…é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶è€…
  - name: 'default'
    email_configs:
      - to: 'devops@basebackend.com'
        subject: 'BaseBackend Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ä¸¥é‡çº§åˆ«: {{ .Labels.severity }}
          {{ end }}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶è€…
  - name: 'critical-alerts'
    email_configs:
      - to: 'devops@basebackend.com,management@basebackend.com'
        subject: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦ ğŸš¨

          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          è¯¦ç»†æè¿°: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          ä¸¥é‡çº§åˆ«: {{ .Labels.severity }}
          è§¦å‘æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          æŒç»­æ—¶é—´: {{ .EndsAt.Sub .StartsAt }}

          æ“ä½œæ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}

          è¯·ç«‹å³å¤„ç†ï¼
    slack_configs:
      - channel: '#alerts-critical'
        title: 'ğŸš¨ Critical Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          *Severity:* {{ .Labels.severity }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
    webhook_configs:
      - url: 'https://hooks.pagerduty.com/integration/YOUR_PD_KEY/enqueue'
        send_resolved: true

  # å¹³å°å›¢é˜Ÿå‘Šè­¦
  - name: 'platform-alerts'
    email_configs:
      - to: 'platform@basebackend.com'
        subject: 'Platform Alert: {{ .GroupLabels.alertname }}'
        body: |
          å¹³å°å›¢é˜Ÿå‘Šè­¦:

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          å®ä¾‹: {{ .Labels.instance }}
          ç»„ä»¶: {{ .Labels.component }}
          æè¿°: {{ .Annotations.description }}
          è§¦å‘æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ä¸¥é‡çº§åˆ«: {{ .Labels.severity }}

          æ“ä½œæ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}
    slack_configs:
      - channel: '#platform-alerts'
        title: 'Platform Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Instance:* {{ .Labels.instance }}
          *Component:* {{ .Labels.component }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}

  # å®‰å…¨å›¢é˜Ÿå‘Šè­¦
  - name: 'security-alerts'
    email_configs:
      - to: 'security@basebackend.com'
        subject: 'Security Alert: {{ .GroupLabels.alertname }}'
        body: |
          å®‰å…¨å›¢é˜Ÿå‘Šè­¦:

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          å®ä¾‹: {{ .Labels.instance }}
          ç»„ä»¶: {{ .Labels.component }}
          æè¿°: {{ .Annotations.description }}
          è§¦å‘æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ä¸¥é‡çº§åˆ«: {{ .Labels.severity }}

          æ“ä½œæ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}
    slack_configs:
      - channel: '#security-alerts'
        title: 'Security Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Instance:* {{ .Labels.instance }}
          *Component:* {{ .Labels.component }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}

  # SRE å›¢é˜Ÿå‘Šè­¦
  - name: 'sre-alerts'
    email_configs:
      - to: 'sre@basebackend.com'
        subject: 'SRE Alert: {{ .GroupLabels.alertname }}'
        body: |
          SRE å›¢é˜Ÿå‘Šè­¦:

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          å®ä¾‹: {{ .Labels.instance }}
          ç»„ä»¶: {{ .Labels.component }}
          æè¿°: {{ .Annotations.description }}
          è§¦å‘æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ä¸¥é‡çº§åˆ«: {{ .Labels.severity }}

          æ“ä½œæ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}
    slack_configs:
      - channel: '#sre-alerts'
        title: 'SRE Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Instance:* {{ .Labels.instance }}
          *Component:* {{ .Labels.component }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # æŠ‘åˆ¶ä½çº§åˆ«å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'instance']

  # æŠ‘åˆ¶ç›¸åŒæœåŠ¡çš„é‡å¤å‘Šè­¦
  - source_match:
      team: 'platform'
    target_match:
      team: 'platform'
    equal: ['service', 'alertname']

  # æŠ‘åˆ¶å®ä¾‹çº§åˆ«çš„è¯¦ç»†å‘Šè­¦ï¼ˆå½“æ•´ä¸ªå®ä¾‹ç¦»çº¿æ—¶ï¼‰
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']
