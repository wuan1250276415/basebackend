# Phase 13.3: ä¸šåŠ¡ä¸­å°å»ºè®¾å®æ–½æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•æ„å»ºä¼ä¸šçº§ä¸šåŠ¡ä¸­å°ï¼Œé€šè¿‡DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ–¹æ³•è®ºè¿›è¡Œä¸šåŠ¡å»ºæ¨¡ï¼Œæ²‰æ·€å¯å¤ç”¨çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œæå‡ä¸šåŠ¡æ•æ·æ€§å’Œå“åº”é€Ÿåº¦ï¼Œæ”¯æ’‘ä¸šåŠ¡å¿«é€Ÿåˆ›æ–°å’Œè¿­ä»£ã€‚

---

## ğŸ—ï¸ ä¸šåŠ¡ä¸­å°æ•´ä½“æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡ä¸­å°æ¶æ„è®¾è®¡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   ç”¨æˆ·ä¸­å°    â”‚  â”‚   è®¢å•ä¸­å°    â”‚  â”‚   æ”¯ä»˜ä¸­å°    â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ â€¢ è´¦æˆ·ç®¡ç†     â”‚  â”‚ â€¢ è®¢å•ç®¡ç†     â”‚  â”‚ â€¢ æ”¯ä»˜å¤„ç†     â”‚           â”‚
â”‚  â”‚ â€¢ æƒé™æ§åˆ¶     â”‚  â”‚ â€¢ è®¢å•çŠ¶æ€     â”‚  â”‚ â€¢ å¯¹è´¦ç»“ç®—     â”‚           â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·ç”»åƒ     â”‚  â”‚ â€¢ è®¢å•æµç¨‹     â”‚  â”‚ â€¢ é€€æ¬¾å¤„ç†     â”‚           â”‚
â”‚  â”‚ â€¢ ä¼šå‘˜ä½“ç³»     â”‚  â”‚ â€¢ ç‰©æµè·Ÿè¸ª     â”‚  â”‚ â€¢ é£æ§å®¡æ ¸     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                 â”‚                 â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   å•†å“ä¸­å°    â”‚  â”‚   è¥é”€ä¸­å°    â”‚  â”‚   é€šçŸ¥ä¸­å°    â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ â€¢ å•†å“ç®¡ç†     â”‚  â”‚ â€¢ ä¼˜æƒ åˆ¸     â”‚  â”‚ â€¢ çŸ­ä¿¡é€šçŸ¥     â”‚           â”‚
â”‚  â”‚ â€¢ ç±»ç›®ç®¡ç†     â”‚  â”‚ â€¢ ä¿ƒé”€æ´»åŠ¨     â”‚  â”‚ â€¢ é‚®ä»¶é€šçŸ¥     â”‚           â”‚
â”‚  â”‚ â€¢ ä»·æ ¼ç®¡ç†     â”‚  â”‚ â€¢ ä¼šå‘˜æƒç›Š     â”‚  â”‚ â€¢ æ¨é€é€šçŸ¥     â”‚           â”‚
â”‚  â”‚ â€¢ åº“å­˜ç®¡ç†     â”‚  â”‚ â€¢ åˆ†é”€ä½“ç³»     â”‚  â”‚ â€¢ ç«™å†…æ¶ˆæ¯     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                 â”‚                 â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   æœç´¢ä¸­å°    â”‚  â”‚   æ•°æ®ä¸­å°    â”‚  â”‚   æ—¥å¿—ä¸­å°    â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ â€¢ å…¨æ–‡æœç´¢     â”‚  â”‚ â€¢ æ•°æ®é‡‡é›†     â”‚  â”‚ â€¢ æ—¥å¿—æ”¶é›†     â”‚           â”‚
â”‚  â”‚ â€¢ æ™ºèƒ½æ¨è     â”‚  â”‚ â€¢ æ•°æ®å¤„ç†     â”‚  â”‚ â€¢ æ—¥å¿—åˆ†æ     â”‚           â”‚
â”‚  â”‚ â€¢ æœç´¢æ’åº     â”‚  â”‚ â€¢ æ•°æ®åˆ†æ     â”‚  â”‚ â€¢ æ—¥å¿—æœç´¢     â”‚           â”‚
â”‚  â”‚ â€¢ æœç´¢ç»Ÿè®¡     â”‚  â”‚ â€¢ æ•°æ®å¯è§†åŒ–   â”‚  â”‚ â€¢ å®¡è®¡æ—¥å¿—     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                 â”‚                 â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    åŸºç¡€èƒ½åŠ›å±‚                                 â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ é…ç½®ä¸­å¿ƒ (Nacos)                                            â”‚ â”‚
â”‚  â”‚ â€¢ æ³¨å†Œä¸­å¿ƒ (Nacos)                                            â”‚ â”‚
â”‚  â”‚ â€¢ åˆ†å¸ƒå¼é” (Redis)                                             â”‚ â”‚
â”‚  â”‚ â€¢ æ¶ˆæ¯é˜Ÿåˆ— (Kafka)                                             â”‚ â”‚
â”‚  â”‚ â€¢ åˆ†å¸ƒå¼äº‹åŠ¡ (Seata)                                           â”‚ â”‚
â”‚  â”‚ â€¢ ä»»åŠ¡è°ƒåº¦ (XXL-Job)                                          â”‚ â”‚
â”‚  â”‚ â€¢ ç¼“å­˜ (Redis)                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    åŸºç¡€æŠ€æœ¯å±‚                                 â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ Spring Cloud å¾®æœåŠ¡æ¡†æ¶                                     â”‚ â”‚
â”‚  â”‚ â€¢ MyBatis Plus æ•°æ®åº“è®¿é—®æ¡†æ¶                                  â”‚ â”‚
â”‚  â”‚ â€¢ Elasticsearch æœç´¢å¼•æ“                                      â”‚ â”‚
â”‚  â”‚ â€¢ ClickHouse OLAP æ•°æ®åº“                                      â”‚ â”‚
â”‚  â”‚ â€¢ MinIO å¯¹è±¡å­˜å‚¨                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆé€‰å‹

| å±‚æ¬¡ | æŠ€æœ¯ç»„ä»¶ | ç‰ˆæœ¬ | ç”¨é€” |
|------|----------|------|------|
| **é¢†åŸŸå»ºæ¨¡** | DDD + CQRS | - | é¢†åŸŸé©±åŠ¨è®¾è®¡ |
| **äº‹ä»¶é©±åŠ¨** | Apache Kafka | 3.6.0 | é¢†åŸŸäº‹ä»¶ |
| **æ•°æ®å­˜å‚¨** | MySQL 8.0 | 8.0.35 | ä¸šåŠ¡æ•°æ®åº“ |
| **ç¼“å­˜å±‚** | Redis | 7.2.0 | çƒ­ç‚¹æ•°æ®ç¼“å­˜ |
| **æœç´¢å¼•æ“** | Elasticsearch | 8.11.0 | å…¨æ–‡æœç´¢ |
| **æ•°æ®ä»“åº“** | ClickHouse | 23.12.0 | å®æ—¶åˆ†æ |
| **APIç½‘å…³** | Spring Cloud Gateway | 4.1.0 | ç»Ÿä¸€å…¥å£ |
| **æœåŠ¡æ²»ç†** | Spring Cloud Alibaba | 2022.0.0.0 | æœåŠ¡æ²»ç† |

---

## ğŸ§± DDD é¢†åŸŸé©±åŠ¨è®¾è®¡

### 1. æ ¸å¿ƒæ¦‚å¿µ

#### é¢†åŸŸï¼ˆDomainï¼‰
ä¸šåŠ¡é¢†åŸŸæ˜¯ä¸šåŠ¡ä¸­å°æœåŠ¡çš„æ ¸å¿ƒï¼Œæ¯ä¸ªé¢†åŸŸåŒ…å«ï¼š
- **é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰**ï¼šæ˜ç¡®ä¸šåŠ¡è¾¹ç•Œ
- **èšåˆï¼ˆAggregateï¼‰**ï¼šä¸šåŠ¡ä¸€è‡´æ€§å•å…ƒ
- **èšåˆæ ¹ï¼ˆAggregate Rootï¼‰**ï¼šèšåˆçš„ç®¡ç†è€…
- **é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰**ï¼šè·¨èšåˆçš„ä¸šåŠ¡é€»è¾‘
- **é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰**ï¼šé¢†åŸŸå†…çš„é‡è¦ä¸šåŠ¡äº‹ä»¶

#### é¢†åŸŸæ¶æ„æ¨¡å¼

```java
/**
 * é¢†åŸŸå±‚ - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
 * ä¸ä¾èµ–å¤–éƒ¨æ¡†æ¶ï¼Œçº¯Javaå®ç°
 */
package com.basebackend.domain;

/**
 * èšåˆæ ¹ç¤ºä¾‹ - ç”¨æˆ·
 * è´Ÿè´£ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§å’Œä¸šåŠ¡è§„åˆ™
 */
public class User {
    // èšåˆæ ¹ID
    private UserId id;
    // é¢†åŸŸå±æ€§ï¼ˆä¸å¯å˜ï¼‰
    private final String username;
    private final String email;
    private final PhoneNumber phone;
    private UserStatus status;

    // æ„é€ å‡½æ•°
    public User(UserId id, String username, String email, PhoneNumber phone) {
        // ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
        if (StringUtils.isEmpty(username)) {
            throw new IllegalArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
        if (!EmailValidator.isValid(email)) {
            throw new IllegalArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
        }

        this.id = id;
        this.username = username;
        this.email = email;
        this.phone = phone;
        this.status = UserStatus.ACTIVE;
    }

    // é¢†åŸŸæ–¹æ³• - ä¸šåŠ¡è¡Œä¸º
    public void changeStatus(UserStatus newStatus) {
        // ä¸šåŠ¡è§„åˆ™
        if (this.status == newStatus) {
            return;
        }

        // çŠ¶æ€å˜æ›´éªŒè¯
        if (this.status == UserStatus.DELETED && newStatus != UserStatus.ACTIVE) {
            throw new BusinessException("å·²åˆ é™¤ç”¨æˆ·ä¸èƒ½å˜æ›´çŠ¶æ€");
        }

        this.status = newStatus;

        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        DomainEventPublisher.publish(new UserStatusChangedEvent(this.id, newStatus));
    }

    // ç¦æ­¢å¤–éƒ¨ä¿®æ”¹é¢†åŸŸå±æ€§
    public String getUsername() {
        return username;
    }

    public String getEmail() {
        return email;
    }

    public PhoneNumber getPhone() {
        return phone;
    }

    public UserStatus getStatus() {
        return status;
    }
}

/**
 * å€¼å¯¹è±¡ç¤ºä¾‹ - æ‰‹æœºå·
 * ä¸å¯å˜ï¼Œæ— å”¯ä¸€æ ‡è¯†
 */
public class PhoneNumber {
    private final String number;

    public PhoneNumber(String number) {
        // éªŒè¯æ ¼å¼
        if (!isValidPhoneNumber(number)) {
            throw new IllegalArgumentException("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");
        }
        this.number = number;
    }

    private boolean isValidPhoneNumber(String number) {
        // ç®€å•éªŒè¯ï¼Œå®é™…å¯ä½¿ç”¨æ›´å¤æ‚çš„è§„åˆ™
        return number != null && number.matches("^1[3-9]\\d{9}$");
    }

    @Override
    public String toString() {
        return number;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof PhoneNumber)) return false;
        PhoneNumber that = (PhoneNumber) o;
        return number.equals(that.number);
    }

    @Override
    public int hashCode() {
        return number.hashCode();
    }
}

/**
 * é¢†åŸŸäº‹ä»¶ç¤ºä¾‹
 */
public class UserStatusChangedEvent implements DomainEvent {
    private final UserId userId;
    private final UserStatus newStatus;
    private final DateTime occurredAt;

    public UserStatusChangedEvent(UserId userId, UserStatus newStatus) {
        this.userId = userId;
        this.newStatus = newStatus;
        this.occurredAt = DateTime.now();
    }

    @Override
    public UserId getUserId() {
        return userId;
    }

    public UserStatus getNewStatus() {
        return newStatus;
    }

    @Override
    public DateTime getOccurredAt() {
        return occurredAt;
    }
}
```

#### ä»“å‚¨æ¨¡å¼ï¼ˆRepositoryï¼‰

```java
/**
 * ä»“å‚¨æ¥å£ - é¢†åŸŸå±‚å®šä¹‰
 * æŠ½è±¡æ•°æ®è®¿é—®ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
 */
public interface UserRepository {

    /**
     * æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
     */
    Optional<User> findById(UserId id);

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
     */
    Optional<User> findByUsername(String username);

    /**
     * ä¿å­˜ç”¨æˆ·
     */
    void save(User user);

    /**
     * åˆ é™¤ç”¨æˆ·
     */
    void delete(UserId id);

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    Page<User> findAll(int page, int size);

    /**
     * æ ¹æ®æ¡ä»¶æŸ¥è¯¢
     */
    List<User> findBySpecification(UserSpecification spec);
}
```

#### é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰

```java
/**
 * é¢†åŸŸæœåŠ¡ - å¤„ç†è·¨èšåˆçš„ä¸šåŠ¡é€»è¾‘
 */
public class UserDomainService {

    private final UserRepository userRepository;

    public UserDomainService(UserRepository userRepository) {
        this.userRepository = userRepository;
    }

    /**
     * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨
     */
    public boolean isUsernameAvailable(String username) {
        return userRepository.findByUsername(username).isEmpty();
    }

    /**
     * ç”¨æˆ·æ³¨å†Œ
     * å¤„ç†å¤æ‚çš„æ³¨å†Œæµç¨‹
     */
    public void registerUser(String username, String email, PhoneNumber phone) {
        // ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
        if (!isUsernameAvailable(username)) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
        // æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ
        // ...

        // åˆ›å»ºç”¨æˆ·
        User user = new User(new UserId(), username, email, phone);

        // ä¿å­˜åˆ°ä»“å‚¨
        userRepository.save(user);

        // å‘é€æ³¨å†ŒæˆåŠŸäº‹ä»¶
        DomainEventPublisher.publish(new UserRegisteredEvent(user.getId(), email, phone));
    }

    /**
     * ç”¨æˆ·ç™»å½•
     */
    public LoginResult login(String username, String password) {
        Optional<User> userOpt = userRepository.findByUsername(username);

        if (userOpt.isEmpty()) {
            return LoginResult.failed("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        User user = userOpt.get();

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        if (user.getStatus() != UserStatus.ACTIVE) {
            return LoginResult.failed("ç”¨æˆ·å·²ç¦ç”¨");
        }

        // éªŒè¯å¯†ç 
        if (!PasswordEncoder.matches(password, user.getPasswordHash())) {
            return LoginResult.failed("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        // ç”Ÿæˆç™»å½•token
        String token = generateToken(user);

        return LoginResult.success(token, user);
    }
}
```

### 2. èšåˆè®¾è®¡

#### ç”¨æˆ·èšåˆ

```java
/**
 * ç”¨æˆ·èšåˆ
 * åŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰
 */
public class UserAggregate {

    private UserId userId;
    private UserInfo userInfo;
    private Set<Role> roles;
    private Set<Permission> permissions;
    private UserStatistics statistics;
    private List<LoginLog> loginLogs;

    // èšåˆæ ¹æ–¹æ³•
    public void assignRole(Role role) {
        this.roles.add(role);
        DomainEventPublisher.publish(new UserRoleAssignedEvent(userId, role));
    }

    public void removeRole(RoleId roleId) {
        this.roles.removeIf(role -> role.getId().equals(roleId));
        DomainEventPublisher.publish(new UserRoleRemovedEvent(userId, roleId));
    }

    public void recordLogin(String ipAddress) {
        LoginLog log = new LoginLog(userId, DateTime.now(), ipAddress);
        this.loginLogs.add(log);
        this.statistics.recordLogin();
    }
}
```

#### è®¢å•èšåˆ

```java
/**
 * è®¢å•èšåˆ
 * åŒ…å«è®¢å•ä¸»ä¿¡æ¯ã€è®¢å•é¡¹ã€ç‰©æµä¿¡æ¯ç­‰
 */
public class OrderAggregate {

    private OrderId orderId;
    private OrderNumber orderNumber;
    private UserId userId;
    private OrderStatus status;
    private Money totalAmount;
    private List<OrderItem> items;
    private ShippingAddress shippingAddress;
    private PaymentInfo paymentInfo;
    private LogisticsInfo logisticsInfo;

    // èšåˆæ ¹æ–¹æ³•
    public void confirmOrder() {
        if (this.status != OrderStatus.PENDING) {
            throw new BusinessException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®");
        }

        this.status = OrderStatus.CONFIRMED;
        DomainEventPublisher.publish(new OrderConfirmedEvent(orderId));
    }

    public void cancelOrder() {
        if (this.status == OrderStatus.DELIVERED ||
            this.status == OrderStatus.COMPLETED) {
            throw new BusinessException("è®¢å•å·²å‘è´§æˆ–å®Œæˆï¼Œæ— æ³•å–æ¶ˆ");
        }

        this.status = OrderStatus.CANCELLED;

        // é‡Šæ”¾åº“å­˜
        this.items.forEach(item -> {
            InventoryService.releaseInventory(item.getProductId(), item.getQuantity());
        });

        // é€€æ¬¾
        if (this.paymentInfo != null && this.paymentInfo.isPaid()) {
            PaymentService.refund(this.paymentInfo.getTransactionId(), totalAmount);
        }

        DomainEventPublisher.publish(new OrderCancelledEvent(orderId));
    }

    public void addOrderItem(ProductId productId, int quantity, Money unitPrice) {
        OrderItem item = new OrderItem(productId, quantity, unitPrice);
        this.items.add(item);

        // æ‰£å‡åº“å­˜
        InventoryService.reserveInventory(productId, quantity);

        // é‡æ–°è®¡ç®—æ€»é‡‘é¢
        this.totalAmount = calculateTotalAmount();
    }

    private Money calculateTotalAmount() {
        return items.stream()
            .map(OrderItem::getSubtotal)
            .reduce(Money.ZERO, Money::add);
    }
}
```

### 3. é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†

#### ç”¨æˆ·é¢†åŸŸé™ç•Œä¸Šä¸‹æ–‡

```
ç”¨æˆ·é¢†åŸŸé™ç•Œä¸Šä¸‹æ–‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç®¡ç†è¾¹ç•Œ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  è´¦æˆ·ç®¡ç†    â”‚  â”‚  æƒé™ç®¡ç†    â”‚      â”‚
â”‚  â”‚             â”‚  â”‚             â”‚      â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·æ³¨å†Œ   â”‚  â”‚ â€¢ è§’è‰²å®šä¹‰   â”‚      â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·ç™»å½•   â”‚  â”‚ â€¢ æƒé™åˆ†é…   â”‚      â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯   â”‚  â”‚ â€¢ èµ„æºæ§åˆ¶   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                 â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ä¼šå‘˜ä½“ç³»     â”‚  â”‚  ç”¨æˆ·ç”»åƒ    â”‚     â”‚
â”‚  â”‚             â”‚  â”‚             â”‚     â”‚
â”‚  â”‚ â€¢ ç­‰çº§ç®¡ç†   â”‚  â”‚ â€¢ è¡Œä¸ºåˆ†æ   â”‚     â”‚
â”‚  â”‚ â€¢ ç§¯åˆ†è§„åˆ™   â”‚  â”‚ â€¢ æ ‡ç­¾ç®¡ç†   â”‚     â”‚
â”‚  â”‚ â€¢ æƒç›Šä½“ç³»   â”‚  â”‚ â€¢ åå¥½åˆ†æ   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                         â”‚
â”‚  é¢†åŸŸäº‹ä»¶ï¼š                              â”‚
â”‚  â€¢ UserRegistered                       â”‚
â”‚  â€¢ UserStatusChanged                   â”‚
â”‚  â€¢ UserLoggedIn                        â”‚
â”‚  â€¢ UserRoleChanged                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¢ ä¸šåŠ¡ä¸­å°æ¶æ„è®¾è®¡

### 1. ç”¨æˆ·ä¸­å°

```java
/**
 * ç”¨æˆ·ä¸­å°æ ¸å¿ƒæœåŠ¡
 */
@Service
@Validated
public class UserMiddlePlatformService {

    @Autowired
    private UserDomainService userDomainService;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private EventBus eventBus;

    /**
     * ç”¨æˆ·æ³¨å†Œ
     * æ”¯æŒå¤šç§æ³¨å†Œæ–¹å¼
     */
    @Transactional
    public UserRegisterResult registerUser(UserRegisterRequest request) {
        // 1. å‚æ•°éªŒè¯
        RegisterValidator.validate(request);

        // 2. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
        if (!userDomainService.isUsernameAvailable(request.getUsername())) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // 3. åˆ›å»ºç”¨æˆ·
        PhoneNumber phone = new PhoneNumber(request.getPhone());
        User user = new User(
            new UserId(),
            request.getUsername(),
            request.getEmail(),
            phone
        );

        // 4. ä¿å­˜ç”¨æˆ·
        userRepository.save(user);

        // 5. å‘é€é¢†åŸŸäº‹ä»¶
        eventBus.publish(new UserRegisteredEvent(
            user.getId(),
            request.getEmail(),
            phone
        ));

        // 6. åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
        initializeUserData(user);

        return new UserRegisterResult(user.getId().getValue(), "æ³¨å†ŒæˆåŠŸ");
    }

    /**
     * ç”¨æˆ·ç™»å½•
     */
    @Transactional(readOnly = true)
    public UserLoginResult login(UserLoginRequest request) {
        return userDomainService.login(request.getUsername(), request.getPassword());
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @Transactional(readOnly = true)
    public UserInfoDTO getUserInfo(UserId userId) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));

        return UserInfoMapper.toDTO(user);
    }

    /**
     * æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     */
    @Transactional(readOnly = true)
    public List<UserInfoDTO> batchGetUserInfo(List<UserId> userIds) {
        return userIds.stream()
            .map(this::getUserInfo)
            .collect(Collectors.toList());
    }

    private void initializeUserData(User user) {
        // åˆå§‹åŒ–é»˜è®¤è§’è‰²
        Role defaultRole = RoleRepository.findByCode("USER");
        user.assignRole(defaultRole);

        // åˆå§‹åŒ–ç”¨æˆ·ç”»åƒ
        UserProfile profile = new UserProfile(user.getId());
        UserProfileRepository.save(profile);

        // å‘é€æ¬¢è¿æ¶ˆæ¯
        eventBus.publish(new WelcomeMessageEvent(user.getId(), user.getEmail()));
    }
}

/**
 * ç”¨æˆ·æ³¨å†Œè¯·æ±‚DTO
 */
@Data
@Builder
public class UserRegisterRequest {

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Length(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20å­—ç¬¦ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;

    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    @NotBlank(message = "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    private String phone;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Length(min = 8, max = 20, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨8-20å­—ç¬¦ä¹‹é—´")
    private String password;
}

/**
 * ç”¨æˆ·ä¿¡æ¯DTO
 */
@Data
@Builder
public class UserInfoDTO {

    private String userId;
    private String username;
    private String email;
    private String phone;
    private UserStatus status;
    private List<RoleInfo> roles;
    private UserStatisticsDTO statistics;
    private Date createTime;
    private Date lastLoginTime;
}
```

#### ç”¨æˆ·ä¸­å°APIè®¾è®¡

```java
/**
 * ç”¨æˆ·ä¸­å°API
 */
@RestController
@RequestMapping("/api/middle-platform/user")
@Api(tags = "ç”¨æˆ·ä¸­å°")
@Validated
public class UserMiddlePlatformController {

    @Autowired
    private UserMiddlePlatformService userService;

    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    @ApiOperation("ç”¨æˆ·æ³¨å†Œ")
    public Result<UserRegisterResult> register(@Valid @RequestBody UserRegisterRequest request) {
        UserRegisterResult result = userService.registerUser(request);
        return Result.success(result);
    }

    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/login")
    @ApiOperation("ç”¨æˆ·ç™»å½•")
    public Result<UserLoginResult> login(@Valid @RequestBody UserLoginRequest request) {
        UserLoginResult result = userService.login(request);
        return Result.success(result);
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/{userId}")
    @ApiOperation("è·å–ç”¨æˆ·ä¿¡æ¯")
    public Result<UserInfoDTO> getUserInfo(@PathVariable String userId) {
        UserInfoDTO userInfo = userService.getUserInfo(new UserId(userId));
        return Result.success(userInfo);
    }

    /**
     * æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @PostMapping("/batch")
    @ApiOperation("æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯")
    public Result<List<UserInfoDTO>> batchGetUserInfo(@RequestBody List<String> userIds) {
        List<UserId> ids = userIds.stream()
            .map(UserId::new)
            .collect(Collectors.toList());
        List<UserInfoDTO> result = userService.batchGetUserInfo(ids);
        return Result.success(result);
    }

    /**
     * éªŒè¯ç”¨æˆ·åæ˜¯å¦å¯ç”¨
     */
    @GetMapping("/check-username/{username}")
    @ApiOperation("éªŒè¯ç”¨æˆ·åæ˜¯å¦å¯ç”¨")
    public Result<Boolean> checkUsername(@PathVariable String username) {
        boolean available = userService.isUsernameAvailable(username);
        return Result.success(available);
    }

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
     */
    @GetMapping("/by-username/{username}")
    @ApiOperation("æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·")
    public Result<UserInfoDTO> getUserByUsername(@PathVariable String username) {
        UserInfoDTO userInfo = userService.getUserByUsername(username);
        return Result.success(userInfo);
    }
}
```

### 2. è®¢å•ä¸­å°

```java
/**
 * è®¢å•ä¸­å°æ ¸å¿ƒæœåŠ¡
 */
@Service
@Validated
public class OrderMiddlePlatformService {

    @Autowired
    private OrderRepository orderRepository;

    @Autowired
    private InventoryService inventoryService;

    @Autowired
    private PaymentService paymentService;

    @Autowired
    private EventBus eventBus;

    /**
     * åˆ›å»ºè®¢å•
     */
    @Transactional
    public OrderCreateResult createOrder(OrderCreateRequest request) {
        // 1. éªŒè¯è®¢å•é¡¹
        List<OrderItem> items = validateAndCreateItems(request.getItems());

        // 2. æ£€æŸ¥åº“å­˜
        items.forEach(item -> {
            if (!inventoryService.checkInventory(item.getProductId(), item.getQuantity())) {
                throw new BusinessException("å•†å“åº“å­˜ä¸è¶³: " + item.getProductId());
            }
        });

        // 3. è®¡ç®—è®¢å•æ€»é‡‘é¢
        Money totalAmount = calculateTotalAmount(items);

        // 4. åˆ›å»ºè®¢å•èšåˆ
        OrderAggregate order = new OrderAggregate(
            new OrderId(),
            new OrderNumber(generateOrderNumber()),
            new UserId(request.getUserId()),
            items,
            totalAmount,
            request.getShippingAddress()
        );

        // 5. ä¿å­˜è®¢å•
        orderRepository.save(order);

        // 6. æ‰£å‡åº“å­˜
        items.forEach(item -> {
            inventoryService.reserveInventory(item.getProductId(), item.getQuantity());
        });

        // 7. å‘é€è®¢å•åˆ›å»ºäº‹ä»¶
        eventBus.publish(new OrderCreatedEvent(order.getOrderId()));

        return new OrderCreateResult(order.getOrderId().getValue(), order.getOrderNumber().getValue());
    }

    /**
     * ç¡®è®¤è®¢å•
     */
    @Transactional
    public void confirmOrder(String orderId) {
        OrderAggregate order = findOrder(orderId);
        order.confirmOrder();
        orderRepository.save(order);
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @Transactional
    public void cancelOrder(String orderId, String reason) {
        OrderAggregate order = findOrder(orderId);
        order.cancelOrder();

        // ä¿å­˜è®¢å•
        orderRepository.save(order);

        // å‘é€è®¢å•å–æ¶ˆäº‹ä»¶
        eventBus.publish(new OrderCancelledEvent(order.getOrderId(), reason));
    }

    /**
     * æŸ¥è¯¢è®¢å•
     */
    @Transactional(readOnly = true)
    public OrderInfoDTO getOrderInfo(String orderId) {
        OrderAggregate order = findOrder(orderId);
        return OrderMapper.toDTO(order);
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @Transactional(readOnly = true)
    public Page<OrderInfoDTO> getUserOrders(String userId, int page, int size) {
        PageRequest pageRequest = PageRequest.of(page, size, Sort.by("createTime").descending());
        Page<OrderAggregate> orders = orderRepository.findByUserId(new UserId(userId), pageRequest);

        return orders.map(OrderMapper::toDTO);
    }

    private OrderAggregate findOrder(String orderId) {
        return orderRepository.findById(new OrderId(orderId))
            .orElseThrow(() -> new BusinessException("è®¢å•ä¸å­˜åœ¨"));
    }

    private List<OrderItem> validateAndCreateItems(List<OrderCreateRequest.OrderItem> itemRequests) {
        return itemRequests.stream()
            .map(item -> {
                Product product = ProductRepository.findById(new ProductId(item.getProductId()))
                    .orElseThrow(() -> new BusinessException("å•†å“ä¸å­˜åœ¨: " + item.getProductId()));

                if (!product.isAvailable()) {
                    throw new BusinessException("å•†å“å·²ä¸‹æ¶: " + item.getProductId());
                }

                return new OrderItem(
                    product.getId(),
                    item.getQuantity(),
                    product.getPrice()
                );
            })
            .collect(Collectors.toList());
    }

    private Money calculateTotalAmount(List<OrderItem> items) {
        return items.stream()
            .map(OrderItem::getSubtotal)
            .reduce(Money.ZERO, Money::add);
    }

    private String generateOrderNumber() {
        // æ ¼å¼ï¼šè®¢å•æ—¥æœŸ(8ä½) + åºå·(6ä½)
        String dateStr = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String sequence = String.format("%06d", System.currentTimeMillis() % 1000000);
        return dateStr + sequence;
    }
}

/**
 * è®¢å•èšåˆ
 */
public class OrderAggregate {

    private OrderId orderId;
    private OrderNumber orderNumber;
    private UserId userId;
    private OrderStatus status;
    private Money totalAmount;
    private List<OrderItem> items;
    private ShippingAddress shippingAddress;
    private PaymentInfo paymentInfo;
    private LogisticsInfo logisticsInfo;
    private DateTime createTime;
    private DateTime updateTime;

    // èšåˆæ ¹æ–¹æ³•
    public void confirmOrder() {
        if (this.status != OrderStatus.PENDING) {
            throw new BusinessException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®");
        }

        this.status = OrderStatus.CONFIRMED;
        this.updateTime = DateTime.now();

        // æ‰£å‡åº“å­˜
        this.items.forEach(item -> {
            InventoryService.confirmInventory(item.getProductId(), item.getQuantity());
        });
    }

    public void cancelOrder() {
        if (this.status == OrderStatus.DELIVERED ||
            this.status == OrderStatus.COMPLETED) {
            throw new BusinessException("è®¢å•å·²å‘è´§æˆ–å®Œæˆï¼Œæ— æ³•å–æ¶ˆ");
        }

        this.status = OrderStatus.CANCELLED;
        this.updateTime = DateTime.now();

        // é‡Šæ”¾åº“å­˜
        this.items.forEach(item -> {
            InventoryService.releaseInventory(item.getProductId(), item.getQuantity());
        });
    }
}
```

#### è®¢å•ä¸­å°APIè®¾è®¡

```java
/**
 * è®¢å•ä¸­å°API
 */
@RestController
@RequestMapping("/api/middle-platform/order")
@Api(tags = "è®¢å•ä¸­å°")
@Validated
public class OrderMiddlePlatformController {

    @Autowired
    private OrderMiddlePlatformService orderService;

    /**
     * åˆ›å»ºè®¢å•
     */
    @PostMapping
    @ApiOperation("åˆ›å»ºè®¢å•")
    public Result<OrderCreateResult> createOrder(@Valid @RequestBody OrderCreateRequest request) {
        OrderCreateResult result = orderService.createOrder(request);
        return Result.success(result);
    }

    /**
     * ç¡®è®¤è®¢å•
     */
    @PostMapping("/{orderId}/confirm")
    @ApiOperation("ç¡®è®¤è®¢å•")
    public Result<Void> confirmOrder(@PathVariable String orderId) {
        orderService.confirmOrder(orderId);
        return Result.success();
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/{orderId}/cancel")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public Result<Void> cancelOrder(@PathVariable String orderId,
                                    @RequestParam String reason) {
        orderService.cancelOrder(orderId, reason);
        return Result.success();
    }

    /**
     * æŸ¥è¯¢è®¢å•è¯¦æƒ…
     */
    @GetMapping("/{orderId}")
    @ApiOperation("æŸ¥è¯¢è®¢å•è¯¦æƒ…")
    public Result<OrderInfoDTO> getOrderInfo(@PathVariable String orderId) {
        OrderInfoDTO orderInfo = orderService.getOrderInfo(orderId);
        return Result.success(orderInfo);
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @GetMapping("/user/{userId}")
    @ApiOperation("æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨")
    public Result<Page<OrderInfoDTO>> getUserOrders(
            @PathVariable String userId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        Page<OrderInfoDTO> orders = orderService.getUserOrders(userId, page, size);
        return Result.success(orders);
    }

    /**
     * æ‰¹é‡æŸ¥è¯¢è®¢å•
     */
    @PostMapping("/batch")
    @ApiOperation("æ‰¹é‡æŸ¥è¯¢è®¢å•")
    public Result<List<OrderInfoDTO>> batchGetOrders(@RequestBody List<String> orderIds) {
        List<OrderInfoDTO> orders = orderService.batchGetOrders(orderIds);
        return Result.success(orders);
    }
}
```

### 3. æ”¯ä»˜ä¸­å°

```java
/**
 * æ”¯ä»˜ä¸­å°æ ¸å¿ƒæœåŠ¡
 */
@Service
@Validated
public class PaymentMiddlePlatformService {

    @Autowired
    private PaymentRepository paymentRepository;

    @Autowired
    private PaymentGatewayAdapter paymentGatewayAdapter;

    @Autowired
    private EventBus eventBus;

    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     */
    @Transactional
    public PaymentCreateResult createPayment(PaymentCreateRequest request) {
        // 1. éªŒè¯è®¢å•
        OrderAggregate order = OrderRepository.findById(new OrderId(request.getOrderId()))
            .orElseThrow(() -> new BusinessException("è®¢å•ä¸å­˜åœ¨"));

        // 2. æ£€æŸ¥è®¢å•çŠ¶æ€
        if (order.getStatus() != OrderStatus.CONFIRMED) {
            throw new BusinessException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®");
        }

        // 3. åˆ›å»ºæ”¯ä»˜è®¢å•
        PaymentAggregate payment = new PaymentAggregate(
            new PaymentId(),
            new PaymentNumber(generatePaymentNumber()),
            new OrderId(request.getOrderId()),
            new UserId(request.getUserId()),
            order.getTotalAmount(),
            PaymentMethod.valueOf(request.getPaymentMethod())
        );

        // 4. ä¿å­˜æ”¯ä»˜è®¢å•
        paymentRepository.save(payment);

        // 5. è°ƒç”¨æ”¯ä»˜ç½‘å…³
        PaymentGatewayResponse response = paymentGatewayAdapter.createPayment(
            payment.getPaymentNumber().getValue(),
            order.getTotalAmount(),
            request.getPaymentMethod(),
            request.getCallbackUrl()
        );

        // 6. æ›´æ–°æ”¯ä»˜ä¿¡æ¯
        if (response.isSuccess()) {
            payment.markAsProcessing(response.getGatewayPaymentId());
            paymentRepository.save(payment);
        }

        return new PaymentCreateResult(
            payment.getPaymentId().getValue(),
            response.getPaymentUrl(),
            response.getQrCode()
        );
    }

    /**
     * å¤„ç†æ”¯ä»˜å›è°ƒ
     */
    @Transactional
    public void handlePaymentCallback(PaymentCallbackRequest request) {
        // 1. éªŒè¯å›è°ƒ
        if (!paymentGatewayAdapter.verifyCallback(request)) {
            throw new BusinessException("æ”¯ä»˜å›è°ƒéªŒè¯å¤±è´¥");
        }

        // 2. æŸ¥æ‰¾æ”¯ä»˜è®¢å•
        PaymentAggregate payment = paymentRepository
            .findByGatewayPaymentId(request.getGatewayPaymentId())
            .orElseThrow(() -> new BusinessException("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨"));

        // 3. å¤„ç†æ”¯ä»˜ç»“æœ
        if ("SUCCESS".equals(request.getStatus())) {
            handlePaymentSuccess(payment, request);
        } else if ("FAILED".equals(request.getStatus())) {
            handlePaymentFailed(payment, request);
        }

        paymentRepository.save(payment);
    }

    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
     */
    @Transactional(readOnly = true)
    public PaymentInfoDTO getPaymentInfo(String paymentId) {
        PaymentAggregate payment = paymentRepository.findById(new PaymentId(paymentId))
            .orElseThrow(() -> new BusinessException("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨"));

        return PaymentMapper.toDTO(payment);
    }

    private void handlePaymentSuccess(PaymentAggregate payment, PaymentCallbackRequest request) {
        payment.markAsCompleted();

        // æ›´æ–°è®¢å•çŠ¶æ€
        OrderAggregate order = OrderRepository.findById(payment.getOrderId())
            .orElseThrow(() -> new BusinessException("è®¢å•ä¸å­˜åœ¨"));
        order.markAsPaid();
        OrderRepository.save(order);

        // å‘é€æ”¯ä»˜æˆåŠŸäº‹ä»¶
        eventBus.publish(new PaymentSuccessEvent(
            payment.getPaymentId(),
            payment.getOrderId(),
            payment.getAmount()
        ));
    }

    private void handlePaymentFailed(PaymentAggregate payment, PaymentCallbackRequest request) {
        payment.markAsFailed(request.getFailureReason());

        // å‘é€æ”¯ä»˜å¤±è´¥äº‹ä»¶
        eventBus.publish(new PaymentFailedEvent(
            payment.getPaymentId(),
            payment.getOrderId(),
            request.getFailureReason()
        ));
    }

    private String generatePaymentNumber() {
        String dateStr = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String sequence = String.format("%08d", System.currentTimeMillis() % 100000000);
        return "PAY" + dateStr + sequence;
    }
}

/**
 * æ”¯ä»˜èšåˆ
 */
public class PaymentAggregate {

    private PaymentId paymentId;
    private PaymentNumber paymentNumber;
    private OrderId orderId;
    private UserId userId;
    private Money amount;
    private PaymentMethod paymentMethod;
    private PaymentStatus status;
    private String gatewayPaymentId;
    private String failureReason;
    private DateTime createTime;
    private DateTime updateTime;

    public void markAsProcessing(String gatewayPaymentId) {
        this.status = PaymentStatus.PROCESSING;
        this.gatewayPaymentId = gatewayPaymentId;
        this.updateTime = DateTime.now();
    }

    public void markAsCompleted() {
        this.status = PaymentStatus.COMPLETED;
        this.updateTime = DateTime.now();

        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        DomainEventPublisher.publish(new PaymentCompletedEvent(paymentId, orderId, amount));
    }

    public void markAsFailed(String reason) {
        this.status = PaymentStatus.FAILED;
        this.failureReason = reason;
        this.updateTime = DateTime.now();
    }
}
```

#### æ”¯ä»˜ä¸­å°APIè®¾è®¡

```java
/**
 * æ”¯ä»˜ä¸­å°API
 */
@RestController
@RequestMapping("/api/middle-platform/payment")
@Api(tags = "æ”¯ä»˜ä¸­å°")
@Validated
public class PaymentMiddlePlatformController {

    @Autowired
    private PaymentMiddlePlatformService paymentService;

    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     */
    @PostMapping
    @ApiOperation("åˆ›å»ºæ”¯ä»˜è®¢å•")
    public Result<PaymentCreateResult> createPayment(@Valid @RequestBody PaymentCreateRequest request) {
        PaymentCreateResult result = paymentService.createPayment(request);
        return Result.success(result);
    }

    /**
     * æ”¯ä»˜å›è°ƒ
     */
    @PostMapping("/callback")
    @ApiOperation("æ”¯ä»˜å›è°ƒ")
    public Result<Void> paymentCallback(@RequestBody PaymentCallbackRequest request) {
        paymentService.handlePaymentCallback(request);
        return Result.success();
    }

    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
     */
    @GetMapping("/{paymentId}")
    @ApiOperation("æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€")
    public Result<PaymentInfoDTO> getPaymentInfo(@PathVariable String paymentId) {
        PaymentInfoDTO paymentInfo = paymentService.getPaymentInfo(paymentId);
        return Result.success(paymentInfo);
    }

    /**
     * é€€æ¬¾ç”³è¯·
     */
    @PostMapping("/{paymentId}/refund")
    @ApiOperation("é€€æ¬¾ç”³è¯·")
    public Result<Void> refund(@PathVariable String paymentId, @RequestParam String reason) {
        paymentService.refund(paymentId, reason);
        return Result.success();
    }
}
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. é¢†åŸŸæ¨¡å‹ â†’ æ•°æ®æ¨¡å‹æ˜ å°„

```java
/**
 * ç”¨æˆ·å®ä½“æ˜ å°„
 * é¢†åŸŸæ¨¡å‹ â†’ æ•°æ®æ¨¡å‹
 */
@Entity
@Table(name = "bm_user")
@Data
@EqualsAndHashCode(callSuper = true)
public class UserEntity extends BaseEntity {

    /**
     * ç”¨æˆ·ID
     */
    @Id
    @Column(name = "user_id", nullable = false, length = 32)
    private String userId;

    /**
     * ç”¨æˆ·å
     */
    @Column(name = "username", nullable = false, length = 50, unique = true)
    private String username;

    /**
     * é‚®ç®±
     */
    @Column(name = "email", nullable = false, length = 100)
    private String email;

    /**
     * æ‰‹æœºå·
     */
    @Column(name = "phone", length = 20)
    private String phone;

    /**
     * å¯†ç å“ˆå¸Œ
     */
    @Column(name = "password_hash", nullable = false)
    private String passwordHash;

    /**
     * ç”¨æˆ·çŠ¶æ€
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false, length = 20)
    private UserStatus status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * æœ€åç™»å½•æ—¶é—´
     */
    @Column(name = "last_login_time")
    private LocalDateTime lastLoginTime;

    // æ„é€ å‡½æ•°
    public UserEntity() {
        this.userId = UUID.randomUUID().toString().replace("-", "");
        this.status = UserStatus.ACTIVE;
        this.createTime = LocalDateTime.now();
    }

    /**
     * ä»é¢†åŸŸæ¨¡å‹è½¬æ¢
     */
    public static UserEntity fromDomain(User user) {
        UserEntity entity = new UserEntity();
        entity.userId = user.getId().getValue();
        entity.username = user.getUsername();
        entity.email = user.getEmail();
        entity.phone = user.getPhone().toString();
        entity.passwordHash = user.getPasswordHash();
        entity.status = user.getStatus();
        return entity;
    }

    /**
     * è½¬æ¢ä¸ºé¢†åŸŸæ¨¡å‹
     */
    public User toDomain() {
        User user = new User(
            new UserId(userId),
            username,
            email,
            new PhoneNumber(phone)
        );

        // è®¾ç½®å¯†ç å“ˆå¸Œ
        if (passwordHash != null) {
            user.setPasswordHash(passwordHash);
        }

        return user;
    }
}

/**
 * è®¢å•å®ä½“æ˜ å°„
 */
@Entity
@Table(name = "bm_order")
@Data
@EqualsAndHashCode(callSuper = true)
public class OrderEntity extends BaseEntity {

    /**
     * è®¢å•ID
     */
    @Id
    @Column(name = "order_id", nullable = false, length = 32)
    private String orderId;

    /**
     * è®¢å•å·
     */
    @Column(name = "order_number", nullable = false, length = 32, unique = true)
    private String orderNumber;

    /**
     * ç”¨æˆ·ID
     */
    @Column(name = "user_id", nullable = false, length = 32)
    private String userId;

    /**
     * è®¢å•çŠ¶æ€
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false, length = 20)
    private OrderStatus status;

    /**
     * è®¢å•æ€»é‡‘é¢
     */
    @Column(name = "total_amount", nullable = false, precision = 10, scale = 2)
    private BigDecimal totalAmount;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @Column(name = "create_time", nullable = false)
    private LocalDateTime createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @Column(name = "update_time")
    private LocalDateTime updateTime;

    /**
     * æ”¯ä»˜æ—¶é—´
     */
    @Column(name = "paid_time")
    private LocalDateTime paidTime;

    /**
     * å‘è´§æ—¶é—´
     */
    @Column(name = "shipped_time")
    private LocalDateTime shippedTime;

    /**
     * è®¢å•é¡¹
     */
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<OrderItemEntity> items;

    /**
     * æ”¶è´§åœ°å€
     */
    @Embedded
    private ShippingAddressEntity shippingAddress;
}

/**
 * è®¢å•é¡¹å®ä½“
 */
@Entity
@Table(name = "bm_order_item")
@Data
@EqualsAndHashCode(callSuper = true)
public class OrderItemEntity extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id")
    private OrderEntity order;

    @Column(name = "product_id", nullable = false, length = 32)
    private String productId;

    @Column(name = "product_name", nullable = false, length = 100)
    private String productName;

    @Column(name = "quantity", nullable = false)
    private Integer quantity;

    @Column(name = "unit_price", nullable = false, precision = 10, scale = 2)
    private BigDecimal unitPrice;

    @Column(name = "subtotal", nullable = false, precision = 10, scale = 2)
    private BigDecimal subtotal;
}
```

### 2. æ•°æ®ä»“å‚¨å®ç°

```java
/**
 * ç”¨æˆ·ä»“å‚¨å®ç°
 */
@Repository
public class UserRepositoryImpl implements UserRepository {

    @Autowired
    private UserEntityMapper userEntityMapper;

    @Autowired
    private UserRoleMapper userRoleMapper;

    @Override
    public Optional<User> findById(UserId id) {
        UserEntity entity = userEntityMapper.selectById(id.getValue());
        return Optional.ofNullable(entity).map(this::convertToDomain);
    }

    @Override
    public Optional<User> findByUsername(String username) {
        UserEntity entity = userEntityMapper.selectByUsername(username);
        return Optional.ofNullable(entity).map(this::convertToDomain);
    }

    @Override
    public void save(User user) {
        UserEntity entity = UserEntity.fromDomain(user);

        if (user.getId() == null) {
            // æ–°å¢
            userEntityMapper.insert(entity);
        } else {
            // æ›´æ–°
            entity.setUpdateTime(LocalDateTime.now());
            userEntityMapper.updateById(entity);
        }
    }

    @Override
    public void delete(UserId id) {
        userEntityMapper.deleteById(id.getValue());
    }

    @Override
    public Page<User> findAll(int page, int size) {
        Page<UserEntity> pageRequest = PageRequest.of(page, size,
            Sort.by(Sort.Direction.DESC, "createTime"));
        Page<UserEntity> entityPage = userEntityMapper.selectPage(pageRequest, null);

        return entityPage.map(this::convertToDomain);
    }

    @Override
    public List<User> findBySpecification(UserSpecification spec) {
        UserEntityExample example = new UserEntityExample();
        UserEntityExample.Criteria criteria = example.createCriteria();

        if (spec.hasStatus()) {
            criteria.andStatusEqualTo(spec.getStatus().name());
        }

        if (spec.hasCreateTimeRange()) {
            criteria.andCreateTimeBetween(spec.getStartTime(), spec.getEndTime());
        }

        List<UserEntity> entities = userEntityMapper.selectByExample(example);
        return entities.stream()
            .map(this::convertToDomain)
            .collect(Collectors.toList());
    }

    private User convertToDomain(UserEntity entity) {
        return UserEntity.toDomain(entity);
    }
}
```

### 3. æ•°æ®è®¿é—®å±‚è®¾è®¡

```java
/**
 * ç”¨æˆ·å®ä½“æ˜ å°„å™¨
 */
@Mapper
public interface UserEntityMapper extends BaseMapper<UserEntity> {

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢
     */
    @Select("SELECT * FROM bm_user WHERE username = #{username}")
    UserEntity selectByUsername(@Param("username") String username);

    /**
     * æ ¹æ®é‚®ç®±æŸ¥è¯¢
     */
    @Select("SELECT * FROM bm_user WHERE email = #{email}")
    UserEntity selectByEmail(@Param("email") String email);

    /**
     * æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢
     */
    @Select("SELECT * FROM bm_user WHERE phone = #{phone}")
    UserEntity selectByPhone(@Param("phone") String phone);

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·
     */
    @Select("<script>" +
            "SELECT * FROM bm_user" +
            "<where>" +
            "<if test='status != null'>AND status = #{status}</if>" +
            "<if test='createTimeStart != null'>AND create_time &gt;= #{createTimeStart}</if>" +
            "<if test='createTimeEnd != null'>AND create_time &lt;= #{createTimeEnd}</if>" +
            "</where>" +
            "ORDER BY create_time DESC" +
            "</script>")
    IPage<UserEntity> selectPage(IPage<UserEntity> page,
                                  @Param("status") String status,
                                  @Param("createTimeStart") LocalDateTime startTime,
                                  @Param("createTimeEnd") LocalDateTime endTime);

    /**
     * æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·
     */
    @Select("<script>" +
            "SELECT * FROM bm_user WHERE user_id IN " +
            "<foreach collection='ids' item='id' open='(' separator=',' close=')'>" +
            "#{id}" +
            "</foreach>" +
            "</script>")
    List<UserEntity> selectBatchByIds(@Param("ids") List<String> ids);

    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€
     */
    @Update("UPDATE bm_user SET status = #{status}, update_time = NOW() WHERE user_id = #{userId}")
    int updateStatus(@Param("userId") String userId, @Param("status") String status);

    /**
     * æ›´æ–°æœ€åç™»å½•æ—¶é—´
     */
    @Update("UPDATE bm_user SET last_login_time = NOW() WHERE user_id = #{userId}")
    int updateLastLoginTime(@Param("userId") String userId);
}

/**
 * è®¢å•å®ä½“æ˜ å°„å™¨
 */
@Mapper
public interface OrderEntityMapper extends BaseMapper<OrderEntity> {

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•
     */
    @Select("SELECT * FROM bm_order WHERE user_id = #{userId} ORDER BY create_time DESC")
    IPage<OrderEntity> selectByUserId(IPage<OrderEntity> page, @Param("userId") String userId);

    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢
     */
    @Select("SELECT * FROM bm_order WHERE order_number = #{orderNumber}")
    OrderEntity selectByOrderNumber(@Param("orderNumber") String orderNumber);

    /**
     * æ ¹æ®çŠ¶æ€æŸ¥è¯¢è®¢å•æ•°é‡
     */
    @Select("SELECT COUNT(*) FROM bm_order WHERE status = #{status}")
    int countByStatus(@Param("status") String status);

    /**
     * æ›´æ–°è®¢å•çŠ¶æ€
     */
    @Update("<script>" +
            "UPDATE bm_order SET " +
            "<choose>" +
            "<when test='status == \"PAID\"'>paid_time = NOW(),</when>" +
            "<when test='status == \"SHIPPED\"'>shipped_time = NOW(),</when>" +
            "</choose>" +
            "status = #{status}, update_time = NOW() " +
            "WHERE order_id = #{orderId}" +
            "</script>")
    int updateStatus(@Param("orderId") String orderId, @Param("status") String status);

    /**
     * æŸ¥è¯¢è¿‡æœŸæœªæ”¯ä»˜è®¢å•
     */
    @Select("SELECT * FROM bm_order WHERE status = 'PENDING' AND create_time < #{expireTime}")
    List<OrderEntity> selectExpiredUnpaidOrders(@Param("expireTime") LocalDateTime expireTime);
}

/**
 * ç”¨æˆ·è§’è‰²å…³è”æ˜ å°„å™¨
 */
@Mapper
public interface UserRoleMapper {

    /**
     * æŸ¥è¯¢ç”¨æˆ·è§’è‰²
     */
    @Select("SELECT r.* FROM bm_role r " +
            "JOIN bm_user_role ur ON r.role_id = ur.role_id " +
            "WHERE ur.user_id = #{userId}")
    List<RoleEntity> selectRolesByUserId(@Param("userId") String userId);

    /**
     * åˆ†é…è§’è‰²
     */
    @Insert("INSERT INTO bm_user_role (user_id, role_id, create_time) VALUES (#{userId}, #{roleId}, NOW())")
    int assignRole(@Param("userId") String userId, @Param("roleId") String roleId);

    /**
     * ç§»é™¤è§’è‰²
     */
    @Delete("DELETE FROM bm_user_role WHERE user_id = #{userId} AND role_id = #{roleId}")
    int removeRole(@Param("userId") String userId, @Param("roleId") String roleId);

    /**
     * æ¸…ç©ºç”¨æˆ·æ‰€æœ‰è§’è‰²
     */
    @Delete("DELETE FROM bm_user_role WHERE user_id = #{userId}")
    int clearUserRoles(@Param("userId") String userId);
}
```

---

## ğŸ”Œ ä¸­å°æœåŠ¡é—´é›†æˆ

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„

```java
/**
 * é¢†åŸŸäº‹ä»¶å‘å¸ƒå™¨
 */
@Component
public class DomainEventPublisher {

    private static final EventBus EVENT_BUS = new EventBus();

    /**
     * å‘å¸ƒé¢†åŸŸäº‹ä»¶
     */
    public static void publish(DomainEvent event) {
        EVENT_BUS.post(event);
    }

    /**
     * å¼‚æ­¥å‘å¸ƒé¢†åŸŸäº‹ä»¶
     */
    public static void publishAsync(DomainEvent event) {
        CompletableFuture.runAsync(() -> publish(event));
    }

    /**
     * è®¢é˜…é¢†åŸŸäº‹ä»¶
     */
    public static void subscribe(Object subscriber) {
        EVENT_BUS.register(subscriber);
    }
}

/**
 * é¢†åŸŸäº‹ä»¶å¤„ç†å™¨
 */
@Component
public class DomainEventHandler {

    @Autowired
    private NotificationService notificationService;

    @Autowired
    private UserProfileService userProfileService;

    @Autowired
    private StatisticsService statisticsService;

    /**
     * å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶
     */
    @Subscribe
    public void handleUserRegistered(UserRegisteredEvent event) {
        // å‘é€æ¬¢è¿é‚®ä»¶
        notificationService.sendWelcomeEmail(event.getUserId(), event.getEmail());

        // åˆ›å»ºç”¨æˆ·ç”»åƒ
        userProfileService.createProfile(event.getUserId());

        // ç»Ÿè®¡æŒ‡æ ‡
        statisticsService.incrementUserRegisteredCount();
    }

    /**
     * å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶
     */
    @Subscribe
    public void handleOrderCreated(OrderCreatedEvent event) {
        // é¢„å åº“å­˜
        inventoryService.confirmReservation(event.getOrderId());

        // å‘é€è®¢å•ç¡®è®¤çŸ­ä¿¡
        notificationService.sendOrderCreatedSMS(event.getUserId(), event.getOrderId());

        // ç»Ÿè®¡æŒ‡æ ‡
        statisticsService.incrementOrderCreatedCount(event.getAmount());
    }

    /**
     * å¤„ç†æ”¯ä»˜æˆåŠŸäº‹ä»¶
     */
    @Subscribe
    public void handlePaymentSuccess(PaymentSuccessEvent event) {
        // æ›´æ–°è®¢å•çŠ¶æ€
        OrderAggregate order = OrderRepository.findById(event.getOrderId())
            .orElseThrow(() -> new BusinessException("è®¢å•ä¸å­˜åœ¨"));
        order.markAsPaid();
        OrderRepository.save(order);

        // æ‰£å‡åº“å­˜
        inventoryService.deductInventory(event.getOrderId());

        // å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥
        notificationService.sendPaymentSuccessSMS(event.getUserId(), event.getAmount());

        // ä¼šå‘˜ç§¯åˆ†å¥–åŠ±
        userProfileService.addPoints(event.getUserId(), event.getAmount().getValue().intValue() / 10);
    }
}
```

### 2. é˜²è…å±‚è®¾è®¡

```java
/**
 * é˜²è…å±‚ - é€‚é…å¤–éƒ¨ç³»ç»Ÿ
 */
@Component
public class ExternalSystemAdapter {

    @Autowired
    private InventoryFeignClient inventoryFeignClient;

    @Autowired
    private ProductFeignClient productFeignClient;

    @Autowired
    private LogisticsFeignClient logisticsFeignClient;

    /**
     * æŸ¥è¯¢å•†å“ä¿¡æ¯
     */
    public ProductInfo queryProduct(String productId) {
        try {
            ProductFeignResponse response = productFeignClient.getProduct(productId);

            if (response.isSuccess()) {
                return ProductInfo.builder()
                    .productId(response.getData().getProductId())
                    .productName(response.getData().getProductName())
                    .price(response.getData().getPrice())
                    .stock(response.getData().getStock())
                    .isAvailable(response.getData().getStock() > 0)
                    .build();
            } else {
                throw new BusinessException("æŸ¥è¯¢å•†å“ä¿¡æ¯å¤±è´¥: " + response.getMessage());
            }
        } catch (Exception e) {
            // é™çº§å¤„ç†
            log.warn("æŸ¥è¯¢å•†å“ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®", e);
            return getProductFromCache(productId);
        }
    }

    /**
     * æ‰£å‡åº“å­˜
     */
    public boolean deductInventory(String productId, int quantity) {
        try {
            InventoryDeductRequest request = new InventoryDeductRequest();
            request.setProductId(productId);
            request.setQuantity(quantity);

            InventoryFeignResponse response = inventoryFeignClient.deductInventory(request);

            return response.isSuccess();
        } catch (Exception e) {
            log.error("æ‰£å‡åº“å­˜å¤±è´¥", e);
            return false;
        }
    }

    /**
     * åˆ›å»ºç‰©æµè®¢å•
     */
    public LogisticsInfo createLogisticsOrder(LogisticsCreateRequest request) {
        try {
            LogisticsFeignResponse response = logisticsFeignClient.createOrder(request);

            if (response.isSuccess()) {
                return LogisticsInfo.builder()
                    .logisticsId(response.getData().getLogisticsId())
                    .trackingNumber(response.getData().getTrackingNumber())
                    .company(response.getData().getCompany())
                    .estimatedDeliveryTime(response.getData().getEstimatedDeliveryTime())
                    .build();
            } else {
                throw new BusinessException("åˆ›å»ºç‰©æµè®¢å•å¤±è´¥: " + response.getMessage());
            }
        } catch (Exception e) {
            log.error("åˆ›å»ºç‰©æµè®¢å•å¤±è´¥", e);
            throw new BusinessException("ç‰©æµæœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    private ProductInfo getProductFromCache(String productId) {
        // ä»ç¼“å­˜è·å–å•†å“ä¿¡æ¯
        return RedisCache.get("product:" + productId, ProductInfo.class);
    }
}

/**
 * é˜²è…å±‚æ‹¦æˆªå™¨
 * é˜²æ­¢å¤–éƒ¨ç³»ç»Ÿå˜åŒ–å½±å“æ ¸å¿ƒé¢†åŸŸ
 */
@Around("execution(* com.basebackend.application.service..*Service.*(..))")
public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
    // è®°å½•è°ƒç”¨å¼€å§‹æ—¶é—´
    long startTime = System.currentTimeMillis();

    try {
        // å‚æ•°æ ¡éªŒ
        validateParameters(joinPoint.getArgs());

        // æ‰§è¡Œç›®æ ‡æ–¹æ³•
        Object result = joinPoint.proceed();

        // è®°å½•æˆåŠŸæ—¥å¿—
        log.info("æ–¹æ³•è°ƒç”¨æˆåŠŸ: {}, è€—æ—¶: {}ms",
            joinPoint.getSignature().getName(),
            System.currentTimeMillis() - startTime);

        return result;
    } catch (Exception e) {
        // è®°å½•é”™è¯¯æ—¥å¿—
        log.error("æ–¹æ³•è°ƒç”¨å¤±è´¥: {}, é”™è¯¯: {}",
            joinPoint.getSignature().getName(),
            e.getMessage(), e);

        throw e;
    }
}
```

### 3. APIç½‘å…³é›†æˆ

```java
/**
 * ä¸­å°æœåŠ¡ç½‘å…³è·¯ç”±é…ç½®
 */
@Configuration
public class MiddlePlatformGatewayConfig {

    @Bean
    public RouteLocator middlePlatformRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            // ç”¨æˆ·ä¸­å°è·¯ç”±
            .route("user-middle-platform", r -> r
                .path("/api/middle-platform/user/**")
                .filters(f -> f.stripPrefix(3))
                .uri("lb://user-middle-platform"))

            // è®¢å•ä¸­å°è·¯ç”±
            .route("order-middle-platform", r -> r
                .path("/api/middle-platform/order/**")
                .filters(f -> f.stripPrefix(3))
                .uri("lb://order-middle-platform"))

            // æ”¯ä»˜ä¸­å°è·¯ç”±
            .route("payment-middle-platform", r -> r
                .path("/api/middle-platform/payment/**")
                .filters(f -> f.stripPrefix(3))
                .uri("lb://payment-middle-platform"))

            // å•†å“ä¸­å°è·¯ç”±
            .route("product-middle-platform", r -> r
                .path("/api/middle-platform/product/**")
                .filters(f -> f.stripPrefix(3))
                .uri("lb://product-middle-platform"))

            // è¥é”€ä¸­å°è·¯ç”±
            .route("promotion-middle-platform", r -> r
                .path("/api/middle-platform/promotion/**")
                .filters(f -> f.stripPrefix(3))
                .uri("lb://promotion-middle-platform"))

            // é€šçŸ¥ä¸­å°è·¯ç”±
            .route("notification-middle-platform", r -> r
                .path("/api/middle-platform/notification/**")
                .filters(f -> f.stripPrefix(3))
                .uri("lb://notification-middle-platform"))

            .build();
    }

    /**
     * å…¨å±€é™æµé…ç½®
     */
    @Bean
    public KeyResolver userIdKeyResolver() {
        return exchange -> Mono.justOrEmpty(
            exchange.getRequest().getHeaders().getFirst("X-User-Id")
        );
    }
}

/**
 * ä¸­å°æœåŠ¡è´Ÿè½½å‡è¡¡é…ç½®
 */
@Configuration
public class MiddlePlatformLoadBalancerConfig {

    /**
     * ç”¨æˆ·ä¸­å°æœåŠ¡é…ç½®
     */
    @LoadBalancerClient(name = "user-middle-platform",
        configuration = UserMiddlePlatformLoadBalancerConfig.class)
    public interface UserMiddlePlatformLoadBalancerConfig {

    }

    @Bean
    public ServiceInstanceListSupplier discoveryClientServiceInstanceListSupplier(
            ConfigurableApplicationContext context) {
        return ServiceInstanceListSupplier.builder()
            .withDnsRoundRobinInDiscovery()
            .withSameInstanceReplicaServiceFilter()
            .build(context);
    }
}
```

---

## ğŸ“± æœç´¢ä¸­å°

### 1. æœç´¢å¼•æ“æœåŠ¡

```java
/**
 * æœç´¢ä¸­å°æ ¸å¿ƒæœåŠ¡
 */
@Service
@Validated
public class SearchMiddlePlatformService {

    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;

    @Autowired
    private SearchIndexManager searchIndexManager;

    /**
     * åˆ›å»ºæœç´¢ç´¢å¼•
     */
    public void createIndex(String indexName, SearchIndexConfig config) {
        searchIndexManager.createIndex(indexName, config);
    }

    /**
     * ç´¢å¼•å•†å“
     */
    @Transactional
    public void indexProduct(ProductInfo product) {
        try {
            // æ„å»ºç´¢å¼•æ–‡æ¡£
            ProductSearchDocument document = ProductSearchDocument.builder()
                .productId(product.getProductId())
                .productName(product.getProductName())
                .categoryId(product.getCategoryId())
                .categoryName(product.getCategoryName())
                .brand(product.getBrand())
                .price(product.getPrice())
                .description(product.getDescription())
                .tags(product.getTags())
                .searchKeywords(generateSearchKeywords(product))
                .build();

            // ç´¢å¼•åˆ°ES
            elasticsearchTemplate.save(document, "products");

        } catch (Exception e) {
            log.error("ç´¢å¼•å•†å“å¤±è´¥: {}", product.getProductId(), e);
            throw new BusinessException("æœç´¢ç´¢å¼•å¤±è´¥");
        }
    }

    /**
     * æœç´¢å•†å“
     */
    @Transactional(readOnly = true)
    public SearchResult<ProductSearchResult> searchProducts(SearchRequest request) {
        try {
            // æ„å»ºæŸ¥è¯¢æ¡ä»¶
            BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery();

            // å…³é”®è¯æœç´¢
            if (StringUtils.hasText(request.getKeyword())) {
                queryBuilder.should(QueryBuilders.matchQuery("productName", request.getKeyword()));
                queryBuilder.should(QueryBuilders.matchQuery("description", request.getKeyword()));
                queryBuilder.should(QueryBuilders.termQuery("tags", request.getKeyword()));
            }

            // åˆ†ç±»è¿‡æ»¤
            if (StringUtils.hasText(request.getCategoryId())) {
                queryBuilder.filter(QueryBuilders.termQuery("categoryId", request.getCategoryId()));
            }

            // ä»·æ ¼åŒºé—´è¿‡æ»¤
            if (request.getMinPrice() != null || request.getMaxPrice() != null) {
                RangeQueryBuilder priceQuery = QueryBuilders.rangeQuery("price");
                if (request.getMinPrice() != null) {
                    priceQuery.gte(request.getMinPrice());
                }
                if (request.getMaxPrice() != null) {
                    priceQuery.lte(request.getMaxPrice());
                }
                queryBuilder.filter(priceQuery);
            }

            // æ„å»ºæœç´¢æº
            SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
            searchSourceBuilder.query(queryBuilder);

            // åˆ†é¡µ
            searchSourceBuilder.from(request.getPage() * request.getSize());
            searchSourceBuilder.size(request.getSize());

            // æ’åº
            if (StringUtils.hasText(request.getSortBy())) {
                SortOrder sortOrder = request.getSortOrder() != null ?
                    request.getSortOrder() : SortOrder.DESC;
                searchSourceBuilder.sort(request.getSortBy(), sortOrder);
            } else {
                searchSourceBuilder.sort("_score", SortOrder.DESC);
            }

            // é«˜äº®æ˜¾ç¤º
            HighlightBuilder highlightBuilder = new HighlightBuilder();
            highlightBuilder.field("productName");
            highlightBuilder.field("description");
            highlightBuilder.preTags("<font color='red'>");
            highlightBuilder.postTags("</font>");
            searchSourceBuilder.highlighter(highlightBuilder);

            // æ‰§è¡Œæœç´¢
            SearchRequest searchRequest = new SearchRequest("products");
            searchRequest.source(searchSourceBuilder);

            SearchResponse response = elasticsearchTemplate.search(searchRequest, RequestOptions.DEFAULT);

            // è§£æç»“æœ
            return parseSearchResponse(response, request);

        } catch (Exception e) {
            log.error("æœç´¢å•†å“å¤±è´¥", e);
            throw new BusinessException("æœç´¢æœåŠ¡å¼‚å¸¸");
        }
    }

    /**
     * æ™ºèƒ½æ¨è
     */
    @Transactional(readOnly = true)
    public List<ProductSearchResult> recommendProducts(String userId, int size) {
        try {
            // è·å–ç”¨æˆ·å†å²æµè§ˆè®°å½•
            List<String> historyProducts = getUserBrowseHistory(userId);

            // åŸºäºç”¨æˆ·ç”»åƒçš„æ¨è
            UserProfile userProfile = getUserProfile(userId);

            BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery();

            // æ¨èç›¸ä¼¼å•†å“
            if (!historyProducts.isEmpty()) {
                queryBuilder.should(QueryBuilders.termsQuery("productId", historyProducts));
            }

            // åŸºäºç”¨æˆ·åå¥½çš„æ¨è
            if (userProfile != null && userProfile.hasPreferences()) {
                queryBuilder.should(QueryBuilders.termsQuery("categoryId", userProfile.getFavoriteCategories()));
                queryBuilder.should(QueryBuilders.termsQuery("brand", userProfile.getFavoriteBrands()));
            }

            SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
            searchSourceBuilder.query(queryBuilder);
            searchSourceBuilder.size(size);

            SearchRequest searchRequest = new SearchRequest("products");
            searchRequest.source(searchSourceBuilder);

            SearchResponse response = elasticsearchTemplate.search(searchRequest, RequestOptions.DEFAULT);

            return parseRecommendResponse(response);

        } catch (Exception e) {
            log.error("å•†å“æ¨èå¤±è´¥", e);
            return Collections.emptyList();
        }
    }

    /**
     * æœç´¢ç»Ÿè®¡
     */
    @Transactional(readOnly = true)
    public SearchStatistics getSearchStatistics() {
        try {
            // æœç´¢é‡ç»Ÿè®¡
            long todaySearchCount = getTodaySearchCount();
            long weekSearchCount = getWeekSearchCount();
            long monthSearchCount = getMonthSearchCount();

            // çƒ­é—¨æœç´¢è¯
            List<SearchKeywordStats> hotKeywords = getHotKeywords(10);

            // çƒ­é—¨åˆ†ç±»
            List<CategoryStats> hotCategories = getHotCategories(10);

            // çƒ­é—¨å•†å“
            List<ProductStats> hotProducts = getHotProducts(10);

            return SearchStatistics.builder()
                .todaySearchCount(todaySearchCount)
                .weekSearchCount(weekSearchCount)
                .monthSearchCount(monthSearchCount)
                .hotKeywords(hotKeywords)
                .hotCategories(hotCategories)
                .hotProducts(hotProducts)
                .build();

        } catch (Exception e) {
            log.error("è·å–æœç´¢ç»Ÿè®¡å¤±è´¥", e);
            return SearchStatistics.builder().build();
        }
    }

    private SearchResult<ProductSearchResult> parseSearchResponse(SearchResponse response,
                                                                   SearchRequest request) {
        List<ProductSearchResult> results = new ArrayList<>();

        for (SearchHit hit : response.getHits().getHits()) {
            try {
                ProductSearchDocument document = JSON.parseObject(
                    hit.getSourceAsString(),
                    ProductSearchDocument.class
                );

                ProductSearchResult result = ProductSearchResult.builder()
                    .productId(document.getProductId())
                    .productName(document.getProductName())
                    .categoryName(document.getCategoryName())
                    .brand(document.getBrand())
                    .price(document.getPrice())
                    .description(document.getDescription())
                    .tags(document.getTags())
                    .score(hit.getScore())
                    .build();

                // é«˜äº®æ˜¾ç¤º
                if (hit.getHighlightFields() != null) {
                    Highlight productNameHighlight = hit.getHighlightFields().get("productName");
                    if (productNameHighlight != null && !productNameHighlight.getFragments().isEmpty()) {
                        result.setProductNameHighlight(productNameHighlight.getFragments().get(0).string());
                    }

                    Highlight descHighlight = hit.getHighlightFields().get("description");
                    if (descHighlight != null && !descHighlight.getFragments().isEmpty()) {
                        result.setDescriptionHighlight(descHighlight.getFragments().get(0).string());
                    }
                }

                results.add(result);

            } catch (Exception e) {
                log.warn("è§£ææœç´¢ç»“æœå¤±è´¥", e);
            }
        }

        return SearchResult.<ProductSearchResult>builder()
            .total(response.getHits().getTotalHits().value)
            .results(results)
            .page(request.getPage())
            .size(request.getSize())
            .build();
    }
}
```

### 2. æœç´¢ä¸­å°API

```java
/**
 * æœç´¢ä¸­å°API
 */
@RestController
@RequestMapping("/api/middle-platform/search")
@Api(tags = "æœç´¢ä¸­å°")
@Validated
public class SearchMiddlePlatformController {

    @Autowired
    private SearchMiddlePlatformService searchService;

    /**
     * æœç´¢å•†å“
     */
    @PostMapping("/products")
    @ApiOperation("æœç´¢å•†å“")
    public Result<SearchResult<ProductSearchResult>> searchProducts(
            @Valid @RequestBody SearchRequest request) {
        SearchResult<ProductSearchResult> result = searchService.searchProducts(request);
        return Result.success(result);
    }

    /**
     * æ™ºèƒ½æ¨è
     */
    @GetMapping("/recommend")
    @ApiOperation("æ™ºèƒ½æ¨è")
    public Result<List<ProductSearchResult>> recommendProducts(
            @RequestParam String userId,
            @RequestParam(defaultValue = "10") int size) {
        List<ProductSearchResult> result = searchService.recommendProducts(userId, size);
        return Result.success(result);
    }

    /**
     * æœç´¢ç»Ÿè®¡
     */
    @GetMapping("/statistics")
    @ApiOperation("æœç´¢ç»Ÿè®¡")
    public Result<SearchStatistics> getSearchStatistics() {
        SearchStatistics result = searchService.getSearchStatistics();
        return Result.success(result);
    }

    /**
     * è·å–æœç´¢å»ºè®®
     */
    @GetMapping("/suggestions")
    @ApiOperation("è·å–æœç´¢å»ºè®®")
    public Result<List<String>> getSearchSuggestions(
            @RequestParam String keyword,
            @RequestParam(defaultValue = "10") int size) {
        List<String> suggestions = searchService.getSearchSuggestions(keyword, size);
        return Result.success(suggestions);
    }

    /**
     * ç´¢å¼•å•†å“
     */
    @PostMapping("/index/product")
    @ApiOperation("ç´¢å¼•å•†å“")
    public Result<Void> indexProduct(@Valid @RequestBody ProductInfo product) {
        searchService.indexProduct(product);
        return Result.success();
    }

    /**
     * æ‰¹é‡ç´¢å¼•å•†å“
     */
    @PostMapping("/index/product/batch")
    @ApiOperation("æ‰¹é‡ç´¢å¼•å•†å“")
    public Result<Void> batchIndexProducts(@Valid @RequestBody List<ProductInfo> products) {
        products.forEach(searchService::indexProduct);
        return Result.success();
    }
}
```

---

## ğŸ” æƒé™ä¸å®‰å…¨

### 1. æƒé™ä¸­å°

```java
/**
 * æƒé™ä¸­å°æ ¸å¿ƒæœåŠ¡
 */
@Service
@Validated
public class PermissionMiddlePlatformService {

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private PermissionRepository permissionRepository;

    @Autowired
    private UserRepository userRepository;

    /**
     * åˆ›å»ºè§’è‰²
     */
    @Transactional
    public RoleId createRole(RoleCreateRequest request) {
        // æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨
        if (roleRepository.existsByName(request.getName())) {
            throw new BusinessException("è§’è‰²åç§°å·²å­˜åœ¨");
        }

        Role role = new Role(
            new RoleId(),
            request.getName(),
            request.getDescription(),
            request.getPermissions()
        );

        roleRepository.save(role);

        return role.getId();
    }

    /**
     * åˆ†é…è§’è‰²æƒé™
     */
    @Transactional
    public void assignRolePermissions(String roleId, List<String> permissionIds) {
        Role role = roleRepository.findById(new RoleId(roleId))
            .orElseThrow(() -> new BusinessException("è§’è‰²ä¸å­˜åœ¨"));

        List<Permission> permissions = permissionRepository.findByIds(
            permissionIds.stream()
                .map(PermissionId::new)
                .collect(Collectors.toList())
        );

        role.setPermissions(permissions);
        roleRepository.save(role);

        // æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
        clearUserPermissionCache(roleId);
    }

    /**
     * æ£€æŸ¥ç”¨æˆ·æƒé™
     */
    @Transactional(readOnly = true)
    public boolean hasPermission(String userId, String permissionCode) {
        // ä»ç¼“å­˜è·å–ç”¨æˆ·æƒé™
        Set<String> userPermissions = getUserPermissionCache(userId);

        if (userPermissions.contains(permissionCode)) {
            return true;
        }

        // ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        List<Permission> permissions = permissionRepository.findByUserId(new UserId(userId));

        Set<String> permissionCodes = permissions.stream()
            .map(Permission::getCode)
            .collect(Collectors.toSet());

        // ç¼“å­˜æƒé™
        setUserPermissionCache(userId, permissionCodes);

        return permissionCodes.contains(permissionCode);
    }

    /**
     * è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
     */
    @Transactional(readOnly = true)
    public Set<String> getUserPermissions(String userId) {
        Set<String> cachedPermissions = getUserPermissionCache(userId);

        if (!cachedPermissions.isEmpty()) {
            return cachedPermissions;
        }

        List<Permission> permissions = permissionRepository.findByUserId(new UserId(userId));

        Set<String> permissionCodes = permissions.stream()
            .map(Permission::getCode)
            .collect(Collectors.toSet());

        setUserPermissionCache(userId, permissionCodes);

        return permissionCodes;
    }

    /**
     * æ£€æŸ¥ç”¨æˆ·è§’è‰²
     */
    @Transactional(readOnly = true)
    public boolean hasRole(String userId, String roleName) {
        return roleRepository.existsByUserIdAndRoleName(new UserId(userId), roleName);
    }

    private Set<String> getUserPermissionCache(String userId) {
        String cacheKey = "user:permissions:" + userId;
        return RedisCache.get(cacheKey, Set.class);
    }

    private void setUserPermissionCache(String userId, Set<String> permissions) {
        String cacheKey = "user:permissions:" + userId;
        RedisCache.set(cacheKey, permissions, Duration.ofHours(1));
    }

    private void clearUserPermissionCache(String roleId) {
        // æŸ¥æ‰¾æ‰€æœ‰æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·ï¼Œæ¸…é™¤æƒé™ç¼“å­˜
        List<UserId> userIds = roleRepository.findUserIdsByRoleId(new RoleId(roleId));
        userIds.forEach(userId -> {
            String cacheKey = "user:permissions:" + userId.getValue();
            RedisCache.delete(cacheKey);
        });
    }
}

/**
 * æƒé™æ ¡éªŒæ³¨è§£
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {

    /**
     * æƒé™ä»£ç 
     */
    String value();

    /**
     * æ˜¯å¦éœ€è¦æ‰€æœ‰æƒé™
     */
    boolean all() default false;
}

/**
 * æƒé™æ ¡éªŒåˆ‡é¢
 */
@Aspect
@Component
public class PermissionInterceptor {

    @Autowired
    private PermissionMiddlePlatformService permissionService;

    @Around("@annotation(requirePermission)")
    public Object around(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable {
        // ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ID
        String userId = RequestContextHolder.getRequestHeader("X-User-Id");

        if (StringUtils.isEmpty(userId)) {
            throw new UnauthorizedException("æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯");
        }

        // æ ¡éªŒæƒé™
        boolean hasPermission = permissionService.hasPermission(userId, requirePermission.value());

        if (!hasPermission) {
            throw new ForbiddenException("æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ");
        }

        return joinPoint.proceed();
    }
}
```

---

## ğŸ“Š ä¸­å°ç›‘æ§ä¸ç»Ÿè®¡

### 1. ä¸šåŠ¡ç›‘æ§

```java
/**
 * ä¸­å°ä¸šåŠ¡ç›‘æ§æœåŠ¡
 */
@Service
public class MiddlePlatformMonitoringService {

    @Autowired
    private MeterRegistry meterRegistry;

    @Autowired
    private TagCounter counter;

    /**
     * è®°å½•ä¸šåŠ¡æŒ‡æ ‡
     */
    public void recordBusinessMetric(String metricName, String dimension, long value) {
        counter.increment(metricName, dimension, value);
    }

    /**
     * è®°å½•ç”¨æˆ·æ³¨å†Œ
     */
    public void recordUserRegistered(String channel) {
        meterRegistry.counter("user.registered.total", "channel", channel).increment();
    }

    /**
     * è®°å½•è®¢å•åˆ›å»º
     */
    public void recordOrderCreated(String orderType, BigDecimal amount) {
        meterRegistry.counter("order.created.total", "orderType", orderType).increment();
        meterRegistry.counter("order.created.amount", "orderType", orderType).increment(amount.doubleValue());
    }

    /**
     * è®°å½•æ”¯ä»˜
     */
    public void recordPayment(String paymentMethod, String status, BigDecimal amount) {
        meterRegistry.counter("payment.total", "method", paymentMethod, "status", status).increment();
        meterRegistry.counter("payment.amount", "method", paymentMethod, "status", status).increment(amount.doubleValue());
    }

    /**
     * è®°å½•æœç´¢
     */
    public void recordSearch(String keyword, String categoryId, long resultCount) {
        meterRegistry.counter("search.total", "categoryId", categoryId).increment();
        meterRegistry.counter("search.resultCount", "categoryId", categoryId, "resultCount", String.valueOf(resultCount)).increment();
    }

    /**
     * è·å–å®æ—¶ç»Ÿè®¡æ•°æ®
     */
    @Transactional(readOnly = true)
    public RealtimeStats getRealtimeStats() {
        LocalDateTime todayStart = LocalDate.now().atStartOfDay();
        LocalDateTime now = LocalDateTime.now();

        return RealtimeStats.builder()
            .userRegisteredCount(getTodayUserRegisteredCount(todayStart, now))
            .orderCreatedCount(getTodayOrderCreatedCount(todayStart, now))
            .paymentAmount(getTodayPaymentAmount(todayStart, now))
            .searchCount(getTodaySearchCount(todayStart, now))
            .build();
    }

    /**
     * ç”Ÿæˆä¸šåŠ¡æŠ¥è¡¨
     */
    @Transactional(readOnly = true)
    public BusinessReport generateBusinessReport(DateRange range) {
        LocalDateTime startTime = range.getStartTime();
        LocalDateTime endTime = range.getEndTime();

        return BusinessReport.builder()
            .userStats(getUserStats(startTime, endTime))
            .orderStats(getOrderStats(startTime, endTime))
            .paymentStats(getPaymentStats(startTime, endTime))
            .revenueStats(getRevenueStats(startTime, endTime))
            .userRetentionStats(getUserRetentionStats(startTime, endTime))
            .conversionStats(getConversionStats(startTime, endTime))
            .build();
    }
}
```

---

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•

### DDDé¢†åŸŸå»ºæ¨¡
- [ ] é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†å®Œæˆ
- [ ] èšåˆæ ¹è®¾è®¡å®Œæˆ
- [ ] é¢†åŸŸäº‹ä»¶å®šä¹‰å®Œæˆ
- [ ] é¢†åŸŸæœåŠ¡å®ç°å®Œæˆ
- [ ] ä»“å‚¨æ¨¡å¼å®ç°å®Œæˆ

### ç”¨æˆ·ä¸­å°
- [ ] ç”¨æˆ·æ³¨å†Œç™»å½•å®ç°
- [ ] æƒé™ç®¡ç†å®ç°
- [ ] ç”¨æˆ·ç”»åƒå®ç°
- [ ] ä¼šå‘˜ä½“ç³»å®ç°
- [ ] APIæ¥å£å®ç°

### è®¢å•ä¸­å°
- [ ] è®¢å•åˆ›å»ºæµç¨‹å®ç°
- [ ] è®¢å•çŠ¶æ€ç®¡ç†å®ç°
- [ ] è®¢å•æŸ¥è¯¢å®ç°
- [ ] è®¢å•ç»Ÿè®¡å®ç°
- [ ] APIæ¥å£å®ç°

### æ”¯ä»˜ä¸­å°
- [ ] æ”¯ä»˜æµç¨‹å®ç°
- [ ] æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] é€€æ¬¾å¤„ç†å®ç°
- [ ] å¯¹è´¦åŠŸèƒ½å®ç°
- [ ] APIæ¥å£å®ç°

### å•†å“ä¸­å°
- [ ] å•†å“ç®¡ç†å®ç°
- [ ] ç±»ç›®ç®¡ç†å®ç°
- [ ] ä»·æ ¼ç®¡ç†å®ç°
- [ ] åº“å­˜ç®¡ç†å®ç°
- [ ] APIæ¥å£å®ç°

### æœç´¢ä¸­å°
- [ ] æœç´¢å¼•æ“æ­å»º
- [ ] ç´¢å¼•ç®¡ç†å®ç°
- [ ] æœç´¢åŠŸèƒ½å®ç°
- [ ] æ™ºèƒ½æ¨èå®ç°
- [ ] APIæ¥å£å®ç°

### è¥é”€ä¸­å°
- [ ] ä¼˜æƒ åˆ¸ç®¡ç†å®ç°
- [ ] ä¿ƒé”€æ´»åŠ¨å®ç°
- [ ] ä¼šå‘˜æƒç›Šå®ç°
- [ ] åˆ†é”€ä½“ç³»å®ç°
- [ ] APIæ¥å£å®ç°

### é€šçŸ¥ä¸­å°
- [ ] çŸ­ä¿¡é€šçŸ¥å®ç°
- [ ] é‚®ä»¶é€šçŸ¥å®ç°
- [ ] æ¨é€é€šçŸ¥å®ç°
- [ ] ç«™å†…æ¶ˆæ¯å®ç°
- [ ] APIæ¥å£å®ç°

### æƒé™ä¸­å°
- [ ] è§’è‰²ç®¡ç†å®ç°
- [ ] æƒé™åˆ†é…å®ç°
- [ ] æƒé™æ ¡éªŒå®ç°
- [ ] å®‰å…¨å®¡è®¡å®ç°
- [ ] APIæ¥å£å®ç°

### ç›‘æ§ä¸ç»Ÿè®¡
- [ ] ä¸šåŠ¡æŒ‡æ ‡é‡‡é›†
- [ ] å®æ—¶æ•°æ®ç»Ÿè®¡
- [ ] æŠ¥è¡¨ç”Ÿæˆ
- [ ] å‘Šè­¦é…ç½®
- [ ] Dashboardå±•ç¤º

---

**ç¼–åˆ¶ï¼š** æµ®æµ®é…± ğŸ±ï¼ˆçŒ«å¨˜å·¥ç¨‹å¸ˆï¼‰
**æ—¥æœŸï¼š** 2025-11-15
**çŠ¶æ€ï¼š** ğŸ“‹ æŒ‡å—å®Œæˆï¼Œå‡†å¤‡å®æ–½

**åŠ æ²¹å–µï½ ä¸šåŠ¡ä¸­å°å»ºè®¾å³å°†å®Œæˆï¼** à¸…'Ï‰'à¸…
