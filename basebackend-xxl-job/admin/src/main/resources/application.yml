# =====================================================================
# XXL-Job 分布式任务调度中心配置
# 创建时间: 2025-11-15
# 描述: XXL-Job Admin 调度中心配置
# =====================================================================

server:
  port: 8080
  servlet:
    context-path: /xxl-job-admin
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml
    min-response-size: 1024

spring:
  application:
    name: xxl-job-admin
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  #.freemarker 配置
  freemarker:
    template-loader-path: classpath:/templates/
    charset: UTF-8
    cache: false
    suffix: .ftl
    settings:
      template_update_delay: 0

  # Jackson 配置
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8

  # AOP 配置
  aop:
    auto: true
    proxy-target-class: true

  # 邮件配置
  mail:
    from: xxl.job@admin.com
    host: ${MAIL_HOST:smtp.qq.com}
    port: ${MAIL_PORT:587}
    username: ${MAIL_USERNAME:admin@admin.com}
    password: ${MAIL_PASSWORD:admin123}
    properties:
      mail.smtp.auth: true
      mail.smtp.starttls.enable: true
      mail.smtp.starttls.required: true

  # 任务调度中心数据库配置
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:xxl_job}?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:root}
    druid:
      initial-size: 10
      min-idle: 10
      max-active: 20
      max-wait: 60000
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false
      pool-prepared-statements: true
      max-pool-prepared-statement-per-connection-size: 20
      filters: stat,wall,log4j
      connection-properties: druid.stat.mergeSql\\=true;druid.stat.slowSqlMillis\\=5000
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        login-username: admin
        login-password: admin123
      web-stat-filter:
        enabled: true
        url-pattern: /*
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"

# XXL-Job 配置
xxl:
  job:
    # 国际化
    i18n: ${XXL_JOB_I18N:zh_CN}

    # 调度中心配置
    admin:
      addresses: ${XXL_JOB_ADMIN_ADDRESSES:http://localhost:8080/xxl-job-admin}
      # 认证令牌
      access-token: ${XXL_JOB_ADMIN_ACCESS_TOKEN:}

    # 执行器配置
    executor:
      appname: ${XXL_JOB_EXECUTOR_APP_NAME:basebackend-executor}
      port: ${XXL_JOB_EXECUTOR_PORT:9999}
      # 执行器 IP
      ip: ${XXL_JOB_EXECUTOR_IP:}
      # 执行器端口
      port: ${XXL_JOB_EXECUTOR_PORT:9999}
      # 执行器注册中心
      register:
        registry:
          key: ${XXL_JOB_EXECUTOR_REGISTRY_KEY:basebackend-executor}
          value: ${XXL_JOB_EXECUTOR_REGISTRY_VALUE:basebackend-executor}
      # 日志文件保存天数
      log:
        retention-days: ${XXL_JOB_EXECUTOR_LOG_RETENTION_DAYS:30}

    # 日志配置
    log:
      # 日志级别
      level: ${XXL_JOB_LOG_LEVEL:INFO}
      # 清洗 SQL 记录
      retention-days: ${XXL_JOB_LOG_RETENTION_DAYS:30}

# 日志配置
logging:
  level:
    com.xxl.job.admin: ${LOG_LEVEL:DEBUG}
    org.springframework: ${LOG_LEVEL_SPRING:INFO}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
  file:
    name: /opt/basebackend/logs/xxl-job-admin.log
    max-size: 100MB
    max-history: 30

# Actuator 配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    tags:
      application: ${spring.application.name}
