-- 创建漏洞表
CREATE TABLE security_vulnerability (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '漏洞ID',
    project_name VARCHAR(255) NOT NULL COMMENT '项目名称',
    name VARCHAR(500) NOT NULL COMMENT '漏洞名称',
    description TEXT COMMENT '漏洞描述',
    type VARCHAR(100) NOT NULL COMMENT '漏洞类型',
    severity ENUM('CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO') NOT NULL COMMENT '严重程度',
    cve_id VARCHAR(50) COMMENT 'CVE编号',
    cwe_id VARCHAR(50) COMMENT 'CWE编号',
    cvss_score DECIMAL(3,1) COMMENT 'CVSS评分',
    cvss_vector VARCHAR(200) COMMENT 'CVSS向量',
    affected_component VARCHAR(255) COMMENT '影响组件',
    affected_version VARCHAR(100) COMMENT '影响版本',
    fixed_version VARCHAR(100) COMMENT '修复版本',
    reference_url VARCHAR(500) COMMENT '参考链接',
    remediation TEXT COMMENT '修复建议',
    status ENUM('PENDING', 'CONFIRMED', 'FALSE_POSITIVE', 'FIXED', 'ACCEPTED_RISK', 'MITIGATED', 'IN_PROGRESS') DEFAULT 'PENDING' COMMENT '漏洞状态',
    source ENUM('STATIC_ANALYSIS', 'DYNAMIC_TESTING', 'DEPENDENCY_CHECK', 'CONFIG_AUDIT', 'MANUAL_TEST', 'THIRD_PARTY_TOOL', 'SECURITY_RESEARCHER') COMMENT '扫描来源',
    discovered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '发现时间',
    fixed_at TIMESTAMP NULL COMMENT '修复时间',
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_project_name (project_name),
    INDEX idx_severity (severity),
    INDEX idx_status (status),
    INDEX idx_type (type),
    INDEX idx_discovered_at (discovered_at),
    INDEX idx_cvss_score (cvss_score)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='安全漏洞表';

-- 创建漏洞位置表
CREATE TABLE security_vulnerability_location (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '位置ID',
    vulnerability_id BIGINT NOT NULL COMMENT '漏洞ID',
    file_path VARCHAR(1000) NOT NULL COMMENT '文件路径',
    line_number INT COMMENT '行号',
    column_number INT COMMENT '列号',
    method_name VARCHAR(200) COMMENT '方法名',
    class_name VARCHAR(200) COMMENT '类名',
    package_name VARCHAR(200) COMMENT '包名',
    code_snippet TEXT COMMENT '代码片段',
    description VARCHAR(1000) COMMENT '描述信息',
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (vulnerability_id) REFERENCES security_vulnerability(id) ON DELETE CASCADE,
    INDEX idx_vulnerability_id (vulnerability_id),
    INDEX idx_file_path (file_path)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='漏洞位置表';

-- 创建扫描任务表
CREATE TABLE security_scan_task (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '任务ID',
    project_name VARCHAR(255) NOT NULL COMMENT '项目名称',
    project_path VARCHAR(500) COMMENT '项目路径',
    scan_types SET('STATIC_ANALYSIS', 'DYNAMIC_TESTING', 'DEPENDENCY_CHECK', 'CONFIG_AUDIT') NOT NULL COMMENT '扫描类型',
    status ENUM('PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED') DEFAULT 'PENDING' COMMENT '任务状态',
    start_time TIMESTAMP NULL COMMENT '开始时间',
    end_time TIMESTAMP NULL COMMENT '结束时间',
    total_vulnerabilities BIGINT DEFAULT 0 COMMENT '总漏洞数',
    critical_count BIGINT DEFAULT 0 COMMENT '严重漏洞数',
    high_count BIGINT DEFAULT 0 COMMENT '高危漏洞数',
    medium_count BIGINT DEFAULT 0 COMMENT '中危漏洞数',
    low_count BIGINT DEFAULT 0 COMMENT '低危漏洞数',
    info_count BIGINT DEFAULT 0 COMMENT '信息漏洞数',
    error_message TEXT COMMENT '错误信息',
    scan_by VARCHAR(100) COMMENT '扫描执行人',
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_project_name (project_name),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time),
    INDEX idx_scan_by (scan_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='扫描任务表';

-- 创建扫描任务关联的漏洞表
CREATE TABLE security_scan_task_vulnerability (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '关联ID',
    task_id BIGINT NOT NULL COMMENT '任务ID',
    vulnerability_id BIGINT NOT NULL COMMENT '漏洞ID',
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (task_id) REFERENCES security_scan_task(id) ON DELETE CASCADE,
    FOREIGN KEY (vulnerability_id) REFERENCES security_vulnerability(id) ON DELETE CASCADE,
    UNIQUE KEY uk_task_vuln (task_id, vulnerability_id),
    INDEX idx_task_id (task_id),
    INDEX idx_vulnerability_id (vulnerability_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='扫描任务漏洞关联表';

-- 插入示例数据
INSERT INTO security_vulnerability (
    project_name, name, description, type, severity, cve_id, cvss_score,
    affected_component, affected_version, remediation, status, source, discovered_at
) VALUES (
    'basebackend-admin-api',
    'SQL注入漏洞',
    '在用户查询接口中发现潜在的SQL注入风险，攻击者可能通过构造恶意SQL语句获取敏感数据',
    'SQL_INJECTION',
    'HIGH',
    'CVE-2024-12345',
    7.5,
    'UserMapper.xml',
    '1.0.0',
    '使用预编译语句，避免动态SQL拼接，增加输入验证',
    'PENDING',
    'STATIC_ANALYSIS',
    NOW()
);

INSERT INTO security_vulnerability (
    project_name, name, description, type, severity, cve_id, cvss_score,
    affected_component, affected_version, remediation, status, source, discovered_at
) VALUES (
    'basebackend-gateway',
    'XSS跨站脚本漏洞',
    '在用户评论显示功能中未对用户输入进行HTML转义，可能导致XSS攻击',
    'XSS',
    'MEDIUM',
    NULL,
    5.0,
    'CommentController',
    '2.1.0',
    '对所有用户输出进行HTML编码，使用CSP策略',
    'CONFIRMED',
    'DYNAMIC_TESTING',
    NOW()
);

-- 创建视图：漏洞统计视图
CREATE VIEW v_vulnerability_statistics AS
SELECT
    project_name,
    COUNT(*) as total_vulnerabilities,
    SUM(CASE WHEN severity = 'CRITICAL' THEN 1 ELSE 0 END) as critical_count,
    SUM(CASE WHEN severity = 'HIGH' THEN 1 ELSE 0 END) as high_count,
    SUM(CASE WHEN severity = 'MEDIUM' THEN 1 ELSE 0 END) as medium_count,
    SUM(CASE WHEN severity = 'LOW' THEN 1 ELSE 0 END) as low_count,
    SUM(CASE WHEN severity = 'INFO' THEN 1 ELSE 0 END) as info_count,
    SUM(CASE WHEN status NOT IN ('FIXED', 'ACCEPTED_RISK', 'FALSE_POSITIVE') THEN 1 ELSE 0 END) as open_count,
    MAX(discovered_at) as last_discovered_at
FROM security_vulnerability
GROUP BY project_name;
