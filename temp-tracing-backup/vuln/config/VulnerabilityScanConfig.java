package com.basebackend.security.vuln.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * 漏洞扫描配置
 */
@Data
@Component
@ConfigurationProperties(prefix = "security.vulnerability-scan")
public class VulnerabilityScanConfig {

    /**
     * 是否启用漏洞扫描
     */
    private boolean enabled = true;

    /**
     * 静态代码分析配置
     */
    private StaticAnalysisConfig staticAnalysis = new StaticAnalysisConfig();

    /**
     * 依赖检查配置
     */
    private DependencyCheckConfig dependencyCheck = new DependencyCheckConfig();

    /**
     * 配置审计配置
     */
    private ConfigAuditConfig configAudit = new ConfigAuditConfig();

    /**
     * 动态测试配置
     */
    private DynamicTestingConfig dynamicTesting = new DynamicTestingConfig();

    /**
     * 并行扫描配置
     */
    private ParallelConfig parallel = new ParallelConfig();

    /**
     * 报告配置
     */
    private ReportConfig report = new ReportConfig();

    /**
     * 告警配置
     */
    private AlertConfig alert = new AlertConfig();

    /**
     * 静态代码分析配置
     */
    @Data
    public static class StaticAnalysisConfig {
        /**
         * 是否启用
         */
        private boolean enabled = true;

        /**
         * 扫描目录
         */
        private String scanPath = "src/main/java";

        /**
         * 排除目录
         */
        private String excludePath = "**/test/**,**/generated/**";

        /**
         * 检测规则
         */
        private String[] rules = {
                "SQL_INJECTION",
                "XSS",
                "CSRF",
                "COMMAND_INJECTION",
                "PATH_TRAVERSAL",
                "INSECURE_DESERIALIZATION"
        };

        /**
         * 是否包含测试代码
         */
        private boolean includeTestCode = false;

        /**
         * 最大扫描文件大小 (MB)
         */
        private int maxFileSize = 10;
    }

    /**
     * 依赖检查配置
     */
    @Data
    public static class DependencyCheckConfig {
        /**
         * 是否启用
         */
        private boolean enabled = true;

        /**
         * 是否自动更新漏洞数据库
         */
        private boolean autoUpdate = true;

        /**
         * 更新间隔 (小时)
         */
        private int updateInterval = 24;

        /**
         * Maven仓库地址
         */
        private String mavenRepoUrl = "https://repo1.maven.org/maven2/";

        /**
         * NPM仓库地址
         */
        private String npmRepoUrl = "https://registry.npmjs.org/";

        /**
         * 是否检查已弃用组件
         */
        private boolean checkDeprecated = true;

        /**
         * CVSS最低分数阈值
         */
        private double minCvssScore = 0.0;
    }

    /**
     * 配置审计配置
     */
    @Data
    public static class ConfigAuditConfig {
        /**
         * 是否启用
         */
        private boolean enabled = true;

        /**
         * 检查项
         */
        private String[] checks = {
                "SECURITY_CONFIG",
                "DATABASE_CONFIG",
                "SSL_CONFIG",
                "CORS_CONFIG"
        };

        /**
         * 配置文件路径
         */
        private String[] configPaths = {
                "application.yml",
                "application.properties",
                "application-security.yml"
        };

        /**
         * 是否检查生产配置
         */
        private boolean checkProductionConfig = true;
    }

    /**
     * 动态测试配置
     */
    @Data
    public static class DynamicTestingConfig {
        /**
         * 是否启用
         */
        private boolean enabled = false; // 默认关闭，需要手动启用

        /**
         * 目标URL
         */
        private String targetUrl = "http://localhost:8080";

        /**
         * 认证信息
         */
        private String authToken;

        /**
         * 测试用户
         */
        private String testUser;

        /**
         * 测试密码
         */
        private String testPassword;

        /**
         * 是否包含身份验证测试
         */
        private boolean includeAuthTest = false;

        /**
         * 超时时间 (毫秒)
         */
        private int timeout = 30000;

        /**
         * 并发数
         */
        private int concurrency = 1;

        /**
         * 是否生成PoC
         */
        private boolean generatePoc = false;
    }

    /**
     * 并行扫描配置
     */
    @Data
    public static class ParallelConfig {
        /**
         * 是否启用并行扫描
         */
        private boolean enabled = true;

        /**
         * 并行任务数
         */
        private int threadPoolSize = 5;

        /**
         * 任务超时时间 (分钟)
         */
        private int taskTimeout = 30;
    }

    /**
     * 报告配置
     */
    @Data
    public static class ReportConfig {
        /**
         * 是否启用报告生成
         */
        private boolean enabled = true;

        /**
         * 报告格式
         */
        private String[] formats = {"HTML", "PDF", "JSON", "CSV"};

        /**
         * 报告输出路径
         */
        private String outputPath = "reports/vulnerability/";

        /**
         * 是否包含修复建议
         */
        private boolean includeRemediation = true;

        /**
         * 是否包含代码片段
         */
        private boolean includeCodeSnippet = true;

        /**
         * 报告模板
         */
        private String template = "default";
    }

    /**
     * 告警配置
     */
    @Data
    public static class AlertConfig {
        /**
         * 是否启用告警
         */
        private boolean enabled = true;

        /**
         * 高危漏洞阈值
         */
        private int highSeverityThreshold = 0;

        /**
         * 严重漏洞阈值
         */
        private int criticalSeverityThreshold = 0;

        /**
         * 告警渠道
         */
        private String[] channels = {"LOG", "EMAIL"};

        /**
         * 邮件配置
         */
        private EmailConfig email = new EmailConfig();

        /**
         * 钉钉配置
         */
        private DingTalkConfig dingTalk = new DingTalkConfig();

        /**
         * 邮件配置
         */
        @Data
        public static class EmailConfig {
            private boolean enabled = false;
            private String smtpHost;
            private int smtpPort = 587;
            private String username;
            private String password;
            private String[] recipients;
            private String from;
        }

        /**
         * 钉钉配置
         */
        @Data
        public static class DingTalkConfig {
            private boolean enabled = false;
            private String webhookUrl;
            private String secret;
        }
    }
}
