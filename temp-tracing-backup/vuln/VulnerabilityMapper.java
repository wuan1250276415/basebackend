package com.basebackend.security.vuln;

import org.apache.ibatis.annotations.*;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;

/**
 * 漏洞数据访问层
 */
@Repository
@Mapper
public interface VulnerabilityMapper {

    /**
     * 保存漏洞
     */
    @Insert("INSERT INTO security_vulnerability (" +
            "    name, description, type, severity, cve_id, cwe_id, cvss_score, cvss_vector," +
            "    affected_component, affected_version, fixed_version, reference_url," +
            "    remediation, status, source, discovered_at, created_time, updated_time" +
            ") VALUES (" +
            "    #{name}, #{description}, #{type}, #{severity}, #{cveId}, #{cweId}, #{cvssScore}, #{cvssVector}," +
            "    #{affectedComponent}, #{affectedVersion}, #{fixedVersion}, #{referenceUrl}," +
            "    #{remediation}, #{status}, #{source}, #{discoveredAt}, NOW(), NOW()" +
            ")")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    void insert(Vulnerability vulnerability);

    /**
     * 更新漏洞
     */
    @Update("UPDATE security_vulnerability SET " +
            "    name = #{name}, description = #{description}, type = #{type}, severity = #{severity}," +
            "    cve_id = #{cveId}, cwe_id = #{cweId}, cvss_score = #{cvssScore}, cvss_vector = #{cvssVector}," +
            "    affected_component = #{affectedComponent}, affected_version = #{affectedVersion}," +
            "    fixed_version = #{fixedVersion}, reference_url = #{referenceUrl}, remediation = #{remediation}," +
            "    status = #{status}, source = #{source}, fixed_at = #{fixedAt}, updated_time = NOW() " +
            "WHERE id = #{id}")
    void update(Vulnerability vulnerability);

    /**
     * 根据ID查询漏洞
     */
    @Select("SELECT * FROM security_vulnerability WHERE id = #{id}")
    @Results(id = "vulnerabilityResultMap", value = {
        @Result(property = "id", column = "id"),
        @Result(property = "name", column = "name"),
        @Result(property = "description", column = "description"),
        @Result(property = "type", column = "type", javaType = Vulnerability.VulnerabilityType.class),
        @Result(property = "severity", column = "severity", javaType = Vulnerability.Severity.class),
        @Result(property = "cveId", column = "cve_id"),
        @Result(property = "cweId", column = "cwe_id"),
        @Result(property = "cvssScore", column = "cvss_score"),
        @Result(property = "cvssVector", column = "cvss_vector"),
        @Result(property = "affectedComponent", column = "affected_component"),
        @Result(property = "affectedVersion", column = "affected_version"),
        @Result(property = "fixedVersion", column = "fixed_version"),
        @Result(property = "referenceUrl", column = "reference_url"),
        @Result(property = "remediation", column = "remediation"),
        @Result(property = "status", column = "status", javaType = Vulnerability.Status.class),
        @Result(property = "discoveredAt", column = "discovered_at"),
        @Result(property = "fixedAt", column = "fixed_at"),
        @Result(property = "source", column = "source", javaType = Vulnerability.ScanSource.class)
    })
    Vulnerability selectById(Long id);

    /**
     * 查询漏洞列表
     */
    @Select("<script>" +
            "SELECT * FROM security_vulnerability WHERE 1=1 " +
            "<if test='projectName != null and projectName != \"\"'>" +
            "    AND project_name = #{projectName} " +
            "</if>" +
            "<if test='severity != null'>" +
            "    AND severity = #{severity} " +
            "</if>" +
            "<if test='status != null'>" +
            "    AND status = #{status} " +
            "</if>" +
            "<if test='type != null'>" +
            "    AND type = #{type} " +
            "</if>" +
            "ORDER BY discovered_at DESC " +
            "<if test='limit != null'>" +
            "LIMIT #{limit} " +
            "</if>" +
            "</script>")
    @ResultMap("vulnerabilityResultMap")
    List<Vulnerability> selectList(
            @Param("projectName") String projectName,
            @Param("severity") Vulnerability.Severity severity,
            @Param("status") Vulnerability.Status status,
            @Param("type") Vulnerability.VulnerabilityType type,
            @Param("limit") Integer limit
    );

    /**
     * 统计漏洞数量
     */
    @Select("<script>" +
            "SELECT " +
            "    COUNT(*) as total," +
            "    SUM(CASE WHEN severity = 'CRITICAL' THEN 1 ELSE 0 END) as critical," +
            "    SUM(CASE WHEN severity = 'HIGH' THEN 1 ELSE 0 END) as high," +
            "    SUM(CASE WHEN severity = 'MEDIUM' THEN 1 ELSE 0 END) as medium," +
            "    SUM(CASE WHEN severity = 'LOW' THEN 1 ELSE 0 END) as low," +
            "    SUM(CASE WHEN severity = 'INFO' THEN 1 ELSE 0 END) as info " +
            "FROM security_vulnerability " +
            "WHERE 1=1 " +
            "<if test='projectName != null and projectName != \"\"'>" +
            "    AND project_name = #{projectName} " +
            "</if>" +
            "</script>")
    Map<String, Object> selectStatistics(@Param("projectName") String projectName);

    /**
     * 更新漏洞状态
     */
    @Update("UPDATE security_vulnerability SET " +
            "    status = #{status}, updated_time = NOW() " +
            "WHERE id = #{id}")
    void updateStatus(@Param("id") Long id, @Param("status") Vulnerability.Status status);

    /**
     * 删除漏洞
     */
    @Delete("DELETE FROM security_vulnerability WHERE id = #{id}")
    void deleteById(Long id);

    /**
     * 批量保存漏洞
     */
    void batchInsert(@Param("vulnerabilities") List<Vulnerability> vulnerabilities);

    /**
     * 查询最近发现的漏洞
     */
    @Select("SELECT * FROM security_vulnerability " +
            "WHERE discovered_at >= #{startTime} " +
            "ORDER BY discovered_at DESC " +
            "LIMIT #{limit}")
    @ResultMap("vulnerabilityResultMap")
    List<Vulnerability> selectRecentVulnerabilities(
            @Param("startTime") LocalDateTime startTime,
            @Param("limit") Integer limit
    );

    /**
     * 查询未修复的高危漏洞
     */
    @Select("SELECT * FROM security_vulnerability " +
            "WHERE severity IN ('CRITICAL', 'HIGH') " +
            "AND status NOT IN ('FIXED', 'ACCEPTED_RISK', 'FALSE_POSITIVE') " +
            "ORDER BY cvss_score DESC, discovered_at DESC")
    @ResultMap("vulnerabilityResultMap")
    List<Vulnerability> selectUnfixedHighSeverity();
}
