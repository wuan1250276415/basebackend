package com.basebackend.security.vuln;

import lombok.Data;
import lombok.EqualsAndHashCode;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Set;

/**
 * 漏洞实体类
 */
@Data
@EqualsAndHashCode(callSuper = true)
public class Vulnerability extends BaseEntity {

    /**
     * 漏洞ID
     */
    private Long id;

    /**
     * 漏洞名称
     */
    private String name;

    /**
     * 漏洞描述
     */
    private String description;

    /**
     * 漏洞类型
     */
    private VulnerabilityType type;

    /**
     * 严重程度
     */
    private Severity severity;

    /**
     * CVE编号 (如果适用)
     */
    private String cveId;

    /**
     * CWE编号 (如果适用)
     */
    private String cweId;

    /**
     * CVSS评分
     */
    private Double cvssScore;

    /**
     * CVSS向量
     */
    private String cvssVector;

    /**
     * 影响组件
     */
    private String affectedComponent;

    /**
     * 影响版本
     */
    private String affectedVersion;

    /**
     * 修复版本
     */
    private String fixedVersion;

    /**
     * 漏洞URL
     */
    private String referenceUrl;

    /**
     * 修复建议
     */
    private String remediation;

    /**
     * 漏洞状态
     */
    private Status status;

    /**
     * 发现时间
     */
    private LocalDateTime discoveredAt;

    /**
     * 修复时间
     */
    private LocalDateTime fixedAt;

    /**
     * 扫描来源
     */
    private ScanSource source;

    /**
     * 漏洞位置
     */
    private List<VulnerabilityLocation> locations;

    /**
     * 漏洞标签
     */
    private Set<String> tags;

    /**
     * 漏洞类型枚举
     */
    public enum VulnerabilityType {
        /**
         * SQL注入
         */
        SQL_INJECTION,
        /**
         * XSS跨站脚本
         */
        XSS,
        /**
         * CSRF跨站请求伪造
         */
        CSRF,
        /**
         * 权限提升
         */
        PRIVILEGE_ESCALATION,
        /**
         * 敏感信息泄露
         */
        SENSITIVE_DATA_EXPOSURE,
        /**
         * 不安全的反序列化
         */
        INSECURE_DESERIALIZATION,
        /**
         * 安全配置错误
         */
        SECURITY_MISCONFIGURATION,
        /**
         * 组件漏洞
         */
        VULNERABLE_COMPONENT,
        /**
         * 身份验证缺陷
         */
        AUTHENTICATION_FLAW,
        /**
         * 访问控制缺陷
         */
        ACCESS_CONTROL_FLAW,
        /**
         * 输入验证缺陷
         */
        INPUT_VALIDATION_FLAW,
        /**
         * 文件上传漏洞
         */
        UNRESTRICTED_FILE_UPLOAD,
        /**
         * 开放重定向
         */
        OPEN_REDIRECT,
        /**
         * 命令注入
         */
        COMMAND_INJECTION,
        /**
         * 路径遍历
         */
        PATH_TRAVERSAL,
        /**
         * HTTP响应头注入
         */
        HTTP_RESPONSE_SPLITTING,
        /**
         * 点击劫持
         */
        CLICKJACKING,
        /**
         * 会话管理缺陷
         */
        SESSION_MANAGEMENT_FLAW,
        /**
         * 其他
         */
        OTHER
    }

    /**
     * 严重程度枚举
     */
    public enum Severity {
        /**
         * 严重 (9.0-10.0)
         */
        CRITICAL(9.0, 10.0),
        /**
         * 高危 (7.0-8.9)
         */
        HIGH(7.0, 8.9),
        /**
         * 中危 (4.0-6.9)
         */
        MEDIUM(4.0, 6.9),
        /**
         * 低危 (0.1-3.9)
         */
        LOW(0.1, 3.9),
        /**
         * 信息 (0.0)
         */
        INFO(0.0, 0.0);

        private final double minScore;
        private final double maxScore;

        Severity(double minScore, double maxScore) {
            this.minScore = minScore;
            this.maxScore = maxScore;
        }

        public double getMinScore() {
            return minScore;
        }

        public double getMaxScore() {
            return maxScore;
        }
    }

    /**
     * 漏洞状态枚举
     */
    public enum Status {
        /**
         * 待确认
         */
        PENDING,
        /**
         * 已确认
         */
        CONFIRMED,
        /**
         * 误报
         */
        FALSE_POSITIVE,
        /**
         * 已修复
         */
        FIXED,
        /**
         * 接受风险
         */
        ACCEPTED_RISK,
        /**
         * 风险缓解
         */
        MITIGATED,
        /**
         * 修复中
         */
        IN_PROGRESS
    }

    /**
     * 扫描来源枚举
     */
    public enum ScanSource {
        /**
         * 静态代码扫描
         */
        STATIC_ANALYSIS,
        /**
         * 动态渗透测试
         */
        DYNAMIC_TESTING,
        /**
         * 依赖组件扫描
         */
        DEPENDENCY_CHECK,
        /**
         * 配置审计
         */
        CONFIG_AUDIT,
        /**
         * 手动测试
         */
        MANUAL_TEST,
        /**
         * 第三方工具
         */
        THIRD_PARTY_TOOL,
        /**
         * 安全研究人员报告
         */
        SECURITY_RESEARCHER
    }

    /**
     * 漏洞位置信息
     */
    @Data
    class VulnerabilityLocation {
        /**
         * 文件路径
         */
        private String filePath;

        /**
         * 行号
         */
        private Integer lineNumber;

        /**
         * 列号
         */
        private Integer columnNumber;

        /**
         * 方法名
         */
        private String methodName;

        /**
         * 类名
         */
        private String className;

        /**
         * 包名
         */
        private String packageName;

        /**
         * 代码片段
         */
        private String codeSnippet;

        /**
         * 描述信息
         */
        private String description;
    }

    /**
     * 获取严重程度描述
     */
    public String getSeverityDescription() {
        switch (severity) {
            case CRITICAL:
                return "严重 - 需要立即修复";
            case HIGH:
                return "高危 - 需要优先修复";
            case MEDIUM:
                return "中危 - 需要在适当时间修复";
            case LOW:
                return "低危 - 建议修复";
            case INFO:
                return "信息 - 参考信息";
            default:
                return "未知";
        }
    }

    /**
     * 获取状态描述
     */
    public String getStatusDescription() {
        switch (status) {
            case PENDING:
                return "待确认";
            case CONFIRMED:
                return "已确认";
            case FALSE_POSITIVE:
                return "误报";
            case FIXED:
                return "已修复";
            case ACCEPTED_RISK:
                return "接受风险";
            case MITIGATED:
                return "风险缓解";
            case IN_PROGRESS:
                return "修复中";
            default:
                return "未知";
        }
    }

    /**
     * 检查是否为高危漏洞
     */
    public boolean isHighSeverity() {
        return severity == Severity.CRITICAL || severity == Severity.HIGH;
    }

    /**
     * 检查是否需要立即处理
     */
    public boolean requiresImmediateAttention() {
        return isHighSeverity() && (status == Status.PENDING || status == Status.CONFIRMED);
    }

    /**
     * 获取修复优先级 (数字越小优先级越高)
     */
    public int getFixPriority() {
        switch (severity) {
            case CRITICAL:
                return 1;
            case HIGH:
                return 2;
            case MEDIUM:
                return 3;
            case LOW:
                return 4;
            case INFO:
                return 5;
            default:
                return 99;
        }
    }
}
