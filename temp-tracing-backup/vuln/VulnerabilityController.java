package com.basebackend.security.vuln;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

/**
 * 漏洞管理控制器
 */
@Slf4j
@RestController
@RequestMapping("/api/vulnerabilities")
@RequiredArgsConstructor
public class VulnerabilityController {

    private final VulnerabilityScanService scanService;
    private final VulnerabilityMapper vulnerabilityMapper;

    /**
     * 执行漏洞扫描
     */
    @PostMapping("/scan")
    public ResponseEntity<ScanResult> performScan(@RequestBody ScanRequest request) {
        log.info("接收漏洞扫描请求: {}", request.getProjectName());
        ScanResult result = scanService.performFullScan(request);
        return ResponseEntity.ok(result);
    }

    /**
     * 获取漏洞列表
     */
    @GetMapping
    public ResponseEntity<List<Vulnerability>> getVulnerabilities(
            @RequestParam(required = false) String projectName,
            @RequestParam(required = false) Vulnerability.Severity severity,
            @RequestParam(required = false) Vulnerability.Status status,
            @RequestParam(required = false) Vulnerability.VulnerabilityType type,
            @RequestParam(defaultValue = "100") Integer limit
    ) {
        List<Vulnerability> vulnerabilities = vulnerabilityMapper.selectList(
                projectName, severity, status, type, limit
        );
        return ResponseEntity.ok(vulnerabilities);
    }

    /**
     * 获取漏洞详情
     */
    @GetMapping("/{id}")
    public ResponseEntity<Vulnerability> getVulnerability(@PathVariable Long id) {
        Vulnerability vulnerability = vulnerabilityMapper.selectById(id);
        if (vulnerability == null) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(vulnerability);
    }

    /**
     * 获取漏洞统计信息
     */
    @GetMapping("/statistics")
    public ResponseEntity<Map<String, Object>> getStatistics(
            @RequestParam(required = false) String projectName
    ) {
        Map<String, Object> statistics = vulnerabilityMapper.selectStatistics(projectName);
        return ResponseEntity.ok(statistics);
    }

    /**
     * 获取未修复的高危漏洞
     */
    @GetMapping("/unfixed-high-severity")
    public ResponseEntity<List<Vulnerability>> getUnfixedHighSeverityVulnerabilities() {
        List<Vulnerability> vulnerabilities = vulnerabilityMapper.selectUnfixedHighSeverity();
        return ResponseEntity.ok(vulnerabilities);
    }

    /**
     * 更新漏洞状态
     */
    @PutMapping("/{id}/status")
    public ResponseEntity<Void> updateVulnerabilityStatus(
            @PathVariable Long id,
            @RequestParam Vulnerability.Status status,
            @RequestParam(required = false) String comment
    ) {
        vulnerabilityMapper.updateStatus(id, status);
        log.info("更新漏洞状态: id={}, status={}", id, status);
        return ResponseEntity.ok().build();
    }

    /**
     * 删除漏洞
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteVulnerability(@PathVariable Long id) {
        vulnerabilityMapper.deleteById(id);
        log.info("删除漏洞: id={}", id);
        return ResponseEntity.ok().build();
    }

    /**
     * 生成漏洞报告
     */
    @GetMapping("/{id}/report")
    public ResponseEntity<String> generateReport(@PathVariable Long id) {
        Vulnerability vulnerability = vulnerabilityMapper.selectById(id);
        if (vulnerability == null) {
            return ResponseEntity.notFound().build();
        }

        String report = generateVulnerabilityReport(vulnerability);
        return ResponseEntity.ok(report);
    }

    /**
     * 获取扫描结果
     */
    @GetMapping("/scans/{scanId}")
    public ResponseEntity<ScanResult> getScanResult(@PathVariable Long scanId) {
        ScanResult result = scanService.getScanResult(scanId);
        if (result == null) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(result);
    }

    /**
     * 生成漏洞Markdown报告
     */
    private String generateVulnerabilityReport(Vulnerability vulnerability) {
        StringBuilder report = new StringBuilder();

        report.append("# 漏洞详情报告\n\n");
        report.append("## 基本信息\n\n");
        report.append("- **漏洞ID**: ").append(vulnerability.getId()).append("\n");
        report.append("- **漏洞名称**: ").append(vulnerability.getName()).append("\n");
        report.append("- **漏洞类型**: ").append(vulnerability.getType()).append("\n");
        report.append("- **严重程度**: ").append(vulnerability.getSeverity()).append("\n");
        report.append("- **CVSS评分**: ").append(vulnerability.getCvssScore()).append("\n\n");

        if (vulnerability.getCveId() != null) {
            report.append("- **CVE编号**: ").append(vulnerability.getCveId()).append("\n");
        }
        if (vulnerability.getCweId() != null) {
            report.append("- **CWE编号**: ").append(vulnerability.getCweId()).append("\n");
        }

        report.append("\n## 漏洞描述\n\n");
        report.append(vulnerability.getDescription()).append("\n\n");

        report.append("## 影响组件\n\n");
        report.append("- **组件**: ").append(vulnerability.getAffectedComponent()).append("\n");
        report.append("- **影响版本**: ").append(vulnerability.getAffectedVersion()).append("\n");
        if (vulnerability.getFixedVersion() != null) {
            report.append("- **修复版本**: ").append(vulnerability.getFixedVersion()).append("\n");
        }
        report.append("\n");

        report.append("## 修复建议\n\n");
        report.append(vulnerability.getRemediation()).append("\n\n");

        if (vulnerability.getReferenceUrl() != null) {
            report.append("## 参考链接\n\n");
            report.append("- ").append(vulnerability.getReferenceUrl()).append("\n\n");
        }

        report.append("## 状态信息\n\n");
        report.append("- **当前状态**: ").append(vulnerability.getStatus()).append("\n");
        report.append("- **发现时间**: ").append(vulnerability.getDiscoveredAt()).append("\n");
        if (vulnerability.getFixedAt() != null) {
            report.append("- **修复时间**: ").append(vulnerability.getFixedAt()).append("\n");
        }

        return report.toString();
    }
}
